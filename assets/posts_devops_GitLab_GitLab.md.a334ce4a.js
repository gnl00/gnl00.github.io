import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.519d889f.js";const p="/assets/image-20230914152331175.89bb3712.png",o="/assets/image-20230914152345489.6674944b.png",b=JSON.parse('{"title":"GitLab","description":"GitLab 私服搭建","frontmatter":{"description":"GitLab 私服搭建","top":3,"tag":["GitLab"]},"headers":[],"relativePath":"posts/devops/GitLab/GitLab.md","filePath":"posts/devops/GitLab/GitLab.md","lastUpdated":1699262313000}'),e={name:"posts/devops/GitLab/GitLab.md"},t=l(`<h1 id="gitlab" tabindex="-1">GitLab <a class="header-anchor" href="#gitlab" aria-label="Permalink to &quot;GitLab&quot;">​</a></h1><h2 id="gitlab-私服" tabindex="-1">GitLab 私服 <a class="header-anchor" href="#gitlab-私服" aria-label="Permalink to &quot;GitLab 私服&quot;">​</a></h2><h3 id="docker-部署" tabindex="-1">Docker 部署 <a class="header-anchor" href="#docker-部署" aria-label="Permalink to &quot;Docker 部署&quot;">​</a></h3><blockquote><p>使用 Docker 部署 GitLab 私服。</p></blockquote><p>1、<a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noreferrer">Ubuntu 安装 Docker</a></p><p>2、<a href="https://docs.gitlab.com/ee/install/docker.html" target="_blank" rel="noreferrer">Docker 安装 GitLab</a></p><p>3、启动 GitLab</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 将 gitlab 数据映射到外部目录</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> GITLAB_HOME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/srv/gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 也可以写入 .bashrc 或者 .zshrc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--hostname</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">your-hos</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4430</span><span style="color:#9ECBFF;">:443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8000</span><span style="color:#9ECBFF;">:80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2200</span><span style="color:#9ECBFF;">:22</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">always</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--volume</span><span style="color:#E1E4E8;"> $GITLAB_HOME</span><span style="color:#9ECBFF;">/config:/etc/gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--volume</span><span style="color:#E1E4E8;"> $GITLAB_HOME</span><span style="color:#9ECBFF;">/logs:/var/log/gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--volume</span><span style="color:#E1E4E8;"> $GITLAB_HOME</span><span style="color:#9ECBFF;">/data:/var/opt/gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">--shm-size</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">256</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\ </span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">共享内存（SHM），默认为</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">64</span><span style="color:#9ECBFF;">，在使用</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">时建议至少</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">256</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">gitlab/gitlab-ce:latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># docker-gitlab shm size: https://juejin.cn/s/docker%20shm%20size%20gitlab</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 将 gitlab 数据映射到外部目录</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> GITLAB_HOME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/srv/gitlab</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 也可以写入 .bashrc 或者 .zshrc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--hostname</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">your-hos</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4430</span><span style="color:#032F62;">:443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8000</span><span style="color:#032F62;">:80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2200</span><span style="color:#032F62;">:22</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">always</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--volume</span><span style="color:#24292E;"> $GITLAB_HOME</span><span style="color:#032F62;">/config:/etc/gitlab</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--volume</span><span style="color:#24292E;"> $GITLAB_HOME</span><span style="color:#032F62;">/logs:/var/log/gitlab</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--volume</span><span style="color:#24292E;"> $GITLAB_HOME</span><span style="color:#032F62;">/data:/var/opt/gitlab</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">--shm-size</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">256</span><span style="color:#032F62;">m</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\ </span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#032F62;">共享内存（SHM），默认为</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">64</span><span style="color:#032F62;">，在使用</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab</span><span style="color:#24292E;"> </span><span style="color:#032F62;">时建议至少</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">256</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">gitlab/gitlab-ce:latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># docker-gitlab shm size: https://juejin.cn/s/docker%20shm%20size%20gitlab</span></span></code></pre></div><p>获取 <code>root</code> 账号初始密码：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Password:&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/gitlab/initial_root_password</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab</span><span style="color:#24292E;"> </span><span style="color:#032F62;">grep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Password:&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/gitlab/initial_root_password</span></span></code></pre></div><p>接下来就可以使用 <code>&lt;your-host&gt;:&lt;exposeIP&gt;</code> 访问 GitLab。</p><h3 id="k8s-k3s-部署" tabindex="-1">K8s/K3s 部署 <a class="header-anchor" href="#k8s-k3s-部署" aria-label="Permalink to &quot;K8s/K3s 部署&quot;">​</a></h3><p>1、PV/PVC</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">storage.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">StorageClass</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-sc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">provisioner</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/no-provisioner</span></span>
<span class="line"><span style="color:#85E89D;">volumeBindingMode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">WaitForFirstConsumer</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 延迟 PVC 绑定，直到 pod 被调度</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PersistentVolume</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-pv</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">capacity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10Gi</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumeMode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Filesystem</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">accessModes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">ReadWriteMany</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">persistentVolumeReclaimPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Retain</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># PVC 被删除后，PV 的留存策略</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">storageClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-sc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">local</span><span style="color:#E1E4E8;">: </span><span style="color:#6A737D;"># 表示 pv 使用本地存储</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data/gitlab/data</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 使用 local pv 需要定义 nodeAffinity，k8s 需要根据 nodeAffinity 将 Pod 调度到有&gt;对应 local volume 的 node 上</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">required</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">matchExpressions</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubernetes.io/hostname</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">server2</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-pvc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">accessModes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">ReadWriteMany</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">storageClassName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-sc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">storage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">10Gi</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 声明存储的大小</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumeName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-pv</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 绑定 PV</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">storage.k8s.io/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">StorageClass</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-sc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">provisioner</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/no-provisioner</span></span>
<span class="line"><span style="color:#22863A;">volumeBindingMode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">WaitForFirstConsumer</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 延迟 PVC 绑定，直到 pod 被调度</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolume</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-pv</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">capacity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10Gi</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumeMode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Filesystem</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">persistentVolumeReclaimPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Retain</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># PVC 被删除后，PV 的留存策略</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-sc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">local</span><span style="color:#24292E;">: </span><span style="color:#6A737D;"># 表示 pv 使用本地存储</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data/gitlab/data</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 使用 local pv 需要定义 nodeAffinity，k8s 需要根据 nodeAffinity 将 Pod 调度到有&gt;对应 local volume 的 node 上</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">required</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">matchExpressions</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubernetes.io/hostname</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">server2</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">PersistentVolumeClaim</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-pvc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">accessModes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">ReadWriteMany</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">storageClassName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-sc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">storage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">10Gi</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 声明存储的大小</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumeName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-pv</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 绑定 PV</span></span></code></pre></div><p>2、StatefulSet/Service</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30080</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ssh</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">22</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30022</span></span>
<span class="line"><span style="color:#B392F0;">---</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">StatefulSet</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">192.168.2.221:30005/gitlab-ce:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">22</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hostname</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;192.168.2.222&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">shm-size</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">value</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;256m&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-config</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-logs</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/log/gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-pvc</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/opt/gitlab</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-pvc</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">persistentVolumeClaim</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">claimName</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-pvc</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-config</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data/gitlab/config</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">gitlab-logs</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data/gitlab/logs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30080</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ssh</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">22</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30022</span></span>
<span class="line"><span style="color:#6F42C1;">---</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">StatefulSet</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">192.168.2.221:30005/gitlab-ce:latest</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">22</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">env</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hostname</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;192.168.2.222&quot;</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">shm-size</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">value</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;256m&quot;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-config</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/gitlab</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-logs</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/log/gitlab</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-pvc</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/opt/gitlab</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-pvc</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">persistentVolumeClaim</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">claimName</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-pvc</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-config</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data/gitlab/config</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">gitlab-logs</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data/gitlab/logs</span></span></code></pre></div><p>3、获取 root 密码</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod/gitlab-0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dev</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">grep</span></span>
<span class="line"><span style="color:#B392F0;">&#39;Password:&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/gitlab/initial_root_password</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod/gitlab-0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">grep</span></span>
<span class="line"><span style="color:#6F42C1;">&#39;Password:&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/gitlab/initial_root_password</span></span></code></pre></div><p>…</p><hr><h3 id="自定义端口配置" tabindex="-1">自定义端口配置 <a class="header-anchor" href="#自定义端口配置" aria-label="Permalink to &quot;自定义端口配置&quot;">​</a></h3><p>如果对 http 和 ssh 端口进行了修改，必须要修改配置文件中相应的内容。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/gitlab/gitlab.rb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">editor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/gitlab/gitlab.rb</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 如果是 docker 镜像内部</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/gitlab/gitlab.rb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">editor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/gitlab/gitlab.rb</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 如果是 docker 镜像内部</span></span></code></pre></div><p>1、external_url 修改 <code>external_url &#39;http://host:port&#39;</code></p><p>2、ssh 端口修改 <code>gitlab_rails[&#39;gitlab_shell_ssh_port&#39;]=port</code></p><blockquote><p>如果只做 external_url 端口的修改，会发现无法访问 webui，因为 GitLab 容器内部的 nginx 会默认监听 external_url 的端口号，因此还需要进一步修改 nginx 监听的端口。</p></blockquote><p>3、修改 <code>nginx[&#39;listen_port&#39;]=80</code></p><p>4、全部配置完成后，在 GitLab 容器内部可以使用 <code>gitlab-ctl</code> 命令来操作 GitLab 实例。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">gitlab-ctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reconfigure</span></span>
<span class="line"><span style="color:#B392F0;">gitlab-ctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">gitlab-ctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reconfigure</span></span>
<span class="line"><span style="color:#6F42C1;">gitlab-ctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span></span></code></pre></div><h3 id="ssh-配置" tabindex="-1">SSH 配置 <a class="header-anchor" href="#ssh-配置" aria-label="Permalink to &quot;SSH 配置&quot;">​</a></h3><blockquote><p>参考：<a href="https://docs.gitlab.com/ee/user/ssh.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/ee/user/ssh.html</a></p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># windows 下使用 git-bash</span></span>
<span class="line"><span style="color:#B392F0;">ssh-keygen</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ed25519</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;comment&gt;&quot;</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#B392F0;">ssh-keygen</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-b</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2048</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&lt;comment&gt;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 测试</span></span>
<span class="line"><span style="color:#B392F0;">ssh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-T</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssh://git@127.0.0.1:2200</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 假设将默认 22 端口修改成了 2200</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># windows 下使用 git-bash</span></span>
<span class="line"><span style="color:#6F42C1;">ssh-keygen</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ed25519</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;comment&gt;&quot;</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#6F42C1;">ssh-keygen</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-b</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2048</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&lt;comment&gt;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 测试</span></span>
<span class="line"><span style="color:#6F42C1;">ssh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-T</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssh://git@127.0.0.1:2200</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 假设将默认 22 端口修改成了 2200</span></span></code></pre></div><h3 id="头像显示配置" tabindex="-1">头像显示配置 <a class="header-anchor" href="#头像显示配置" aria-label="Permalink to &quot;头像显示配置&quot;">​</a></h3><p>1、打开 <code>/etc/gitlab/gitlab.rb</code></p><p>2、复制 <a href="https://docs.gitlab.com/ee/administration/libravatar.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/ee/administration/libravatar.html</a> 中 gravatar 部分的链接，如果没有使用 https 协议只需要复制 http 部分即可。</p><p>3、重启 GitLab。</p><h3 id="gitlab-内存占用大" tabindex="-1">GitLab 内存占用大 <a class="header-anchor" href="#gitlab-内存占用大" aria-label="Permalink to &quot;GitLab 内存占用大&quot;">​</a></h3><p>编辑 <code>/etc/gitlab/gitlab.rb</code>，修改：</p><ul><li>postgresql worker</li><li>puma worker and memory limit</li></ul><p><strong>参考</strong></p><ul><li><a href="https://docs.gitlab.com/ee/administration/operations/puma.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/ee/administration/operations/puma.html</a></li><li><a href="https://developer.aliyun.com/article/760745" target="_blank" rel="noreferrer">https://developer.aliyun.com/article/760745</a></li></ul><h2 id="使用-gitlab-ci" tabindex="-1">使用 GitLab CI <a class="header-anchor" href="#使用-gitlab-ci" aria-label="Permalink to &quot;使用 GitLab CI&quot;">​</a></h2><h3 id="部署-docker-gitlab-runner" tabindex="-1">部署 Docker GitLab Runner <a class="header-anchor" href="#部署-docker-gitlab-runner" aria-label="Permalink to &quot;部署 Docker GitLab Runner&quot;">​</a></h3><p><strong>步骤</strong></p><ul><li><p>启动 Runner</p></li><li><p>获取 <em>registration token</em></p></li><li><p>注册 Runner</p></li></ul><br><p>1、Docker 启动</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab-runner</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">--restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">always</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/srv/gitlab-runner/config:/etc/gitlab-runner</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/run/docker.sock:/var/run/docker.sock</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab/gitlab-runner:latest</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab-runner</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">--restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">always</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/srv/gitlab-runner/config:/etc/gitlab-runner</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/run/docker.sock:/var/run/docker.sock</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab/gitlab-runner:latest</span></span></code></pre></div><p>2、获取 <em>registration token</em></p><p>2.1、如果是在项目中单独配置 Runner</p><p><img src="`+p+'" alt="image-20230914152331175"></p><p>2.2、如果是配置共享的 Runner</p><p><img src="'+o+`" alt="image-20230914152345489"></p><p>3、注册 Runner</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab-runner</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash</span></span>
<span class="line"><span style="color:#B392F0;">gitlab-runner</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 接下来按照步骤填写即可。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab-runner</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash</span></span>
<span class="line"><span style="color:#6F42C1;">gitlab-runner</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 接下来按照步骤填写即可。</span></span></code></pre></div><h3 id="部署-kubernetes-gitlab-runner" tabindex="-1">部署 Kubernetes GitLab Runner <a class="header-anchor" href="#部署-kubernetes-gitlab-runner" aria-label="Permalink to &quot;部署 Kubernetes GitLab Runner&quot;">​</a></h3><blockquote><p>此处使用 K3s 来代替。</p></blockquote><p><strong>使用 Helm 部署 GitLab Runner</strong></p><blockquote><p>参考：<a href="https://docs.gitlab.com/runner/install/kubernetes.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/runner/install/kubernetes.html</a></p></blockquote><p>1、添加仓库</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># k3s 使用 helm 需要先 export KUBECONFIG</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> KUBECONFIG</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/rancher/k3s/k3s.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://charts.gitlab.io</span></span>
<span class="line"><span style="color:#B392F0;">helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">update</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab</span></span>
<span class="line"><span style="color:#B392F0;">helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">search</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab/gitlab-runner</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 尽量和 gitlab app 版本对应</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># k3s 使用 helm 需要先 export KUBECONFIG</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> KUBECONFIG</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/rancher/k3s/k3s.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://charts.gitlab.io</span></span>
<span class="line"><span style="color:#6F42C1;">helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">update</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab</span></span>
<span class="line"><span style="color:#6F42C1;">helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">search</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab/gitlab-runner</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 尽量和 gitlab app 版本对应</span></span></code></pre></div><p>2、拉取 helm release</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab/gitlab-runner</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab/gitlab-runner</span></span></code></pre></div><p>3、解压文件，编辑 <code>values.yaml</code>，主要编辑三个配置：</p><ul><li>gitlabUrl</li><li>runnerToken</li><li>rbac</li></ul><p>其中 rbac 配置可以参考：<a href="https://docs.gitlab.com/runner/executors/kubernetes.html#configure-runner-api-permissions" target="_blank" rel="noreferrer"><em>Configure runner API permissions</em></a>。在写这篇文章的时候使用的 gitlab 版本是 v16.1.1，rbac 配置内容大概如下：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">rbac</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">create</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">rules</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods/exec&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;create&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;patch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;delete&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods/attach&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;create&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;patch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;delete&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;update&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;pods&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;create&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;patch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;delete&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;services&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;create&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;patch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;delete&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">apiGroups</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;secrets&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">verbs</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;get&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;list&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;watch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;create&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;update&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;patch&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;delete&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">rbac</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">create</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">rules</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods/exec&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;create&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;patch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;delete&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods/attach&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;create&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;patch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;delete&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;update&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;pods&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;create&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;patch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;delete&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;services&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;create&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;patch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;delete&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">apiGroups</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;secrets&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">verbs</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;get&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;list&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;watch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;create&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;update&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;patch&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;delete&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><p>4、安装 gitlab-runner</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">namespace</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cicd</span></span>
<span class="line"><span style="color:#B392F0;">helm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab-runner</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--namespace=cicd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">values.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gitlab/gitlab-runner</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">namespace</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cicd</span></span>
<span class="line"><span style="color:#6F42C1;">helm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab-runner</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--namespace=cicd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">values.yaml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gitlab/gitlab-runner</span></span></code></pre></div><h3 id="executor" tabindex="-1">Executor <a class="header-anchor" href="#executor" aria-label="Permalink to &quot;Executor&quot;">​</a></h3><p>常用的 executor 有下面几个：</p><ul><li>shell</li><li>docker</li><li>kubernetes</li></ul><blockquote><p>executor 是什么意思？</p><p>假设 <code>.gitlab-ci.yml</code> 的内容如下：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 定义一个 job</span></span>
<span class="line"><span style="color:#85E89D;">build-job</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">stage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">build</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">only</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">dev</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">master</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">script</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">echo &quot;build job&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">java --version</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">mvn --version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 定义一个 job</span></span>
<span class="line"><span style="color:#22863A;">build-job</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">stage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">build</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">only</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">dev</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">master</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">script</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">echo &quot;build job&quot;</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">java --version</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">mvn --version</span></span></code></pre></div><p>拿 shell execotor 来说，在执行 build-job 的脚本命令时 GitLab Runner 会使用它所在的机器上的 shell 来执行。如果部署了 GitLab Runner 的机器上同时安装了 JDK 和 Maven，那么 build-job 就能执行成功。</p><p>如果 GitLab CI 中的某些 job 涉及到 Docker 镜像的 build/push/run 就需要使用到 docker executor。比如说：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">build-image-job</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">stage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">build</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">docker:latest</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">services</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">docker:dind</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">script</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">docker info</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">docker build -t $CI_PROJECT_NAME:$CI_COMMIT_TAG .</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">echo &quot;docker 镜像 $CI_PROJECT_NAME:$CI_COMMIT_TAG 打包完成。&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">docker images</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">echo &quot;docker 镜像上传&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">docker tag $CI_PROJECT_NAME:$CI_COMMIT_TAG $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_TAG</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">docker push $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_TAG</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">build-image-job</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">stage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">build</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">docker:latest</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">services</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">docker:dind</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">script</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">docker info</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">docker build -t $CI_PROJECT_NAME:$CI_COMMIT_TAG .</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">echo &quot;docker 镜像 $CI_PROJECT_NAME:$CI_COMMIT_TAG 打包完成。&quot;</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">docker images</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">echo &quot;docker 镜像上传&quot;</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">docker tag $CI_PROJECT_NAME:$CI_COMMIT_TAG $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_TAG</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">docker push $DOCKER_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_TAG</span></span></code></pre></div><p>同理，如果某些 job 涉及到 K8s 操作就需要使用 kubernetes executor。</p></blockquote><h3 id="docker-executor-踩坑" tabindex="-1">Docker Executor 踩坑 <a class="header-anchor" href="#docker-executor-踩坑" aria-label="Permalink to &quot;Docker Executor 踩坑&quot;">​</a></h3><p>在使用 docker executor 的时候踩了一个坑，执行到 docker 相关命令的时候报错：<em>error during connect: Post <a href="http://docker:2375/:" target="_blank" rel="noreferrer">http://docker:2375/:</a> dial tcp: lookup docker on x.x.x.x:53: no such host</em>。</p><p>排查许久，解决方法如下：</p><p>修改 GitLab Runner 的配置文件 <code>/etc/gitlab-runner/config.toml</code>：</p><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#B392F0;">runners</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;">] </span><span style="color:#6A737D;"># 在此部分添加下面的内容</span></span>
<span class="line"><span style="color:#E1E4E8;">  privileged = </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  volumes = [</span><span style="color:#9ECBFF;">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#6F42C1;">runners</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">docker</span><span style="color:#24292E;">] </span><span style="color:#6A737D;"># 在此部分添加下面的内容</span></span>
<span class="line"><span style="color:#24292E;">  privileged = </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  volumes = [</span><span style="color:#032F62;">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><span style="color:#24292E;">]</span></span></code></pre></div><blockquote><p>很奇怪，在启动 GitLab Runner 的时候分明已经添加了 <code>/var/run/docker.sock</code> 映射。</p></blockquote><h3 id="kubernetes-executor" tabindex="-1">Kubernetes Executor <a class="header-anchor" href="#kubernetes-executor" aria-label="Permalink to &quot;Kubernetes Executor&quot;">​</a></h3><h4 id="踩坑-1" tabindex="-1">踩坑 1 <a class="header-anchor" href="#踩坑-1" aria-label="Permalink to &quot;踩坑 1&quot;">​</a></h4><p>在使用 kubernetes executor 使用 docker-in-docker 镜像执行相关命令时也踩坑了，报错：</p><p><em>ERROR: Cannot connect to the Docker daemon at unix:///var/run/docker.sock.</em></p><p>解决办法：</p><p>1、宿主机安装 Docker</p><p>2、修改 GitLab Runner 的 <code>values.yaml</code> ：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">runners</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">config</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">    [[runners]]</span></span>
<span class="line"><span style="color:#9ECBFF;">      [runners.kubernetes]</span></span>
<span class="line"><span style="color:#9ECBFF;">        namespace = &quot;{{.Release.Namespace}}&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">        image = &quot;ubuntu:22.04&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">        [[runners.kubernetes.volumes.host_path]] # 添加这部分内容</span></span>
<span class="line"><span style="color:#9ECBFF;">          name = &quot;docker&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">          mount_path = &quot;/var/run/docker.sock&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">          host_path = &quot;/var/run/docker.sock&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">        privileged = true # 添加这部分内容</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">runners</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">config</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">    [[runners]]</span></span>
<span class="line"><span style="color:#032F62;">      [runners.kubernetes]</span></span>
<span class="line"><span style="color:#032F62;">        namespace = &quot;{{.Release.Namespace}}&quot;</span></span>
<span class="line"><span style="color:#032F62;">        image = &quot;ubuntu:22.04&quot;</span></span>
<span class="line"><span style="color:#032F62;">        [[runners.kubernetes.volumes.host_path]] # 添加这部分内容</span></span>
<span class="line"><span style="color:#032F62;">          name = &quot;docker&quot;</span></span>
<span class="line"><span style="color:#032F62;">          mount_path = &quot;/var/run/docker.sock&quot;</span></span>
<span class="line"><span style="color:#032F62;">          host_path = &quot;/var/run/docker.sock&quot;</span></span>
<span class="line"><span style="color:#032F62;">        privileged = true # 添加这部分内容</span></span></code></pre></div><p>3、编辑配置后重启 GitLab Runner（或者重新部署 GitLab Runner）。</p><h4 id="踩坑-2" tabindex="-1">踩坑 2 <a class="header-anchor" href="#踩坑-2" aria-label="Permalink to &quot;踩坑 2&quot;">​</a></h4><p>提示：<em>docker buildx: git was not found</em>，只需要更换镜像即可：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">build-image-job</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">stage</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">build</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">docker:24.0.6-git</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">build-image-job</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">stage</span><span style="color:#24292E;">: </span><span style="color:#032F62;">build</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">docker:24.0.6-git</span></span></code></pre></div>`,91),c=[t];function r(E,y,i,F,u,d){return a(),n("div",null,c)}const g=s(e,[["render",r]]);export{b as __pageData,g as default};
