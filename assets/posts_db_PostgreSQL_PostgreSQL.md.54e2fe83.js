import{_ as a,o as l,c as p,Q as n,k as s}from"./chunks/framework.b41230ea.js";const o="/assets/image-20231017135533652.cde65847.png",e="/assets/image-20231017091905095.be6a27ed.png",t="/assets/image-20231017163424709.32d6995f.png",c="/assets/image-20231017163516599.0a4ededd.png",r="/assets/image-20231018103016642.bfea7ea2.png",y="/assets/image-20231018103045843.449624ad.png",A=JSON.parse('{"title":"PostgreSQL","description":"PostgreSQL 详解，包含基础内容、高可用架构等","frontmatter":{"description":"PostgreSQL 详解，包含基础内容、高可用架构等","top":1,"sticky":true,"tag":["PostgreSQL","数据库"]},"headers":[],"relativePath":"posts/db/PostgreSQL/PostgreSQL.md","filePath":"posts/db/PostgreSQL/PostgreSQL.md","lastUpdated":1700657743000}'),E={name:"posts/db/PostgreSQL/PostgreSQL.md"},i=n(`<h1 id="postgresql" tabindex="-1">PostgreSQL <a class="header-anchor" href="#postgresql" aria-label="Permalink to &quot;PostgreSQL&quot;">​</a></h1><h2 id="启动" tabindex="-1">启动 <a class="header-anchor" href="#启动" aria-label="Permalink to &quot;启动&quot;">​</a></h2><p><strong>使用 Docker</strong></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pull</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--name</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres-test</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#9ECBFF;">:5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-e</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">POSTGRES_PASSWORD=postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/dump/2023-11-02:/var/lib/postgresql/data</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#6A737D;"># 将 PostgreSQL 内部的数据目录挂载到外部时需要挂载 /var/lib/postgresql/data 这个路径</span></span>
<span class="line"><span style="color:#6A737D;"># 挂载 /var/lib/postgresql 路径的话数据目录是不会被映射出来的。</span></span>
<span class="line"><span style="color:#6A737D;"># ref：https://hub.docker.com/_/postgres # PGDATA 参数部分</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pull</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--name</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres-test</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#032F62;">:5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-e</span><span style="color:#24292E;"> </span><span style="color:#032F62;">POSTGRES_PASSWORD=postgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/dump/2023-11-02:/var/lib/postgresql/data</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#6A737D;"># 将 PostgreSQL 内部的数据目录挂载到外部时需要挂载 /var/lib/postgresql/data 这个路径</span></span>
<span class="line"><span style="color:#6A737D;"># 挂载 /var/lib/postgresql 路径的话数据目录是不会被映射出来的。</span></span>
<span class="line"><span style="color:#6A737D;"># ref：https://hub.docker.com/_/postgres # PGDATA 参数部分</span></span></code></pre></div><p>…</p><hr><br><h2 id="数据库系统命令" tabindex="-1">数据库系统命令 <a class="header-anchor" href="#数据库系统命令" aria-label="Permalink to &quot;数据库系统命令&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">usernam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">hos</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">dbnam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">\\?</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># PostgreSQL 【系统级别】命令帮助文档</span></span>
<span class="line"><span style="color:#B392F0;">\\h</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># PostgreSQL 中 SQL 命令帮助文档</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">\\dg</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># list roles, role defualt is [postgres]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">\\l</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># list databases</span></span>
<span class="line"><span style="color:#B392F0;">\\dt</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># list tables</span></span>
<span class="line"><span style="color:#B392F0;">\\dx</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># list extensions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">\\db</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">tablenam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># list tablespaces</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">\\c</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">dbnam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># connect databae</span></span>
<span class="line"><span style="color:#B392F0;">\\conninfo</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># display information about current connection</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># after connected to a database</span></span>
<span class="line"><span style="color:#B392F0;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">version</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;"># Show postgreSQL&#39;s version</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">usernam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">hos</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">dbnam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">\\?</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># PostgreSQL 【系统级别】命令帮助文档</span></span>
<span class="line"><span style="color:#6F42C1;">\\h</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># PostgreSQL 中 SQL 命令帮助文档</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">\\dg</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># list roles, role defualt is [postgres]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">\\l</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># list databases</span></span>
<span class="line"><span style="color:#6F42C1;">\\dt</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># list tables</span></span>
<span class="line"><span style="color:#6F42C1;">\\dx</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># list extensions</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">\\db</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">tablenam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># list tablespaces</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">\\c</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">dbnam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># connect databae</span></span>
<span class="line"><span style="color:#6F42C1;">\\conninfo</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># display information about current connection</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># after connected to a database</span></span>
<span class="line"><span style="color:#6F42C1;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">version</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;"># Show postgreSQL&#39;s version</span></span></code></pre></div><p>…</p><hr><h2 id="数据库操作" tabindex="-1">数据库操作 <a class="header-anchor" href="#数据库操作" aria-label="Permalink to &quot;数据库操作&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">dbnam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">drop</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">dbnam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># can not drop your current db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">dbnam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># same as \\c, connect databaes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">create</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">dbnam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">drop</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">dbnam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># can not drop your current db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">dbnam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># same as \\c, connect databaes</span></span></code></pre></div><p>…</p><hr><h2 id="数据表操作" tabindex="-1">数据表操作 <a class="header-anchor" href="#数据表操作" aria-label="Permalink to &quot;数据表操作&quot;">​</a></h2><h3 id="创建-删除" tabindex="-1">创建/删除 <a class="header-anchor" href="#创建-删除" aria-label="Permalink to &quot;创建/删除&quot;">​</a></h3><p>创建/删除表的语句和 MySQL 一致：</p><ul><li>create table</li><li>drop table</li></ul><p>从文件装载数据</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 使用 COPY 从文本文件中装载大量数据</span></span>
<span class="line"><span style="color:#B392F0;">COPY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">weather</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">FROM</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;/path/weather.txt&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 使用 COPY 从文本文件中装载大量数据</span></span>
<span class="line"><span style="color:#6F42C1;">COPY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">weather</span><span style="color:#24292E;"> </span><span style="color:#032F62;">FROM</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;/path/weather.txt&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><p>表查询操作</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">\\d+</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">tablenam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 查看表的详情信息，表结构，字段等</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">\\d+</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">tablenam</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 查看表的详情信息，表结构，字段等</span></span></code></pre></div><p><strong>创建测试表</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">employees</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  depname </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">),</span></span>
<span class="line"><span style="color:#E1E4E8;">  empno </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  salary </span><span style="color:#F97583;">INT</span></span>
<span class="line"><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">employees</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  depname </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">),</span></span>
<span class="line"><span style="color:#24292E;">  empno </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  salary </span><span style="color:#D73A49;">INT</span></span>
<span class="line"><span style="color:#24292E;">);</span></span></code></pre></div><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;develop&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;develop&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4200</span><span style="color:#E1E4E8;">); </span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;develop&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4500</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;develop&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">6000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;develop&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5200</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;personnel&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3500</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;personnel&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3900</span><span style="color:#E1E4E8;">);  </span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;sales&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4800</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;sales&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> employees </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;sales&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">4800</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;develop&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">11</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5200</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;develop&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4200</span><span style="color:#24292E;">); </span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;develop&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">9</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4500</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;develop&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;develop&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">10</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5200</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;personnel&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3500</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;personnel&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3900</span><span style="color:#24292E;">);  </span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;sales&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4800</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;sales&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5000</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> employees </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;sales&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">4800</span><span style="color:#24292E;">);</span></span></code></pre></div><h3 id="修改表" tabindex="-1">修改表 <a class="header-anchor" href="#修改表" aria-label="Permalink to &quot;修改表&quot;">​</a></h3><ul><li>增加列</li><li>移除列</li><li>增加约束</li><li>移除约束</li><li>修改默认值</li><li>修改列数据类型</li><li>重命名列</li><li>重命名表</li></ul><p>…</p><hr><h2 id="数据类型" tabindex="-1">数据类型 <a class="header-anchor" href="#数据类型" aria-label="Permalink to &quot;数据类型&quot;">​</a></h2><h3 id="几何类型" tabindex="-1">几何类型 <a class="header-anchor" href="#几何类型" aria-label="Permalink to &quot;几何类型&quot;">​</a></h3>`,32),F=s("table",null,[s("thead",null,[s("tr",null,[s("th",null,"类型"),s("th",null,"大小"),s("th",null,"描述"),s("th",null,"备注")])]),s("tbody",null,[s("tr",null,[s("td",null,"point"),s("td",null,"16 字节"),s("td",null,"平面上的点"),s("td",null,"(x,y)")]),s("tr",{"A,B,C":""},[s("td",null,"line"),s("td",null,"32 字节"),s("td",null,"无限长的线"),s("td")]),s("tr",null,[s("td",null,"lseg"),s("td",null,"32 字节"),s("td",null,"有限线段"),s("td",null,"((x1,y1),(x2,y2))，A 点到 B 点")]),s("tr",null,[s("td",null,"box"),s("td",null,"32 字节"),s("td",null,"矩形框"),s("td",null,"((x1,y1),(x2,y2))，斜对角线端点")]),s("tr",null,[s("td",null,"path"),s("td",null,"16+16n 字节"),s("td",null,"封闭路径（类似于多边形）"),s("td",null,"((x1,y1),...)")]),s("tr",null,[s("td",null,"path"),s("td",null,"16+16n 字节"),s("td",null,"开放路径"),s("td",null,"[(x1,y1),...]")]),s("tr",null,[s("td",null,"polygon"),s("td",null,"40+16n 字节"),s("td",null,"多边形（类似于封闭路径）"),s("td",null,"((x1,y1),...)")]),s("tr",null,[s("td",null,"circle"),s("td",null,"24 字节"),s("td",null,"圆"),s("td",null,"<(x,y),r>（中心点和半径）")])])],-1),d=n(`<h3 id="数组" tabindex="-1">数组 <a class="header-anchor" href="#数组" aria-label="Permalink to &quot;数组&quot;">​</a></h3><h4 id="数组操作" tabindex="-1">数组操作 <a class="header-anchor" href="#数组操作" aria-label="Permalink to &quot;数组操作&quot;">​</a></h4><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE user_hobbies (</span></span>
<span class="line"><span style="color:#e1e4e8;">  id serial not null,</span></span>
<span class="line"><span style="color:#e1e4e8;">  name VARCHAR(50),</span></span>
<span class="line"><span style="color:#e1e4e8;">  hobbies TEXT[]</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 可以使用 array 关键字来表示数组</span></span>
<span class="line"><span style="color:#e1e4e8;">INSERT INTO user_hobbies (name, hobbies)</span></span>
<span class="line"><span style="color:#e1e4e8;">VALUES (&#39;Tom&#39;, ARRAY[&#39;Football&#39;, &#39;Basketball&#39;]);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 也可以使用 {}</span></span>
<span class="line"><span style="color:#e1e4e8;">INSERT INTO user_hobbies (name, hobbies)</span></span>
<span class="line"><span style="color:#e1e4e8;">VALUES (&#39;Tom&#39;, &quot;{&#39;Football&#39;, &#39;Basketball&#39;}&quot;);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 查询操作</span></span>
<span class="line"><span style="color:#e1e4e8;">SELECT</span></span>
<span class="line"><span style="color:#e1e4e8;">    name,</span></span>
<span class="line"><span style="color:#e1e4e8;">    hobbies</span></span>
<span class="line"><span style="color:#e1e4e8;">FROM</span></span>
<span class="line"><span style="color:#e1e4e8;">    user_hobbies;</span></span>
<span class="line"><span style="color:#e1e4e8;">    </span></span>
<span class="line"><span style="color:#e1e4e8;">-- PostgreSQL 中的数组下标是从 1 开始的</span></span>
<span class="line"><span style="color:#e1e4e8;">SELECT</span></span>
<span class="line"><span style="color:#e1e4e8;">  name,</span></span>
<span class="line"><span style="color:#e1e4e8;">  hobbies[1]</span></span>
<span class="line"><span style="color:#e1e4e8;">FROM</span></span>
<span class="line"><span style="color:#e1e4e8;">  user_hobbies;</span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">-- 使用 any() 过滤数组</span></span>
<span class="line"><span style="color:#e1e4e8;">SELECT</span></span>
<span class="line"><span style="color:#e1e4e8;">  name,</span></span>
<span class="line"><span style="color:#e1e4e8;">  hobbies</span></span>
<span class="line"><span style="color:#e1e4e8;">FROM</span></span>
<span class="line"><span style="color:#e1e4e8;">  user_hobbies</span></span>
<span class="line"><span style="color:#e1e4e8;">WHERE</span></span>
<span class="line"><span style="color:#e1e4e8;">  &#39;Football&#39; = ANY (hobbies);</span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">-- 更新数组中的元素</span></span>
<span class="line"><span style="color:#e1e4e8;">UPDATE user_hobbies</span></span>
<span class="line"><span style="color:#e1e4e8;">SET hobbies[2] = &#39;Baseball&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">WHERE ID = 1;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 更新整个数组</span></span>
<span class="line"><span style="color:#e1e4e8;">UPDATE user_hobbies</span></span>
<span class="line"><span style="color:#e1e4e8;">SET hobbies = &#39;{&quot;Baseball&quot;}&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">WHERE ID = 1*;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE user_hobbies (</span></span>
<span class="line"><span style="color:#24292e;">  id serial not null,</span></span>
<span class="line"><span style="color:#24292e;">  name VARCHAR(50),</span></span>
<span class="line"><span style="color:#24292e;">  hobbies TEXT[]</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 可以使用 array 关键字来表示数组</span></span>
<span class="line"><span style="color:#24292e;">INSERT INTO user_hobbies (name, hobbies)</span></span>
<span class="line"><span style="color:#24292e;">VALUES (&#39;Tom&#39;, ARRAY[&#39;Football&#39;, &#39;Basketball&#39;]);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 也可以使用 {}</span></span>
<span class="line"><span style="color:#24292e;">INSERT INTO user_hobbies (name, hobbies)</span></span>
<span class="line"><span style="color:#24292e;">VALUES (&#39;Tom&#39;, &quot;{&#39;Football&#39;, &#39;Basketball&#39;}&quot;);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 查询操作</span></span>
<span class="line"><span style="color:#24292e;">SELECT</span></span>
<span class="line"><span style="color:#24292e;">    name,</span></span>
<span class="line"><span style="color:#24292e;">    hobbies</span></span>
<span class="line"><span style="color:#24292e;">FROM</span></span>
<span class="line"><span style="color:#24292e;">    user_hobbies;</span></span>
<span class="line"><span style="color:#24292e;">    </span></span>
<span class="line"><span style="color:#24292e;">-- PostgreSQL 中的数组下标是从 1 开始的</span></span>
<span class="line"><span style="color:#24292e;">SELECT</span></span>
<span class="line"><span style="color:#24292e;">  name,</span></span>
<span class="line"><span style="color:#24292e;">  hobbies[1]</span></span>
<span class="line"><span style="color:#24292e;">FROM</span></span>
<span class="line"><span style="color:#24292e;">  user_hobbies;</span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">-- 使用 any() 过滤数组</span></span>
<span class="line"><span style="color:#24292e;">SELECT</span></span>
<span class="line"><span style="color:#24292e;">  name,</span></span>
<span class="line"><span style="color:#24292e;">  hobbies</span></span>
<span class="line"><span style="color:#24292e;">FROM</span></span>
<span class="line"><span style="color:#24292e;">  user_hobbies</span></span>
<span class="line"><span style="color:#24292e;">WHERE</span></span>
<span class="line"><span style="color:#24292e;">  &#39;Football&#39; = ANY (hobbies);</span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">-- 更新数组中的元素</span></span>
<span class="line"><span style="color:#24292e;">UPDATE user_hobbies</span></span>
<span class="line"><span style="color:#24292e;">SET hobbies[2] = &#39;Baseball&#39;</span></span>
<span class="line"><span style="color:#24292e;">WHERE ID = 1;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 更新整个数组</span></span>
<span class="line"><span style="color:#24292e;">UPDATE user_hobbies</span></span>
<span class="line"><span style="color:#24292e;">SET hobbies = &#39;{&quot;Baseball&quot;}&#39;</span></span>
<span class="line"><span style="color:#24292e;">WHERE ID = 1*;</span></span></code></pre></div><h4 id="数组类型对照" tabindex="-1">数组类型对照 <a class="header-anchor" href="#数组类型对照" aria-label="Permalink to &quot;数组类型对照&quot;">​</a></h4><table><thead><tr><th style="text-align:center;">JAVA TYPE</th><th style="text-align:center;">SUPPORTED BINARY POSTGRESQL TYPES</th><th style="text-align:center;">DEFAULT POSTGRESQL TYPE</th></tr></thead><tbody><tr><td style="text-align:center;"><code>short[] </code>, <code>Short[]</code></td><td style="text-align:center;"><code>int2[]</code></td><td style="text-align:center;"><code>int2[]</code></td></tr><tr><td style="text-align:center;"><code>int[] </code>, <code>Integer[]</code></td><td style="text-align:center;"><code>int4[]</code></td><td style="text-align:center;"><code>int4[]</code></td></tr><tr><td style="text-align:center;"><code>long[] </code>, <code>Long[]</code></td><td style="text-align:center;"><code>int8[]</code></td><td style="text-align:center;"><code>int8[]</code></td></tr><tr><td style="text-align:center;"><code>float[] </code>, <code>Float[]</code></td><td style="text-align:center;"><code>float4[]</code></td><td style="text-align:center;"><code>float4[]</code></td></tr><tr><td style="text-align:center;"><code>double[] </code>, <code>Double[]</code></td><td style="text-align:center;"><code>float8[]</code></td><td style="text-align:center;"><code>float8[]</code></td></tr><tr><td style="text-align:center;"><code>boolean[] </code>, <code>Boolean[]</code></td><td style="text-align:center;"><code>bool[]</code></td><td style="text-align:center;"><code>bool[]</code></td></tr><tr><td style="text-align:center;"><code>String[]</code></td><td style="text-align:center;"><code>varchar[] </code>, <code>text[]</code></td><td style="text-align:center;"><code>varchar[]</code></td></tr><tr><td style="text-align:center;"><code>byte[][]</code></td><td style="text-align:center;"><code>bytea[]</code></td><td style="text-align:center;"><code>bytea[]</code></td></tr></tbody></table><p>…</p><hr><h2 id="数据操作" tabindex="-1">数据操作 <a class="header-anchor" href="#数据操作" aria-label="Permalink to &quot;数据操作&quot;">​</a></h2><h3 id="从修改行中返回数据" tabindex="-1">从修改行中返回数据 <a class="header-anchor" href="#从修改行中返回数据" aria-label="Permalink to &quot;从修改行中返回数据&quot;">​</a></h3><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE users (firstname text, lastname text, id serial primary key);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">INSERT INTO users (firstname, lastname) VALUES (&#39;Joe&#39;, &#39;Cool&#39;) RETURNING id;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">UPDATE products SET price = price * 1.10</span></span>
<span class="line"><span style="color:#e1e4e8;">  WHERE price &lt;= 99.99</span></span>
<span class="line"><span style="color:#e1e4e8;">  RETURNING name, price AS new_price; -- RETURNING 的数据是被修改行的新内容</span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">DELETE FROM products</span></span>
<span class="line"><span style="color:#e1e4e8;">  WHERE obsoletion_date = &#39;today&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">  RETURNING *; -- RETURNING 的数据是被删除行的内容</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE users (firstname text, lastname text, id serial primary key);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">INSERT INTO users (firstname, lastname) VALUES (&#39;Joe&#39;, &#39;Cool&#39;) RETURNING id;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">UPDATE products SET price = price * 1.10</span></span>
<span class="line"><span style="color:#24292e;">  WHERE price &lt;= 99.99</span></span>
<span class="line"><span style="color:#24292e;">  RETURNING name, price AS new_price; -- RETURNING 的数据是被修改行的新内容</span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">DELETE FROM products</span></span>
<span class="line"><span style="color:#24292e;">  WHERE obsoletion_date = &#39;today&#39;</span></span>
<span class="line"><span style="color:#24292e;">  RETURNING *; -- RETURNING 的数据是被删除行的内容</span></span></code></pre></div><p>…</p><hr><h2 id="列特性" tabindex="-1">列特性 <a class="header-anchor" href="#列特性" aria-label="Permalink to &quot;列特性&quot;">​</a></h2><h3 id="生成列" tabindex="-1">生成列 <a class="header-anchor" href="#生成列" aria-label="Permalink to &quot;生成列&quot;">​</a></h3><p>生成的列是一个特殊的列，生成列的数据总是从其他列计算而来。生成列有两种：存储列和虚拟列。</p><ul><li>存储生成列在写入(插入或更新)时计算，并且像普通列一样占用存储空间。</li><li>虚拟生成列不占用存储空间并且在读取时进行计算。</li></ul><p>PostgreSQL 目前只实现了存储生成列。</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">people</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    ...,</span></span>
<span class="line"><span style="color:#E1E4E8;">    height_cm </span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    height_in </span><span style="color:#F97583;">numeric</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">GENERATED</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ALWAYS</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">AS</span><span style="color:#E1E4E8;"> (height_cm </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">54</span><span style="color:#E1E4E8;">) STORED </span><span style="color:#6A737D;">--必须指定关键字 STORED 以指定存储生成列</span></span>
<span class="line"><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">people</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    ...,</span></span>
<span class="line"><span style="color:#24292E;">    height_cm </span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    height_in </span><span style="color:#D73A49;">numeric</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">GENERATED</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ALWAYS</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">AS</span><span style="color:#24292E;"> (height_cm </span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">54</span><span style="color:#24292E;">) STORED </span><span style="color:#6A737D;">--必须指定关键字 STORED 以指定存储生成列</span></span>
<span class="line"><span style="color:#24292E;">);</span></span></code></pre></div><blockquote><p>生成列不能在<code>INSERT</code> 或 <code>UPDATE</code>命令中被直接写入, 不能为生成列指定值, 但是可以指定关键字<code>DEFAULT</code>。</p></blockquote><p><strong>使用限制</strong></p><ul><li>生成表达式不能引用另一个生成列。</li><li>生成表达式不能引用系统表。</li><li>生成列不能是分区键的一部分。</li></ul><h3 id="约束" tabindex="-1">约束 <a class="header-anchor" href="#约束" aria-label="Permalink to &quot;约束&quot;">​</a></h3><h4 id="使用" tabindex="-1">使用 <a class="header-anchor" href="#使用" aria-label="Permalink to &quot;使用&quot;">​</a></h4><p>话不多说，上代码：</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    price numeric CHECK (price &gt; 0)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer,</span></span>
<span class="line"><span style="color:#24292e;">    name text,</span></span>
<span class="line"><span style="color:#24292e;">    price numeric CHECK (price &gt; 0)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div><p>为了清晰一点， 也可以加上 <code>CONSTRAINT</code> 关键字：</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    price numeric CONSTRAINT positive_price CHECK (price &gt; 0)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer,</span></span>
<span class="line"><span style="color:#24292e;">    name text,</span></span>
<span class="line"><span style="color:#24292e;">    price numeric CONSTRAINT positive_price CHECK (price &gt; 0)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div><p>一个检查约束也可以引用多个列</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    price numeric CHECK (price &gt; 0),</span></span>
<span class="line"><span style="color:#e1e4e8;">    discounted_price numeric CHECK (discounted_price &gt; 0),</span></span>
<span class="line"><span style="color:#e1e4e8;">    CHECK (price &gt; discounted_price)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 也可以写成</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    price numeric,</span></span>
<span class="line"><span style="color:#e1e4e8;">    CHECK (price &gt; 0),</span></span>
<span class="line"><span style="color:#e1e4e8;">    discounted_price numeric,</span></span>
<span class="line"><span style="color:#e1e4e8;">    CHECK (discounted_price &gt; 0),</span></span>
<span class="line"><span style="color:#e1e4e8;">    CHECK (price &gt; discounted_price) --或者同一行 CHECK (discounted_price &gt; 0 AND price &gt; discounted_price)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer,</span></span>
<span class="line"><span style="color:#24292e;">    name text,</span></span>
<span class="line"><span style="color:#24292e;">    price numeric CHECK (price &gt; 0),</span></span>
<span class="line"><span style="color:#24292e;">    discounted_price numeric CHECK (discounted_price &gt; 0),</span></span>
<span class="line"><span style="color:#24292e;">    CHECK (price &gt; discounted_price)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 也可以写成</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer,</span></span>
<span class="line"><span style="color:#24292e;">    name text,</span></span>
<span class="line"><span style="color:#24292e;">    price numeric,</span></span>
<span class="line"><span style="color:#24292e;">    CHECK (price &gt; 0),</span></span>
<span class="line"><span style="color:#24292e;">    discounted_price numeric,</span></span>
<span class="line"><span style="color:#24292e;">    CHECK (discounted_price &gt; 0),</span></span>
<span class="line"><span style="color:#24292e;">    CHECK (price &gt; discounted_price) --或者同一行 CHECK (discounted_price &gt; 0 AND price &gt; discounted_price)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div><br><h4 id="约束类型" tabindex="-1">约束类型 <a class="header-anchor" href="#约束类型" aria-label="Permalink to &quot;约束类型&quot;">​</a></h4><ul><li><p><strong>非空约束</strong>：NOT NULL（很常见，不展开）。</p></li><li><p><strong>唯一约束</strong>：UNIQUE。</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 同一行语法</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer UNIQUE</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 表约束语法</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    UNIQUE (product_no)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;">-- 定义一组唯一约束</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE example (</span></span>
<span class="line"><span style="color:#e1e4e8;">    a integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    b integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    c integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    UNIQUE (a, c)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 同一行语法</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer UNIQUE</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 表约束语法</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer,</span></span>
<span class="line"><span style="color:#24292e;">    UNIQUE (product_no)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;">-- 定义一组唯一约束</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE example (</span></span>
<span class="line"><span style="color:#24292e;">    a integer,</span></span>
<span class="line"><span style="color:#24292e;">    b integer,</span></span>
<span class="line"><span style="color:#24292e;">    c integer,</span></span>
<span class="line"><span style="color:#24292e;">    UNIQUE (a, c)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div></li><li><p><strong>主键约束</strong>：PRIMARY KEY。</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 单列主键</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer PRIMARY KEY</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 多列主键</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE example (</span></span>
<span class="line"><span style="color:#e1e4e8;">    a integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    b integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    c integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    PRIMARY KEY (a, c)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 单列主键</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer PRIMARY KEY</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 多列主键</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE example (</span></span>
<span class="line"><span style="color:#24292e;">    a integer,</span></span>
<span class="line"><span style="color:#24292e;">    b integer,</span></span>
<span class="line"><span style="color:#24292e;">    c integer,</span></span>
<span class="line"><span style="color:#24292e;">    PRIMARY KEY (a, c)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div></li><li><p><strong>外键约束</strong>：REFERENCES。</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 产品表</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    price numeric</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;">-- 订单表</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE orders (</span></span>
<span class="line"><span style="color:#e1e4e8;">    order_id integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer REFERENCES products (product_no),</span></span>
<span class="line"><span style="color:#e1e4e8;">    quantity integer</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 可以将外键约束的列省略，默认使用被引用表的主键作为外键。</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE orders (</span></span>
<span class="line"><span style="color:#e1e4e8;">    order_id integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer REFERENCES products,</span></span>
<span class="line"><span style="color:#e1e4e8;">    quantity integer</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 也可以使用 mysql-like 方式</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE t1 (</span></span>
<span class="line"><span style="color:#e1e4e8;">  a integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#e1e4e8;">  b integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">  c integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">  FOREIGN KEY (b, c) REFERENCES other_table (c1, c2)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 外键约束相关操作</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    price numeric</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE orders (</span></span>
<span class="line"><span style="color:#e1e4e8;">    order_id integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#e1e4e8;">    shipping_address text,</span></span>
<span class="line"><span style="color:#e1e4e8;">    ...</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE TABLE order_items (</span></span>
<span class="line"><span style="color:#e1e4e8;">    product_no integer REFERENCES products ON DELETE RESTRICT, -- 限制删除</span></span>
<span class="line"><span style="color:#e1e4e8;">    order_id integer REFERENCES orders ON DELETE CASCADE, -- 级联删除</span></span>
<span class="line"><span style="color:#e1e4e8;">    quantity integer,</span></span>
<span class="line"><span style="color:#e1e4e8;">    PRIMARY KEY (product_no, order_id)</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 产品表</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#24292e;">    name text,</span></span>
<span class="line"><span style="color:#24292e;">    price numeric</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;">-- 订单表</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE orders (</span></span>
<span class="line"><span style="color:#24292e;">    order_id integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer REFERENCES products (product_no),</span></span>
<span class="line"><span style="color:#24292e;">    quantity integer</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 可以将外键约束的列省略，默认使用被引用表的主键作为外键。</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE orders (</span></span>
<span class="line"><span style="color:#24292e;">    order_id integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer REFERENCES products,</span></span>
<span class="line"><span style="color:#24292e;">    quantity integer</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 也可以使用 mysql-like 方式</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE t1 (</span></span>
<span class="line"><span style="color:#24292e;">  a integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#24292e;">  b integer,</span></span>
<span class="line"><span style="color:#24292e;">  c integer,</span></span>
<span class="line"><span style="color:#24292e;">  FOREIGN KEY (b, c) REFERENCES other_table (c1, c2)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 外键约束相关操作</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE products (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#24292e;">    name text,</span></span>
<span class="line"><span style="color:#24292e;">    price numeric</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE orders (</span></span>
<span class="line"><span style="color:#24292e;">    order_id integer PRIMARY KEY,</span></span>
<span class="line"><span style="color:#24292e;">    shipping_address text,</span></span>
<span class="line"><span style="color:#24292e;">    ...</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;">CREATE TABLE order_items (</span></span>
<span class="line"><span style="color:#24292e;">    product_no integer REFERENCES products ON DELETE RESTRICT, -- 限制删除</span></span>
<span class="line"><span style="color:#24292e;">    order_id integer REFERENCES orders ON DELETE CASCADE, -- 级联删除</span></span>
<span class="line"><span style="color:#24292e;">    quantity integer,</span></span>
<span class="line"><span style="color:#24292e;">    PRIMARY KEY (product_no, order_id)</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div></li><li><p><strong>排他约束</strong>：EXCLUDE。</p><p>下面实例创建了一张 COMPANY7 表，添加 5 个字段，并且使用了 EXCLUDE 约束。</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE COMPANY7(</span></span>
<span class="line"><span style="color:#e1e4e8;">   ID INT PRIMARY KEY     NOT NULL,</span></span>
<span class="line"><span style="color:#e1e4e8;">   NAME           TEXT,</span></span>
<span class="line"><span style="color:#e1e4e8;">   AGE            INT  ,</span></span>
<span class="line"><span style="color:#e1e4e8;">   ADDRESS        CHAR(50),</span></span>
<span class="line"><span style="color:#e1e4e8;">   SALARY         REAL,</span></span>
<span class="line"><span style="color:#e1e4e8;">   EXCLUDE USING gist</span></span>
<span class="line"><span style="color:#e1e4e8;">   (NAME WITH =,  -- 如果满足 NAME 相同，AGE 不相同则不允许插入，否则允许插入</span></span>
<span class="line"><span style="color:#e1e4e8;">   AGE WITH &lt;&gt;)   -- 其比较的结果是如果整个表达式返回 true，则不允许插入，否则允许</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE COMPANY7(</span></span>
<span class="line"><span style="color:#24292e;">   ID INT PRIMARY KEY     NOT NULL,</span></span>
<span class="line"><span style="color:#24292e;">   NAME           TEXT,</span></span>
<span class="line"><span style="color:#24292e;">   AGE            INT  ,</span></span>
<span class="line"><span style="color:#24292e;">   ADDRESS        CHAR(50),</span></span>
<span class="line"><span style="color:#24292e;">   SALARY         REAL,</span></span>
<span class="line"><span style="color:#24292e;">   EXCLUDE USING gist</span></span>
<span class="line"><span style="color:#24292e;">   (NAME WITH =,  -- 如果满足 NAME 相同，AGE 不相同则不允许插入，否则允许插入</span></span>
<span class="line"><span style="color:#24292e;">   AGE WITH &lt;&gt;)   -- 其比较的结果是如果整个表达式返回 true，则不允许插入，否则允许</span></span>
<span class="line"><span style="color:#24292e;">);</span></span></code></pre></div><blockquote><p>其中 <code>USING gist</code> 是用于构建和执行的索引一种类型。<em>需要为每个数据库执行一次 <code>CREATE EXTENSION btree_gist</code> 命令安装 btree_gist 扩展，它定义了对纯标量数据类型的 EXCLUDE 约束。</em></p></blockquote><p>由于我们已经强制执行了年龄必须相同，让我们通过向表插入记录来查看这一点：</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">INSERT INTO COMPANY7 VALUES(1, &#39;Paul&#39;, 32, &#39;California&#39;, 20000.00 );</span></span>
<span class="line"><span style="color:#e1e4e8;">INSERT INTO COMPANY7 VALUES(2, &#39;Paul&#39;, 32, &#39;Texas&#39;, 20000.00 );</span></span>
<span class="line"><span style="color:#e1e4e8;">-- 此条数据的 NAME 与第一条相同，且 AGE 与第一条也相同，故满足插入条件</span></span>
<span class="line"><span style="color:#e1e4e8;">INSERT INTO COMPANY7 VALUES(3, &#39;Allen&#39;, 42, &#39;California&#39;, 20000.00 );</span></span>
<span class="line"><span style="color:#e1e4e8;">-- 此数据与上面数据的 NAME 相同，但 AGE 不相同，故不允许插入</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">INSERT INTO COMPANY7 VALUES(1, &#39;Paul&#39;, 32, &#39;California&#39;, 20000.00 );</span></span>
<span class="line"><span style="color:#24292e;">INSERT INTO COMPANY7 VALUES(2, &#39;Paul&#39;, 32, &#39;Texas&#39;, 20000.00 );</span></span>
<span class="line"><span style="color:#24292e;">-- 此条数据的 NAME 与第一条相同，且 AGE 与第一条也相同，故满足插入条件</span></span>
<span class="line"><span style="color:#24292e;">INSERT INTO COMPANY7 VALUES(3, &#39;Allen&#39;, 42, &#39;California&#39;, 20000.00 );</span></span>
<span class="line"><span style="color:#24292e;">-- 此数据与上面数据的 NAME 相同，但 AGE 不相同，故不允许插入</span></span></code></pre></div></li></ul><br><h3 id="系统列" tabindex="-1">系统列 <a class="header-anchor" href="#系统列" aria-label="Permalink to &quot;系统列&quot;">​</a></h3><p>每一个表都拥有一些由系统隐式定义的系统列。事实上用户不需要关心这些列，只需要知道它们存在即可。</p><table><thead><tr><th>列名</th><th>备注</th><th>描述</th></tr></thead><tbody><tr><td>oid/tableiod</td><td>table object id</td><td>包含这一行的表的 OID</td></tr><tr><td>xmin</td><td></td><td>插入该行版本的事务身份（事务ID）</td></tr><tr><td>xmax</td><td></td><td>删除事务的身份（事务ID）</td></tr><tr><td>cmin</td><td></td><td>插入事务中的命令标识符（从0开始）</td></tr><tr><td>cmax</td><td></td><td>删除事务中的命令标识符</td></tr><tr><td>ctid</td><td></td><td>行版本在其表中的物理位置。尽管 ctid 可以被用来非常快速地定位行版本，但是一个行的 ctid 会在被更新或者被 <code>VACUUM FULL</code> 移动时改变。因此，<code>ctid</code> 不能作为一个长期行标识符。</td></tr></tbody></table><p>…</p><hr><br><h2 id="表特性" tabindex="-1">表特性 <a class="header-anchor" href="#表特性" aria-label="Permalink to &quot;表特性&quot;">​</a></h2><h3 id="表继承" tabindex="-1">表继承 <a class="header-anchor" href="#表继承" aria-label="Permalink to &quot;表继承&quot;">​</a></h3><p>直接上 SQL 代码：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">cities</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">name</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">text</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">population</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">real</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  elevation  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">     </span><span style="color:#6A737D;">-- (in ft)</span></span>
<span class="line"><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">capitals</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">state</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">UNIQUE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT NULL</span></span>
<span class="line"><span style="color:#E1E4E8;">) INHERITS (cities);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">cities</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">name</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">text</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">population</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">real</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  elevation  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">     </span><span style="color:#6A737D;">-- (in ft)</span></span>
<span class="line"><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">capitals</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">state</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">char</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">UNIQUE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT NULL</span></span>
<span class="line"><span style="color:#24292E;">) INHERITS (cities);</span></span></code></pre></div><p>上面这段代码中 capitals 表继承 cities，同时还新增了一个 state 字段。</p><p>如果执行：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> ... </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> cities;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> ... </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> cities;</span></span></code></pre></div><p>会同时查询 cities 和 capitals 两个表。如果只想查询 cities 表，不查询它的子表，可以使用 ONLY 关键字。例如：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> ... </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> ONLY cities;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">select</span><span style="color:#24292E;"> ... </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> ONLY cities;</span></span></code></pre></div><p>除了 Select，Update 和 Delete 关键字也都支持 ONLY。</p><h3 id="表分区" tabindex="-1">表分区 <a class="header-anchor" href="#表分区" aria-label="Permalink to &quot;表分区&quot;">​</a></h3><p>表分区指的是将逻辑上的一个大表分成一些小的物理上的片。分区的好处：</p><ul><li>在某些情况下查询性能能够显著提升。</li><li>当查询或更新访问单个分区中的某一部分数据时，可以通过使用该分区的顺序扫描来提高性能（索引是在整个表中的随机访问读取）。</li></ul><p><strong>PostgreSQL 分区形式</strong></p><ul><li>范围分区，表被根据一个关键列或一组列划分为“范围”，不同的分区的范围之间没有重叠。相邻分区可以共享一个边界值，范围上限被视为不包含的边界。</li><li>列表分区，通过显式地列出每一个分区中出现的键值来划分表。</li><li>哈希分区，通过为每个分区指定模数和余数来对表进行分区。</li></ul><p><strong>自定义分区创建</strong></p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE TABLE measurement (</span></span>
<span class="line"><span style="color:#e1e4e8;">    id int not null,</span></span>
<span class="line"><span style="color:#e1e4e8;">    logdate date not null</span></span>
<span class="line"><span style="color:#e1e4e8;">) PARTITION BY RANGE (logdate);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE TABLE measurement (</span></span>
<span class="line"><span style="color:#24292e;">    id int not null,</span></span>
<span class="line"><span style="color:#24292e;">    logdate date not null</span></span>
<span class="line"><span style="color:#24292e;">) PARTITION BY RANGE (logdate);</span></span></code></pre></div><p>…</p><hr><br><h2 id="高级特性" tabindex="-1">高级特性 <a class="header-anchor" href="#高级特性" aria-label="Permalink to &quot;高级特性&quot;">​</a></h2><h3 id="窗口函数" tabindex="-1">窗口函数 <a class="header-anchor" href="#窗口函数" aria-label="Permalink to &quot;窗口函数&quot;">​</a></h3><p>窗口函数是 SQL 函数，可以对当前行或当前行周围的若干行执行计算。一个窗口函数调用总是包含一个 OVER 子句，OVER 关键字可以指定窗口函数的范围，包括分区和排序顺序。</p><ul><li><p><code>PARTITION BY</code> 对具有相同值的字段进行分区。对于每一行，窗口函数都会在当前行同一分区的行上进行计算。</p><p>看下面的例子：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> depname, empno, salary, </span></span>
<span class="line"><span style="color:#79B8FF;">avg</span><span style="color:#E1E4E8;">(salary) </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">PARTITION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BY</span><span style="color:#E1E4E8;"> depname) </span></span>
<span class="line"><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> employees;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> depname, empno, salary, </span></span>
<span class="line"><span style="color:#005CC5;">avg</span><span style="color:#24292E;">(salary) </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">PARTITION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BY</span><span style="color:#24292E;"> depname) </span></span>
<span class="line"><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> employees;</span></span></code></pre></div><p>将相同部门的员工分为一个区，每次执行 avg() 都只是针对一个区进行的。看一下输出结果：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">depname</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">empno</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">salary</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">avg</span></span>
<span class="line"><span style="color:#B392F0;">-----------+-------+--------+-----------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">11</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">5200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">9</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">6000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">5200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">personnel</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">3500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">3700.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">personnel</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">3900</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">3700.0000000000000000</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sales</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4800</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">4866.6666666666666667</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sales</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">5000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">4866.6666666666666667</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sales</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4800</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">4866.6666666666666667</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">depname</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">empno</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">salary</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">          </span><span style="color:#6F42C1;">avg</span></span>
<span class="line"><span style="color:#6F42C1;">-----------+-------+--------+-----------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">11</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">5200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">9</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">6000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">5200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">5020.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">personnel</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">3500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">3700.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">personnel</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">3900</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">3700.0000000000000000</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sales</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4800</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">4866.6666666666666667</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sales</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">5000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">4866.6666666666666667</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sales</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4800</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">4866.6666666666666667</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p>结果和预期一样，先将部门分区，然后求每个部门的平均薪资。</p></li><li><p><code>ORDER BY</code> 控制窗口函数处理行的顺序。</p><p>将上面的语句稍作修改：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"># rank 不需要显式的参数，因为它的行为完全决定于 </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> 子句。</span></span>
<span class="line"><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> depname, empno, salary,</span></span>
<span class="line"><span style="color:#79B8FF;">rank</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">OVER</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">PARTITION</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BY</span><span style="color:#E1E4E8;"> depname </span><span style="color:#F97583;">ORDER BY</span><span style="color:#E1E4E8;"> salary </span><span style="color:#F97583;">DESC</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;"> employees;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"># rank 不需要显式的参数，因为它的行为完全决定于 </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> 子句。</span></span>
<span class="line"><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> depname, empno, salary,</span></span>
<span class="line"><span style="color:#005CC5;">rank</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">OVER</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">PARTITION</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BY</span><span style="color:#24292E;"> depname </span><span style="color:#D73A49;">ORDER BY</span><span style="color:#24292E;"> salary </span><span style="color:#D73A49;">DESC</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;"> employees;</span></span></code></pre></div><p>输出结果如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">depname</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">empno</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">salary</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rank</span></span>
<span class="line"><span style="color:#B392F0;">-----------+-------+--------+------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">6000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">5200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">2</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">11</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">5200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">2</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">9</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">4</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">develop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">7</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">5</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">personnel</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">3900</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">personnel</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">3500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">2</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sales</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">5000</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sales</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4800</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">2</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sales</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">4800</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rows</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">depname</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">empno</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">salary</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rank</span></span>
<span class="line"><span style="color:#6F42C1;">-----------+-------+--------+------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">6000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">1</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">10</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">5200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">2</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">11</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">5200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">2</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">9</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">4</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">develop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">7</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">5</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">personnel</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">3900</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">1</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">personnel</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">3500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">2</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sales</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">5000</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">1</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sales</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">4</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4800</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">2</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sales</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#6F42C1;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">4800</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#6F42C1;">2</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rows</span><span style="color:#24292E;">)</span></span></code></pre></div><p>先将部门分区，再对部门中员工的薪水进行排序。</p></li><li><p>…</p></li></ul><hr><h2 id="索引" tabindex="-1">索引 <a class="header-anchor" href="#索引" aria-label="Permalink to &quot;索引&quot;">​</a></h2><h3 id="索引类型" tabindex="-1">索引类型 <a class="header-anchor" href="#索引类型" aria-label="Permalink to &quot;索引类型&quot;">​</a></h3><h4 id="b-tree-索引" tabindex="-1">B-tree 索引 <a class="header-anchor" href="#b-tree-索引" aria-label="Permalink to &quot;B-tree 索引&quot;">​</a></h4><p>涉及到以下操作可以考虑使用 B-tree 索引：</p><ul><li><p><code>&lt;</code> 、 <code>&lt;=</code> 、 <code>=</code> 、 <code>&gt;=</code> 、 <code>&gt;</code></p></li><li><p>BETWEEN 和 IN</p></li><li><p>在索引列上的 IS NULL 或 IS NOT NULL 条件</p></li><li><p>LIKE 和 <code>~</code></p><p>但是 B-tree 索引只使用下面的情况</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">column_name LIKE &#39;foo%&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">column_name LKE &#39;bar%&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">column_name  ~ &#39;^foo&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">column_name LIKE &#39;foo%&#39;</span></span>
<span class="line"><span style="color:#24292e;">column_name LKE &#39;bar%&#39;</span></span>
<span class="line"><span style="color:#24292e;">column_name  ~ &#39;^foo&#39;</span></span></code></pre></div><p>而不适用于下面的情况：</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">col LIKE &#39;%bar&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">col LIKE &#39;%bar&#39;</span></span></code></pre></div></li></ul><h4 id="哈希索引" tabindex="-1">哈希索引 <a class="header-anchor" href="#哈希索引" aria-label="Permalink to &quot;哈希索引&quot;">​</a></h4><p>每当索引列使用 <code>=</code> 运算符进行比较时，查询计划器将考虑使用哈希索引。</p><p>创建哈希索引，需要指定 <code>USING HASH</code>：</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE INDEX index_name</span></span>
<span class="line"><span style="color:#e1e4e8;">ON table_name USING HASH (indexed_column);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE INDEX index_name</span></span>
<span class="line"><span style="color:#24292e;">ON table_name USING HASH (indexed_column);</span></span></code></pre></div><h4 id="gin-索引" tabindex="-1">GIN 索引 <a class="header-anchor" href="#gin-索引" aria-label="Permalink to &quot;GIN 索引&quot;">​</a></h4><blockquote><p>通用倒排索引，Generalized Inverted Index。</p></blockquote><p>正排索引查找时扫描表中每个文档，直到找出所有包含查询关键字的文档。倒排表以<em>字</em>或<em>词</em>为关键字作为索引，对应记录表中出现这个字或词的所有文档。由于每个字或词对应的文档数量是动态变化的，所以倒排表的建立和维护都较为复杂，但是在查询的时候效率高于正排表。</p><h4 id="brin-索引" tabindex="-1">BRIN 索引 <a class="header-anchor" href="#brin-索引" aria-label="Permalink to &quot;BRIN 索引&quot;">​</a></h4><blockquote><p>块范围索引，Block Range Indexes。</p></blockquote><h4 id="gist-索引" tabindex="-1">GiST 索引 <a class="header-anchor" href="#gist-索引" aria-label="Permalink to &quot;GiST 索引&quot;">​</a></h4><p>GiST 索引不是单独一种索引类型，而是一种架构，可以在这种架构上实现很多不同的索引策略。</p><p>GiST 代表广义搜索树。GiST 索引允许构建通用的树结构。GiST 索引可用于索引几何数据类型和全文搜索。</p><h4 id="sp-gist-索引" tabindex="-1">SP-GiST 索引 <a class="header-anchor" href="#sp-gist-索引" aria-label="Permalink to &quot;SP-GiST 索引&quot;">​</a></h4><blockquote><p>SP-GiST 代表空间分区的 GiST。</p></blockquote><p>…</p><hr><h3 id="创建索引" tabindex="-1">创建索引 <a class="header-anchor" href="#创建索引" aria-label="Permalink to &quot;创建索引&quot;">​</a></h3><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE [ UNIQUE ] INDEX [ [ IF NOT EXISTS ] index_name ] -- 自定义索引名称</span></span>
<span class="line"><span style="color:#e1e4e8;">    ON table_name [ USING method ] -- method 是索引方法名称，包括 btree, hash, gist, spgist, gin, 和 brin。默认使用 btree。</span></span>
<span class="line"><span style="color:#e1e4e8;">(</span></span>
<span class="line"><span style="color:#e1e4e8;">    column_name [ ASC | DESC ] [ NULLS { FIRST | LAST } ] -- column_name 表示需要创建索引的列名</span></span>
<span class="line"><span style="color:#e1e4e8;">    [, ...]</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">create index on table_name(colum_name);</span></span>
<span class="line"><span style="color:#e1e4e8;">create index my_hash_idx on tb_test using hash(colum_name); -- 创建 hash 索引</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 多列索引，和 MySQL 一样遵循最左匹配原则</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE INDEX index_name</span></span>
<span class="line"><span style="color:#e1e4e8;">ON table_name(a, b, c);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE [ UNIQUE ] INDEX [ [ IF NOT EXISTS ] index_name ] -- 自定义索引名称</span></span>
<span class="line"><span style="color:#24292e;">    ON table_name [ USING method ] -- method 是索引方法名称，包括 btree, hash, gist, spgist, gin, 和 brin。默认使用 btree。</span></span>
<span class="line"><span style="color:#24292e;">(</span></span>
<span class="line"><span style="color:#24292e;">    column_name [ ASC | DESC ] [ NULLS { FIRST | LAST } ] -- column_name 表示需要创建索引的列名</span></span>
<span class="line"><span style="color:#24292e;">    [, ...]</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">create index on table_name(colum_name);</span></span>
<span class="line"><span style="color:#24292e;">create index my_hash_idx on tb_test using hash(colum_name); -- 创建 hash 索引</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 多列索引，和 MySQL 一样遵循最左匹配原则</span></span>
<span class="line"><span style="color:#24292e;">CREATE INDEX index_name</span></span>
<span class="line"><span style="color:#24292e;">ON table_name(a, b, c);</span></span></code></pre></div><h3 id="部分索引" tabindex="-1">部分索引 <a class="header-anchor" href="#部分索引" aria-label="Permalink to &quot;部分索引&quot;">​</a></h3><blockquote><p>按照条件创建索引</p></blockquote><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 对 customer 表中 active = 0 的列创建索引</span></span>
<span class="line"><span style="color:#e1e4e8;">CREATE INDEX idx_customer_inactive</span></span>
<span class="line"><span style="color:#e1e4e8;">ON customer(active)</span></span>
<span class="line"><span style="color:#e1e4e8;">WHERE active = 0;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 对 customer 表中 active = 0 的列创建索引</span></span>
<span class="line"><span style="color:#24292e;">CREATE INDEX idx_customer_inactive</span></span>
<span class="line"><span style="color:#24292e;">ON customer(active)</span></span>
<span class="line"><span style="color:#24292e;">WHERE active = 0;</span></span></code></pre></div><h3 id="重建索引" tabindex="-1">重建索引 <a class="header-anchor" href="#重建索引" aria-label="Permalink to &quot;重建索引&quot;">​</a></h3><ul><li><p>重建单个索引</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">REINDEX INDEX index_name;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">REINDEX INDEX index_name;</span></span></code></pre></div></li><li><p>重建表中的所有索引</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">REINDEX TABLE table_name;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">REINDEX TABLE table_name;</span></span></code></pre></div></li><li><p>重建数据库中的所有索引</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">REINDEX DATABASE database_name;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">REINDEX DATABASE database_name;</span></span></code></pre></div></li><li><p>…</p></li></ul><hr><h2 id="执行分析" tabindex="-1">执行分析 <a class="header-anchor" href="#执行分析" aria-label="Permalink to &quot;执行分析&quot;">​</a></h2><blockquote><ul><li>来自 <a href="http://mysql.taobao.org/monthly/" target="_blank" rel="noreferrer">polardb 数据库内核月报</a>：<a href="http://mysql.taobao.org/monthly/2018/11/06/" target="_blank" rel="noreferrer">http://mysql.taobao.org/monthly/2018/11/06/</a></li><li><a href="https://www.modb.pro/db/101529" target="_blank" rel="noreferrer">https://www.modb.pro/db/101529</a></li></ul></blockquote><p>…</p><hr><br><h1 id="pg-高可用架构" tabindex="-1">PG 高可用架构 <a class="header-anchor" href="#pg-高可用架构" aria-label="Permalink to &quot;PG 高可用架构&quot;">​</a></h1><h2 id="pg-安装" tabindex="-1">PG 安装 <a class="header-anchor" href="#pg-安装" aria-label="Permalink to &quot;PG 安装&quot;">​</a></h2><blockquote><p>Docker/K8s 环境下部署不好控制，选择直接安装在服务器上。</p></blockquote><p>1、<a href="https://www.postgresql.org/download/linux/ubuntu/" target="_blank" rel="noreferrer">Ubuntu install</a></p><p>2、<code>psql -V</code> 查看版本</p><p>3、切换用户，并登录</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">psql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">psql</span></span></code></pre></div><ul><li>配置路径：<code>/etc/postgresql/16/main/</code></li><li>数据路径：<code>/var/lib/postgresql/16/main/</code></li><li>配置模板路径：<code>/usr/share/postgresql/16/main/</code></li><li>pg 命令行工具：<code>/usr/lib/postgresql/16/bin</code></li></ul><blockquote><p>可能会遇到 <code>/var/lib/postgresql/</code> 目录下 <em>operation not permitted</em> 的问题，解决方法：</p><ul><li>一次性修改：<code>chown -R postgres:postgres /var/lib/postgresql/</code></li><li>先修改 owner：<code>chown -R postgres /var/lib/postgresql/</code>，再修改 group：<code>chown -R postgres /var/lib/postgresql/</code></li></ul></blockquote><p>4、创建用户</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE USER root superuser login PASSWORD &#39;123456&#39;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE USER root superuser login PASSWORD &#39;123456&#39;;</span></span></code></pre></div><p>5、开启远程访问</p><p>5.1、修改 pg_hba.conf</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># TYPE DATABASE USER ADDRESS METHOD</span></span>
<span class="line"><span style="color:#e1e4e8;">host all all 0.0.0.0/0 trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># TYPE DATABASE USER ADDRESS METHOD</span></span>
<span class="line"><span style="color:#24292e;">host all all 0.0.0.0/0 trust</span></span></code></pre></div><blockquote><p>trust 表示不需要密码，如果需要密码则改为 md5</p></blockquote><p>5.2、修改 postgresql.conf</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">listen_addresses = &#39;*&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">listen_addresses = &#39;*&#39;</span></span></code></pre></div><p>5.3、重启服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/init.d/postgresql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/init.d/postgresql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span></span></code></pre></div><blockquote><p>现在就可以通过远程访问数据库了</p></blockquote><p>6、创建测试数据</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE DATABASE test OWNER root;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">create table myuser (</span></span>
<span class="line"><span style="color:#e1e4e8;">    id serial primary key,</span></span>
<span class="line"><span style="color:#e1e4e8;">    name varchar(20) not null,</span></span>
<span class="line"><span style="color:#e1e4e8;">    age int not null</span></span>
<span class="line"><span style="color:#e1e4e8;">);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">insert into myuser (name, age) values (&#39;zhangsan&#39;, 20);</span></span>
<span class="line"><span style="color:#e1e4e8;">insert into myuser (name, age) values (&#39;lisi&#39;, 21);</span></span>
<span class="line"><span style="color:#e1e4e8;">insert into myuser (name, age) values (&#39;wangwu&#39;, 22);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE DATABASE test OWNER root;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">create table myuser (</span></span>
<span class="line"><span style="color:#24292e;">    id serial primary key,</span></span>
<span class="line"><span style="color:#24292e;">    name varchar(20) not null,</span></span>
<span class="line"><span style="color:#24292e;">    age int not null</span></span>
<span class="line"><span style="color:#24292e;">);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">insert into myuser (name, age) values (&#39;zhangsan&#39;, 20);</span></span>
<span class="line"><span style="color:#24292e;">insert into myuser (name, age) values (&#39;lisi&#39;, 21);</span></span>
<span class="line"><span style="color:#24292e;">insert into myuser (name, age) values (&#39;wangwu&#39;, 22);</span></span></code></pre></div><p>…</p><hr><h2 id="主从流复制" tabindex="-1">主从流复制 <a class="header-anchor" href="#主从流复制" aria-label="Permalink to &quot;主从流复制&quot;">​</a></h2><h3 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h3><p>7、主节点创建同步账号</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">CREATE USER repl REPLICATION LOGIN ENCRYPTED PASSWORD &#39;123456&#39;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">CREATE USER repl REPLICATION LOGIN ENCRYPTED PASSWORD &#39;123456&#39;;</span></span></code></pre></div><p>8、修改 pg_hba.conf</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># TYPE DATABASE USER ADDRESS METHOD</span></span>
<span class="line"><span style="color:#e1e4e8;">host all repl 0.0.0.0/0 trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># TYPE DATABASE USER ADDRESS METHOD</span></span>
<span class="line"><span style="color:#24292e;">host all repl 0.0.0.0/0 trust</span></span></code></pre></div><p>9、修改 postgresql.conf</p><blockquote><p><a href="https://www.net-cc.com/posts/linux-software/postgresql/02-postgresql-master_slave-replication/" target="_blank" rel="noreferrer">按照 Cc 的说法</a>：主从服务器都要设置, 万一那天从服务器提升为主了呢</p></blockquote><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">listen_addresses = &#39;*&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">wal_level = replica</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_mode = on</span></span>
<span class="line"><span style="color:#e1e4e8;">#archive_command = &#39;/bin/true&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_command = &#39;{ sleep 5; true; }&#39; # 9.5 后淘汰，或许可以尝试不填写？</span></span>
<span class="line"><span style="color:#e1e4e8;">max_wal_senders = 10</span></span>
<span class="line"><span style="color:#e1e4e8;">max_replication_slots = 10 # (修改) 设置支持的复制槽数量</span></span>
<span class="line"><span style="color:#e1e4e8;">max_slot_wal_keep_size = 1GB # (修改) 设置复制槽保留的 wal 最大值,默认单位是 M</span></span>
<span class="line"><span style="color:#e1e4e8;">hot_standby = on</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#wal_sender_timeout = 60s</span></span>
<span class="line"><span style="color:#e1e4e8;">#wal_keep_segments = 64</span></span>
<span class="line"><span style="color:#e1e4e8;">#hot_standby_feedback = on # 如果有错误的数据复制向主进行反馈</span></span>
<span class="line"><span style="color:#e1e4e8;">#synchronous_commit = on  # 开启同步复制</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#log_truncate_on_rotation = &#39;on&#39; # 日志滚动</span></span>
<span class="line"><span style="color:#e1e4e8;">#log_rotation_age = &#39;1d&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">#log_rotation_size = 0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">listen_addresses = &#39;*&#39;</span></span>
<span class="line"><span style="color:#24292e;">wal_level = replica</span></span>
<span class="line"><span style="color:#24292e;">archive_mode = on</span></span>
<span class="line"><span style="color:#24292e;">#archive_command = &#39;/bin/true&#39;</span></span>
<span class="line"><span style="color:#24292e;">archive_command = &#39;{ sleep 5; true; }&#39; # 9.5 后淘汰，或许可以尝试不填写？</span></span>
<span class="line"><span style="color:#24292e;">max_wal_senders = 10</span></span>
<span class="line"><span style="color:#24292e;">max_replication_slots = 10 # (修改) 设置支持的复制槽数量</span></span>
<span class="line"><span style="color:#24292e;">max_slot_wal_keep_size = 1GB # (修改) 设置复制槽保留的 wal 最大值,默认单位是 M</span></span>
<span class="line"><span style="color:#24292e;">hot_standby = on</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#wal_sender_timeout = 60s</span></span>
<span class="line"><span style="color:#24292e;">#wal_keep_segments = 64</span></span>
<span class="line"><span style="color:#24292e;">#hot_standby_feedback = on # 如果有错误的数据复制向主进行反馈</span></span>
<span class="line"><span style="color:#24292e;">#synchronous_commit = on  # 开启同步复制</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#log_truncate_on_rotation = &#39;on&#39; # 日志滚动</span></span>
<span class="line"><span style="color:#24292e;">#log_rotation_age = &#39;1d&#39;</span></span>
<span class="line"><span style="color:#24292e;">#log_rotation_size = 0</span></span></code></pre></div><p>10、重启主节点</p><p>11、从节点同步主节点数据 11.1、停止从节点</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span></span></code></pre></div><p>11.2、在从节点上备份主节点数据</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">pg_basebackup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">master-hos</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">p</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stream</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-P</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-R</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/pgsql</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-C</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-S</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">slave01</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">slave01</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># -D 指定备份数据存放的目录</span></span>
<span class="line"><span style="color:#6A737D;"># -F, --format=p|t 输出格式 (纯文本 (缺省值), tar压缩格式)</span></span>
<span class="line"><span style="color:#6A737D;"># -X, --wal-method=none|fetch|stream 按指定的模式包含必需的WAL日志文件</span></span>
<span class="line"><span style="color:#6A737D;"># -v, --verbose 输出详细的消息</span></span>
<span class="line"><span style="color:#6A737D;"># -P, --progress 显示进度信息</span></span>
<span class="line"><span style="color:#6A737D;"># -R, --write-recovery-conf 为复制写配置文件</span></span>
<span class="line"><span style="color:#6A737D;"># -C, --create-slot 创建复制槽</span></span>
<span class="line"><span style="color:#6A737D;"># -S, --slot=SLOTNAME 用于复制的槽名</span></span>
<span class="line"><span style="color:#6A737D;"># -l, --label=LABEL 设置备份标签</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 备份从节点原先的数据</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/16/main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/16/main.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 使用主节点同步过来的数据代替从节点原先的数据</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/data/pgsql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/16/main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-R</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres:postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-R</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/16/main</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">pg_basebackup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">master-hos</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> </span><span style="color:#032F62;">p</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stream</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-P</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-R</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/pgsql</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-C</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-S</span><span style="color:#24292E;"> </span><span style="color:#032F62;">slave01</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">slave01</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># -D 指定备份数据存放的目录</span></span>
<span class="line"><span style="color:#6A737D;"># -F, --format=p|t 输出格式 (纯文本 (缺省值), tar压缩格式)</span></span>
<span class="line"><span style="color:#6A737D;"># -X, --wal-method=none|fetch|stream 按指定的模式包含必需的WAL日志文件</span></span>
<span class="line"><span style="color:#6A737D;"># -v, --verbose 输出详细的消息</span></span>
<span class="line"><span style="color:#6A737D;"># -P, --progress 显示进度信息</span></span>
<span class="line"><span style="color:#6A737D;"># -R, --write-recovery-conf 为复制写配置文件</span></span>
<span class="line"><span style="color:#6A737D;"># -C, --create-slot 创建复制槽</span></span>
<span class="line"><span style="color:#6A737D;"># -S, --slot=SLOTNAME 用于复制的槽名</span></span>
<span class="line"><span style="color:#6A737D;"># -l, --label=LABEL 设置备份标签</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 备份从节点原先的数据</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/16/main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/16/main.bak</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 使用主节点同步过来的数据代替从节点原先的数据</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/data/pgsql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/16/main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-R</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres:postgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-R</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/16/main</span></span></code></pre></div><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 复制槽状态检查</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_replication_slots;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 创建复制槽</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_create_physical_replication_slot(&#39;slave01&#39;);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 删除复制槽</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_drop_replication_slot(&#39;slave01&#39;);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 复制槽状态检查</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_replication_slots;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 创建复制槽</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_create_physical_replication_slot(&#39;slave01&#39;);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 删除复制槽</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_drop_replication_slot(&#39;slave01&#39;);</span></span></code></pre></div><p>11.2、启动从节点，并检查从节点状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span></span></code></pre></div><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 节点状态检查</span></span>
<span class="line"><span style="color:#e1e4e8;">-- 查询结果为&quot;f&quot;表示主库, &#39;t&#39;表示从库</span></span>
<span class="line"><span style="color:#e1e4e8;">select pg_is_in_recovery();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 节点状态检查</span></span>
<span class="line"><span style="color:#24292e;">-- 查询结果为&quot;f&quot;表示主库, &#39;t&#39;表示从库</span></span>
<span class="line"><span style="color:#24292e;">select pg_is_in_recovery();</span></span></code></pre></div><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-- 在主节点检查同步状态</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_stat_replication;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-- 在主节点检查同步状态</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_stat_replication;</span></span></code></pre></div><p>输出内容大概如下：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_stat_replication</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\g</span></span>
<span class="line"><span style="color:#B392F0;">-[</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">RECORD</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">]----+------------------------------</span></span>
<span class="line"><span style="color:#B392F0;">pid</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2299</span></span>
<span class="line"><span style="color:#B392F0;">usesysid</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">16388</span></span>
<span class="line"><span style="color:#B392F0;">usename</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">repl</span></span>
<span class="line"><span style="color:#B392F0;">application_name</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">16/main</span></span>
<span class="line"><span style="color:#B392F0;">client_addr</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.14</span></span>
<span class="line"><span style="color:#B392F0;">client_hostname</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">client_port</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">48412</span></span>
<span class="line"><span style="color:#B392F0;">backend_start</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2023-10-13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">03</span><span style="color:#9ECBFF;">:11:24.319331+00</span></span>
<span class="line"><span style="color:#B392F0;">backend_xmin</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">state</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">streaming</span></span>
<span class="line"><span style="color:#B392F0;">sent_lsn</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0/3000148</span></span>
<span class="line"><span style="color:#B392F0;">write_lsn</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0/3000148</span></span>
<span class="line"><span style="color:#B392F0;">flush_lsn</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0/3000148</span></span>
<span class="line"><span style="color:#B392F0;">replay_lsn</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0/3000148</span></span>
<span class="line"><span style="color:#B392F0;">write_lag</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">flush_lag</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">replay_lag</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">sync_priority</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0</span></span>
<span class="line"><span style="color:#B392F0;">sync_state</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">async</span></span>
<span class="line"><span style="color:#B392F0;">reply_time</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2023-10-13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">03</span><span style="color:#9ECBFF;">:12:24.342696+00</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_stat_replication</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\g</span></span>
<span class="line"><span style="color:#6F42C1;">-[</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RECORD</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">]----+------------------------------</span></span>
<span class="line"><span style="color:#6F42C1;">pid</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2299</span></span>
<span class="line"><span style="color:#6F42C1;">usesysid</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">16388</span></span>
<span class="line"><span style="color:#6F42C1;">usename</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">repl</span></span>
<span class="line"><span style="color:#6F42C1;">application_name</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">16/main</span></span>
<span class="line"><span style="color:#6F42C1;">client_addr</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.14</span></span>
<span class="line"><span style="color:#6F42C1;">client_hostname</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">client_port</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">48412</span></span>
<span class="line"><span style="color:#6F42C1;">backend_start</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2023-10-13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">03</span><span style="color:#032F62;">:11:24.319331+00</span></span>
<span class="line"><span style="color:#6F42C1;">backend_xmin</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">state</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">streaming</span></span>
<span class="line"><span style="color:#6F42C1;">sent_lsn</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0/3000148</span></span>
<span class="line"><span style="color:#6F42C1;">write_lsn</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0/3000148</span></span>
<span class="line"><span style="color:#6F42C1;">flush_lsn</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0/3000148</span></span>
<span class="line"><span style="color:#6F42C1;">replay_lsn</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0/3000148</span></span>
<span class="line"><span style="color:#6F42C1;">write_lag</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">flush_lag</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">replay_lag</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">sync_priority</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0</span></span>
<span class="line"><span style="color:#6F42C1;">sync_state</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">async</span></span>
<span class="line"><span style="color:#6F42C1;">reply_time</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2023-10-13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">03</span><span style="color:#032F62;">:12:24.342696+00</span></span></code></pre></div><p>12、尝试在主库插入数据，在从库查询。从库有记录表示主从复制配置完成。多配置几个从节点就是一主多从架构了。</p><hr><p><strong>主节点宕机会发生什么？</strong></p><p>1、假设现在为一主二从的状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_replication_slots</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">-[</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">RECORD</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">]-------+----------</span></span>
<span class="line"><span style="color:#B392F0;">slot_name</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">slave01</span></span>
<span class="line"><span style="color:#B392F0;">plugin</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">slot_type</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">physical</span></span>
<span class="line"><span style="color:#B392F0;">datoid</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">database</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">temporary</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span></span>
<span class="line"><span style="color:#B392F0;">active</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">t</span></span>
<span class="line"><span style="color:#B392F0;">active_pid</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2739</span></span>
<span class="line"><span style="color:#B392F0;">xmin</span><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">catalog_xmin</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">restart_lsn</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0/7000330</span></span>
<span class="line"><span style="color:#B392F0;">confirmed_flush_lsn</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">wal_status</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">reserved</span></span>
<span class="line"><span style="color:#B392F0;">safe_wal_size</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">two_phase</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span></span>
<span class="line"><span style="color:#B392F0;">conflicting</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">-[</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">RECORD</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">]-------+----------</span></span>
<span class="line"><span style="color:#B392F0;">slot_name</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">slave02</span></span>
<span class="line"><span style="color:#B392F0;">plugin</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">slot_type</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">physical</span></span>
<span class="line"><span style="color:#B392F0;">datoid</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">database</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">temporary</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span></span>
<span class="line"><span style="color:#B392F0;">active</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">t</span></span>
<span class="line"><span style="color:#B392F0;">active_pid</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">3553</span></span>
<span class="line"><span style="color:#B392F0;">xmin</span><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">catalog_xmin</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">restart_lsn</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0/7000330</span></span>
<span class="line"><span style="color:#B392F0;">confirmed_flush_lsn</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">wal_status</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">reserved</span></span>
<span class="line"><span style="color:#B392F0;">safe_wal_size</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">two_phase</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span></span>
<span class="line"><span style="color:#B392F0;">conflicting</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_replication_slots</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">-[</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RECORD</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">]-------+----------</span></span>
<span class="line"><span style="color:#6F42C1;">slot_name</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">slave01</span></span>
<span class="line"><span style="color:#6F42C1;">plugin</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">slot_type</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">physical</span></span>
<span class="line"><span style="color:#6F42C1;">datoid</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">database</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">temporary</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span></span>
<span class="line"><span style="color:#6F42C1;">active</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">t</span></span>
<span class="line"><span style="color:#6F42C1;">active_pid</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2739</span></span>
<span class="line"><span style="color:#6F42C1;">xmin</span><span style="color:#24292E;">                </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">catalog_xmin</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">restart_lsn</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0/7000330</span></span>
<span class="line"><span style="color:#6F42C1;">confirmed_flush_lsn</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">wal_status</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">reserved</span></span>
<span class="line"><span style="color:#6F42C1;">safe_wal_size</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">two_phase</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span></span>
<span class="line"><span style="color:#6F42C1;">conflicting</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">-[</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RECORD</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">]-------+----------</span></span>
<span class="line"><span style="color:#6F42C1;">slot_name</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">slave02</span></span>
<span class="line"><span style="color:#6F42C1;">plugin</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">slot_type</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">physical</span></span>
<span class="line"><span style="color:#6F42C1;">datoid</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">database</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">temporary</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span></span>
<span class="line"><span style="color:#6F42C1;">active</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">t</span></span>
<span class="line"><span style="color:#6F42C1;">active_pid</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">3553</span></span>
<span class="line"><span style="color:#6F42C1;">xmin</span><span style="color:#24292E;">                </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">catalog_xmin</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">restart_lsn</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0/7000330</span></span>
<span class="line"><span style="color:#6F42C1;">confirmed_flush_lsn</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">wal_status</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">reserved</span></span>
<span class="line"><span style="color:#6F42C1;">safe_wal_size</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">two_phase</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span></span>
<span class="line"><span style="color:#6F42C1;">conflicting</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span></span></code></pre></div><p>2、让主节点下线</p><p>3、主节点下线后查看从节点状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_is_in_recovery</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#B392F0;">-[</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">RECORD</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">]-----+--</span></span>
<span class="line"><span style="color:#B392F0;">pg_is_in_recovery</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">t</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_is_in_recovery</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#6F42C1;">-[</span><span style="color:#24292E;"> </span><span style="color:#032F62;">RECORD</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">]-----+--</span></span>
<span class="line"><span style="color:#6F42C1;">pg_is_in_recovery</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">t</span></span></code></pre></div><p>可以看到依然是从库，需要手动选择某一个从库提升为主库</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/postgresql/16/bin</span></span>
<span class="line"><span style="color:#B392F0;">./pg_ctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">promote</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/16/main</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/postgresql/16/bin</span></span>
<span class="line"><span style="color:#6F42C1;">./pg_ctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">promote</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/16/main</span></span></code></pre></div><p>输出内容大概如下：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">waiting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">promote....</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">done</span></span>
<span class="line"><span style="color:#B392F0;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">promoted</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">waiting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">promote....</span><span style="color:#24292E;"> </span><span style="color:#032F62;">done</span></span>
<span class="line"><span style="color:#6F42C1;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">promoted</span></span></code></pre></div><p>再次检查该从节点状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">postgres</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">#</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_is_in_recovery</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg_is_in_recovery</span></span>
<span class="line"><span style="color:#B392F0;">-------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span></span>
<span class="line"><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">row</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">postgres</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">#</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_is_in_recovery</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg_is_in_recovery</span></span>
<span class="line"><span style="color:#6F42C1;">-------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span></span>
<span class="line"><span style="color:#24292E;">(</span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">row</span><span style="color:#24292E;">)</span></span></code></pre></div><p>理论上来说可以这样子操作：</p><blockquote><p>该从节点已经变成主节点了，接下来为对应的从节点创建复制槽</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">select * from pg_create_physical_replication_slot(&#39;slave0X&#39;);</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-- 查看复制槽状态</span></span>
<span class="line"><span style="color:#e1e4e8;">select * from pg_replication_slots;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">select * from pg_create_physical_replication_slot(&#39;slave0X&#39;);</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-- 查看复制槽状态</span></span>
<span class="line"><span style="color:#24292e;">select * from pg_replication_slots;</span></span></code></pre></div><p>最后编辑其他从节点的 <code>postgresql.auto.conf</code> 文件，修改 <code>primary_conninfo</code> 为新的主节点地址，重启从节点即可。</p></blockquote><p>但是我操作一番并未成功，可能需要再走一遍之前的步骤 11。</p><hr><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>主从流复制不需要借助其他第三方工具，直接配置即可。但是配置稍繁琐，而且如果主节点宕机了从节点不会自动切换，需要手动切换。</p><hr><br><h2 id="主从流复制-repmgr" tabindex="-1">主从流复制 + repmgr <a class="header-anchor" href="#主从流复制-repmgr" aria-label="Permalink to &quot;主从流复制 + repmgr&quot;">​</a></h2><blockquote><p><em>Replication Manager</em> 简称 repmgr。</p></blockquote><h3 id="repmgr-配置" tabindex="-1">repmgr 配置 <a class="header-anchor" href="#repmgr-配置" aria-label="Permalink to &quot;repmgr 配置&quot;">​</a></h3><p>1、首先查看 repmgr 与 PostgreSQL 的<a href="https://www.repmgr.org/docs/current/install-requirements.html" target="_blank" rel="noreferrer">版本对应关系</a>，并<a href="https://www.repmgr.org/docs/current/installation-packages.html#INSTALLATION-PACKAGES-DEBIAN" target="_blank" rel="noreferrer">安装</a>。</p><p>此处以 pg-15 为例：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql-15</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">curl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://dl.enterprisedb.com/default/release/get/deb</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql-15-repmgr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 注意：安装完成第一件事是取消 postgresql 开机自启</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql-15</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">curl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://dl.enterprisedb.com/default/release/get/deb</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql-15-repmgr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 注意：安装完成第一件事是取消 postgresql 开机自启</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span></span></code></pre></div><p>2、修改 <code>/etc/postgresql/15/main/postgresql.conf</code> 和 <code>/etc/postgresql/15/main/pg_hba.conf</code>，允许外部 IP 访问。并重启服务。</p><p>3、每个节点 <code>/etc/postgresql/15/main/postgresql.conf</code> 配置修改</p><blockquote><p>因为不确定故障转移的时候谁会是下一个主节点，全部修改比较保险。</p></blockquote><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># Ensure WAL files contain enough information to enable read-only queries</span></span>
<span class="line"><span style="color:#e1e4e8;"># on the standby.</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;">#  PostgreSQL 9.5 and earlier: one of &#39;hot_standby&#39; or &#39;logical&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">#  PostgreSQL 9.6 and later: one of &#39;replica&#39; or &#39;logical&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">#    (&#39;hot_standby&#39; will still be accepted as an alias for &#39;replica&#39;)</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;"># See: https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-WAL-LEVEL</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">wal_level = &#39;replica&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># Enable WAL file archiving</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;"># See: https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-ARCHIVE-MODE</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">archive_mode = on</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># Set archive command to a dummy command; this can later be changed without</span></span>
<span class="line"><span style="color:#e1e4e8;"># needing to restart the PostgreSQL instance.</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;"># See: https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-ARCHIVE-COMMAND</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#archive_command = &#39;/bin/true&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_command = &#39;{ sleep 5; true; }&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># Enable replication connections; set this value to at least one more</span></span>
<span class="line"><span style="color:#e1e4e8;"># than the number of standbys which will connect to this server</span></span>
<span class="line"><span style="color:#e1e4e8;"># (note that repmgr will execute &quot;pg_basebackup&quot; in WAL streaming mode,</span></span>
<span class="line"><span style="color:#e1e4e8;"># which requires two free WAL senders).</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;"># See: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-MAX-WAL-SENDERS</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">max_wal_senders = 10</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># If using replication slots, set this value to at least one more</span></span>
<span class="line"><span style="color:#e1e4e8;"># than the number of standbys which will connect to this server.</span></span>
<span class="line"><span style="color:#e1e4e8;"># Note that repmgr will only make use of replication slots if</span></span>
<span class="line"><span style="color:#e1e4e8;"># &quot;use_replication_slots&quot; is set to &quot;true&quot; in &quot;repmgr.conf&quot;.</span></span>
<span class="line"><span style="color:#e1e4e8;"># (If you are not intending to use replication slots, this value</span></span>
<span class="line"><span style="color:#e1e4e8;"># can be set to &quot;0&quot;).</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;"># See: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-MAX-REPLICATION-SLOTS</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">max_replication_slots = 10</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># Enable read-only queries on a standby</span></span>
<span class="line"><span style="color:#e1e4e8;"># (Note: this will be ignored on a primary but we recommend including</span></span>
<span class="line"><span style="color:#e1e4e8;"># it anyway, in case the primary later becomes a standby)</span></span>
<span class="line"><span style="color:#e1e4e8;">#</span></span>
<span class="line"><span style="color:#e1e4e8;"># See: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-HOT-STANDBY</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">hot_standby = on</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># Ensure WAL files contain enough information to enable read-only queries</span></span>
<span class="line"><span style="color:#24292e;"># on the standby.</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;">#  PostgreSQL 9.5 and earlier: one of &#39;hot_standby&#39; or &#39;logical&#39;</span></span>
<span class="line"><span style="color:#24292e;">#  PostgreSQL 9.6 and later: one of &#39;replica&#39; or &#39;logical&#39;</span></span>
<span class="line"><span style="color:#24292e;">#    (&#39;hot_standby&#39; will still be accepted as an alias for &#39;replica&#39;)</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;"># See: https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-WAL-LEVEL</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">wal_level = &#39;replica&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># Enable WAL file archiving</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;"># See: https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-ARCHIVE-MODE</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">archive_mode = on</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># Set archive command to a dummy command; this can later be changed without</span></span>
<span class="line"><span style="color:#24292e;"># needing to restart the PostgreSQL instance.</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;"># See: https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-ARCHIVE-COMMAND</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#archive_command = &#39;/bin/true&#39;</span></span>
<span class="line"><span style="color:#24292e;">archive_command = &#39;{ sleep 5; true; }&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># Enable replication connections; set this value to at least one more</span></span>
<span class="line"><span style="color:#24292e;"># than the number of standbys which will connect to this server</span></span>
<span class="line"><span style="color:#24292e;"># (note that repmgr will execute &quot;pg_basebackup&quot; in WAL streaming mode,</span></span>
<span class="line"><span style="color:#24292e;"># which requires two free WAL senders).</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;"># See: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-MAX-WAL-SENDERS</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">max_wal_senders = 10</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># If using replication slots, set this value to at least one more</span></span>
<span class="line"><span style="color:#24292e;"># than the number of standbys which will connect to this server.</span></span>
<span class="line"><span style="color:#24292e;"># Note that repmgr will only make use of replication slots if</span></span>
<span class="line"><span style="color:#24292e;"># &quot;use_replication_slots&quot; is set to &quot;true&quot; in &quot;repmgr.conf&quot;.</span></span>
<span class="line"><span style="color:#24292e;"># (If you are not intending to use replication slots, this value</span></span>
<span class="line"><span style="color:#24292e;"># can be set to &quot;0&quot;).</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;"># See: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-MAX-REPLICATION-SLOTS</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">max_replication_slots = 10</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># Enable read-only queries on a standby</span></span>
<span class="line"><span style="color:#24292e;"># (Note: this will be ignored on a primary but we recommend including</span></span>
<span class="line"><span style="color:#24292e;"># it anyway, in case the primary later becomes a standby)</span></span>
<span class="line"><span style="color:#24292e;">#</span></span>
<span class="line"><span style="color:#24292e;"># See: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-HOT-STANDBY</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">hot_standby = on</span></span></code></pre></div><p>4、主节点创建 repmgr 用户以及数据库来保存集群元数据</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 先切换到 postgres 用户</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">su</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~</span></span>
<span class="line"><span style="color:#6A737D;"># 再创建用户</span></span>
<span class="line"><span style="color:#B392F0;">createuser</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">createdb</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-O</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 先切换到 postgres 用户</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">su</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~</span></span>
<span class="line"><span style="color:#6A737D;"># 再创建用户</span></span>
<span class="line"><span style="color:#6F42C1;">createuser</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">createdb</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-O</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span></span></code></pre></div><p>5、编辑 <code>/etc/postgresql/15/main/pg_hba.conf</code>，为 repmgr 用户添加访问权限</p><blockquote><p>主从节点都需要，因为从节点克隆主节点的数据会将 repmgr 用户和库一同克隆。</p></blockquote><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">local repmgr repmgr trust</span></span>
<span class="line"><span style="color:#e1e4e8;">host repmgr repmgr 127.0.0.1/32 trust</span></span>
<span class="line"><span style="color:#e1e4e8;">host repmgr repmgr 0.0.0.0/0 trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">local repmgr repmgr trust</span></span>
<span class="line"><span style="color:#24292e;">host repmgr repmgr 127.0.0.1/32 trust</span></span>
<span class="line"><span style="color:#24292e;">host repmgr repmgr 0.0.0.0/0 trust</span></span></code></pre></div><blockquote><p>上述配置是在测试环境下的，如果生产环境配置最好限制可远程访问的 IP 段，例如 <code>192.168.1.0/24</code>。</p></blockquote><p>6、在主节点下创建 <code>repmgr.conf</code> 配置 <code>/etc/repmgr.conf</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">node_id=1</span></span>
<span class="line"><span style="color:#e1e4e8;">node_name=&#39;node1&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">conninfo=&#39;host=192.168.111.12 user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">node_id=1</span></span>
<span class="line"><span style="color:#24292e;">node_name=&#39;node1&#39;</span></span>
<span class="line"><span style="color:#24292e;">conninfo=&#39;host=192.168.111.12 user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#24292e;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span></code></pre></div><blockquote><p><code>repmgr.conf</code> should <em><strong>not</strong></em> be stored inside the PostgreSQL data directory, as it could be overwritten when setting up or reinitialising the PostgreSQL server.</p></blockquote><p>7、主节点注册到 repmgr</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database...</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attempting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">extension</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr&quot;</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">extension</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">installed</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">record</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) registered</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 检查节点信息</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">show</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database...</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attempting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">extension</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">extension</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully</span><span style="color:#24292E;"> </span><span style="color:#032F62;">installed</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">record</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) registered</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 检查节点信息</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">show</span></span></code></pre></div><p>9、从节点准备</p><p>9.1、安装 PG-15 和 postgresql-15-repmgr</p><p>9.2、停止 PG-15，编辑 <code>postgresql.conf</code> 开启远程监听，编辑 <code>pg_hba.conf</code> 允许用于远程访问</p><p>9.3、将数据目录 <code>/var/lib/postgresql/15/main</code> 备份到 <code>/var/lib/postgresql/15/backup</code> ，新建 main 文件夹，存放从主节点 clone 的数据。注意新建的 main 文件夹的用户和用户组设置为 <code>postgres</code></p><blockquote><p><strong>Note</strong></p><p>On the standby, do <em><strong>not</strong></em> create a PostgreSQL instance (i.e. do not execute initdb or any database creation scripts provided by packages), but do ensure the destination data directory (and any other directories which you want PostgreSQL to use) exist and are owned by the <code>postgres</code> system user. Permissions must be set to <code>0700</code> (<code>drwx------</code>).</p><p><strong>Because</strong></p><p>repmgr will place a copy of the primary&#39;s database files in this directory. It will however refuse to run if a PostgreSQL instance has already been created there.</p></blockquote><p>使用 psql 命令检查从节点是否可访问到主节点</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">psql</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;host=&lt;node1-host&gt; user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">psql</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;host=&lt;node1-host&gt; user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span></code></pre></div><p>9.4、创建配置 <code>/etc/repmgr.conf</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">node_id=2</span></span>
<span class="line"><span style="color:#e1e4e8;">node_name=&#39;node2&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">conninfo=&#39;host=192.168.111.12 user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">node_id=2</span></span>
<span class="line"><span style="color:#24292e;">node_name=&#39;node2&#39;</span></span>
<span class="line"><span style="color:#24292e;">conninfo=&#39;host=192.168.111.12 user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#24292e;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span></code></pre></div><p>9.5、使用 <code>--dry-run</code> 参数检查是否可以从主节点复制</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">node1-hos</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clone</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--dry-run</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">destination</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">directory</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/postgresql/15/main&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">provided</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">string</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.12</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user=repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dbname=repmgr</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">installation</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">size</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">37</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">extension</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">installed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">slot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">usage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">requested</span><span style="color:#E1E4E8;">;  </span><span style="color:#B392F0;">no</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">slot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">parameter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;max_wal_senders&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">walsenders</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> (2 </span><span style="color:#9ECBFF;">required</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sufficient</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">walsenders</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">required,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">made</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> (2 </span><span style="color:#9ECBFF;">required</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">required</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">number</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">could</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">made</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">required</span></span>
<span class="line"><span style="color:#B392F0;">WARNING:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checksums</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enabled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wal_log_hints&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;off&quot;</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rewind</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">requires</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wal_log_hints&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enabled</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attach</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#B392F0;">HINT:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">consider</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">using</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c/--fast-checkpoint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">option</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">would</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">execute:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pg_basebackup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr base backup&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/15/main</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.12</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stream</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">all</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">prerequisites</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;standby clone&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">met</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">node1-hos</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clone</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--dry-run</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">destination</span><span style="color:#24292E;"> </span><span style="color:#032F62;">directory</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/postgresql/15/main&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">provided</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">string</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.12</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user=repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dbname=repmgr</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">installation</span><span style="color:#24292E;"> </span><span style="color:#032F62;">size</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">37</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">extension</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">installed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">slot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">usage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">requested</span><span style="color:#24292E;">;  </span><span style="color:#6F42C1;">no</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">slot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">parameter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;max_wal_senders&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available</span><span style="color:#24292E;"> </span><span style="color:#032F62;">walsenders</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> (2 </span><span style="color:#032F62;">required</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sufficient</span><span style="color:#24292E;"> </span><span style="color:#032F62;">walsenders</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">required,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">made</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> (2 </span><span style="color:#032F62;">required</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">required</span><span style="color:#24292E;"> </span><span style="color:#032F62;">number</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span><span style="color:#24292E;"> </span><span style="color:#032F62;">could</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">made</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span><span style="color:#24292E;"> </span><span style="color:#032F62;">required</span></span>
<span class="line"><span style="color:#6F42C1;">WARNING:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checksums</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enabled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wal_log_hints&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;off&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rewind</span><span style="color:#24292E;"> </span><span style="color:#032F62;">requires</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wal_log_hints&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enabled</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attach</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upstream</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#6F42C1;">HINT:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">consider</span><span style="color:#24292E;"> </span><span style="color:#032F62;">using</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c/--fast-checkpoint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">option</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">would</span><span style="color:#24292E;"> </span><span style="color:#032F62;">execute:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pg_basebackup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr base backup&quot;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/15/main</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.12</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stream</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">all</span><span style="color:#24292E;"> </span><span style="color:#032F62;">prerequisites</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;standby clone&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">met</span></span></code></pre></div><blockquote><p>可能会提示：<code>no pg_hba.conf entry for replication connection from host ...</code>，配置 <code>pg_hba.conf</code>：</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">host replication all 0.0.0.0/0 trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">host replication all 0.0.0.0/0 trust</span></span></code></pre></div><p>同样的，生产环境下注意缩小 IP 访问范围。</p></blockquote><p>9.6、如果上述步骤无误，则直接从主节点克隆数据</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">node1-hos</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clone</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">destination</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">directory</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/postgresql/15/main&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">provided</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">string</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.12</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user=repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dbname=repmgr</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">installation</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">size</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">37</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">slot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">usage</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">requested</span><span style="color:#E1E4E8;">;  </span><span style="color:#B392F0;">no</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">slot</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">up</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">walsenders</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> (2 </span><span style="color:#9ECBFF;">required</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">made</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> (2 </span><span style="color:#9ECBFF;">required</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">WARNING:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checksums</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enabled</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wal_log_hints&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;off&quot;</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_rewind</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">requires</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wal_log_hints&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enabled</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">creating</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">directory</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/postgresql/15/main&quot;...</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">starting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup</span><span style="color:#E1E4E8;"> (using </span><span style="color:#9ECBFF;">pg_basebackup</span><span style="color:#E1E4E8;">)...</span></span>
<span class="line"><span style="color:#B392F0;">HINT:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">may</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">take</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">some</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">time</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">consider</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">using</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c/--fast-checkpoint</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">option</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">executing:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">pg_basebackup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-l</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr base backup&quot;</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/15/main</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.12</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stream</span></span>
<span class="line"><span style="color:#B392F0;">could</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">change</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">directory</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/home/gnl&quot;:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Permission</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">denied</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clone</span><span style="color:#E1E4E8;"> (using </span><span style="color:#9ECBFF;">pg_basebackup</span><span style="color:#E1E4E8;">) complete</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PostgreSQL</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span></span>
<span class="line"><span style="color:#B392F0;">HINT:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">example:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_ctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/15/main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span></span>
<span class="line"><span style="color:#B392F0;">HINT:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">after</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">starting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">need</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr standby register&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">node1-hos</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clone</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">destination</span><span style="color:#24292E;"> </span><span style="color:#032F62;">directory</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/postgresql/15/main&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">provided</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">string</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.12</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user=repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dbname=repmgr</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">installation</span><span style="color:#24292E;"> </span><span style="color:#032F62;">size</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">37</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">slot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">usage</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">requested</span><span style="color:#24292E;">;  </span><span style="color:#6F42C1;">no</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">slot</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">up</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available</span><span style="color:#24292E;"> </span><span style="color:#032F62;">walsenders</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> (2 </span><span style="color:#032F62;">required</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">made</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> (2 </span><span style="color:#032F62;">required</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">WARNING:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checksums</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enabled</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wal_log_hints&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;off&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_rewind</span><span style="color:#24292E;"> </span><span style="color:#032F62;">requires</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wal_log_hints&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enabled</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">creating</span><span style="color:#24292E;"> </span><span style="color:#032F62;">directory</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/postgresql/15/main&quot;...</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">starting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup</span><span style="color:#24292E;"> (using </span><span style="color:#032F62;">pg_basebackup</span><span style="color:#24292E;">)...</span></span>
<span class="line"><span style="color:#6F42C1;">HINT:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">may</span><span style="color:#24292E;"> </span><span style="color:#032F62;">take</span><span style="color:#24292E;"> </span><span style="color:#032F62;">some</span><span style="color:#24292E;"> </span><span style="color:#032F62;">time</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">consider</span><span style="color:#24292E;"> </span><span style="color:#032F62;">using</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c/--fast-checkpoint</span><span style="color:#24292E;"> </span><span style="color:#032F62;">option</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">executing:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">pg_basebackup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-l</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr base backup&quot;</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/15/main</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.12</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stream</span></span>
<span class="line"><span style="color:#6F42C1;">could</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">change</span><span style="color:#24292E;"> </span><span style="color:#032F62;">directory</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/home/gnl&quot;:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Permission</span><span style="color:#24292E;"> </span><span style="color:#032F62;">denied</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clone</span><span style="color:#24292E;"> (using </span><span style="color:#032F62;">pg_basebackup</span><span style="color:#24292E;">) complete</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PostgreSQL</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span></span>
<span class="line"><span style="color:#6F42C1;">HINT:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">example:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_ctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/15/main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span></span>
<span class="line"><span style="color:#6F42C1;">HINT:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">after</span><span style="color:#24292E;"> </span><span style="color:#032F62;">starting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">need</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr standby register&quot;</span></span></code></pre></div><blockquote><ol><li>可以看到熟悉的 <code>pg_basebackup</code> 命令，实际上 repmgr 底层就是使用 <code>pg_basebackup</code> 命令来帮助从节点克隆数据的。</li><li>从提示可以看到 <code>NOTICE: you can now start your PostgreSQL server</code></li><li>从提示可以看到 <code>HINT: after starting the server, you need to register this standby with &quot;repmgr standby register&quot;</code></li></ol></blockquote><p>9.7、从节点编辑 repmgr 用户远程访问权限</p><blockquote><p>主从节点切换会使用到，如果前面编辑过了可以跳过这一步。</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">trust</span></span>
<span class="line"><span style="color:#B392F0;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1/32</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">trust</span></span>
<span class="line"><span style="color:#B392F0;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0.0</span><span style="color:#9ECBFF;">.0.0/0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">trust</span></span>
<span class="line"><span style="color:#6F42C1;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1/32</span><span style="color:#24292E;"> </span><span style="color:#032F62;">trust</span></span>
<span class="line"><span style="color:#6F42C1;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0.0</span><span style="color:#032F62;">.0.0/0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">trust</span></span></code></pre></div><p>9.8、启动从节点上的 PG</p><p>10、主从节点状态查询</p><p>启动完成后在主节点查询</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# \\x</span></span>
<span class="line"><span style="color:#e1e4e8;">Expanded display is on.</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# SELECT * FROM pg_stat_replication;</span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 1 ]----+------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">pid              | 6011</span></span>
<span class="line"><span style="color:#e1e4e8;">usesysid         | 16388</span></span>
<span class="line"><span style="color:#e1e4e8;">usename          | repmgr</span></span>
<span class="line"><span style="color:#e1e4e8;">application_name | node2</span></span>
<span class="line"><span style="color:#e1e4e8;">client_addr      | 192.168.111.11</span></span>
<span class="line"><span style="color:#e1e4e8;">client_hostname  |</span></span>
<span class="line"><span style="color:#e1e4e8;">client_port      | 56912</span></span>
<span class="line"><span style="color:#e1e4e8;">backend_start    | 2023-10-16 14:02:30.04542+08</span></span>
<span class="line"><span style="color:#e1e4e8;">backend_xmin     |</span></span>
<span class="line"><span style="color:#e1e4e8;">state            | streaming</span></span>
<span class="line"><span style="color:#e1e4e8;">sent_lsn         | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">write_lsn        | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">flush_lsn        | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">replay_lsn       | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">write_lag        |</span></span>
<span class="line"><span style="color:#e1e4e8;">flush_lag        |</span></span>
<span class="line"><span style="color:#e1e4e8;">replay_lag       |</span></span>
<span class="line"><span style="color:#e1e4e8;">sync_priority    | 0</span></span>
<span class="line"><span style="color:#e1e4e8;">sync_state       | async</span></span>
<span class="line"><span style="color:#e1e4e8;">reply_time       | 2023-10-16 14:03:05.786353+08</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# \\x</span></span>
<span class="line"><span style="color:#24292e;">Expanded display is on.</span></span>
<span class="line"><span style="color:#24292e;">postgres=# SELECT * FROM pg_stat_replication;</span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 1 ]----+------------------------------</span></span>
<span class="line"><span style="color:#24292e;">pid              | 6011</span></span>
<span class="line"><span style="color:#24292e;">usesysid         | 16388</span></span>
<span class="line"><span style="color:#24292e;">usename          | repmgr</span></span>
<span class="line"><span style="color:#24292e;">application_name | node2</span></span>
<span class="line"><span style="color:#24292e;">client_addr      | 192.168.111.11</span></span>
<span class="line"><span style="color:#24292e;">client_hostname  |</span></span>
<span class="line"><span style="color:#24292e;">client_port      | 56912</span></span>
<span class="line"><span style="color:#24292e;">backend_start    | 2023-10-16 14:02:30.04542+08</span></span>
<span class="line"><span style="color:#24292e;">backend_xmin     |</span></span>
<span class="line"><span style="color:#24292e;">state            | streaming</span></span>
<span class="line"><span style="color:#24292e;">sent_lsn         | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">write_lsn        | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">flush_lsn        | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">replay_lsn       | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">write_lag        |</span></span>
<span class="line"><span style="color:#24292e;">flush_lag        |</span></span>
<span class="line"><span style="color:#24292e;">replay_lag       |</span></span>
<span class="line"><span style="color:#24292e;">sync_priority    | 0</span></span>
<span class="line"><span style="color:#24292e;">sync_state       | async</span></span>
<span class="line"><span style="color:#24292e;">reply_time       | 2023-10-16 14:03:05.786353+08</span></span></code></pre></div><p>可以看到有一个 node2 节点已经连接上来了。</p><p>在从库查询 wal receiver 状态：</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# SELECT * FROM pg_stat_wal_receiver;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 1 ]---------+</span></span>
<span class="line"><span style="color:#e1e4e8;">pid                   | 21444</span></span>
<span class="line"><span style="color:#e1e4e8;">status                | streaming</span></span>
<span class="line"><span style="color:#e1e4e8;">receive_start_lsn     | 0/B000000</span></span>
<span class="line"><span style="color:#e1e4e8;">receive_start_tli     | 1</span></span>
<span class="line"><span style="color:#e1e4e8;">written_lsn           | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">flushed_lsn           | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">received_tli          | 1</span></span>
<span class="line"><span style="color:#e1e4e8;">last_msg_send_time    | 2023-10-16 14:04:35.904542+08</span></span>
<span class="line"><span style="color:#e1e4e8;">last_msg_receipt_time | 2023-10-16 14:04:35.880378+08</span></span>
<span class="line"><span style="color:#e1e4e8;">latest_end_lsn        | 0/B000368</span></span>
<span class="line"><span style="color:#e1e4e8;">latest_end_time       | 2023-10-16 14:02:30.053889+08</span></span>
<span class="line"><span style="color:#e1e4e8;">slot_name             |</span></span>
<span class="line"><span style="color:#e1e4e8;">sender_host           | 192.168.111.12</span></span>
<span class="line"><span style="color:#e1e4e8;">sender_port           | 5432</span></span>
<span class="line"><span style="color:#e1e4e8;">conninfo              | user=repmgr passfile=/var/lib/postgresql/.pgpass</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# SELECT * FROM pg_stat_wal_receiver;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 1 ]---------+</span></span>
<span class="line"><span style="color:#24292e;">pid                   | 21444</span></span>
<span class="line"><span style="color:#24292e;">status                | streaming</span></span>
<span class="line"><span style="color:#24292e;">receive_start_lsn     | 0/B000000</span></span>
<span class="line"><span style="color:#24292e;">receive_start_tli     | 1</span></span>
<span class="line"><span style="color:#24292e;">written_lsn           | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">flushed_lsn           | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">received_tli          | 1</span></span>
<span class="line"><span style="color:#24292e;">last_msg_send_time    | 2023-10-16 14:04:35.904542+08</span></span>
<span class="line"><span style="color:#24292e;">last_msg_receipt_time | 2023-10-16 14:04:35.880378+08</span></span>
<span class="line"><span style="color:#24292e;">latest_end_lsn        | 0/B000368</span></span>
<span class="line"><span style="color:#24292e;">latest_end_time       | 2023-10-16 14:02:30.053889+08</span></span>
<span class="line"><span style="color:#24292e;">slot_name             |</span></span>
<span class="line"><span style="color:#24292e;">sender_host           | 192.168.111.12</span></span>
<span class="line"><span style="color:#24292e;">sender_port           | 5432</span></span>
<span class="line"><span style="color:#24292e;">conninfo              | user=repmgr passfile=/var/lib/postgresql/.pgpass</span></span></code></pre></div><p>11、将从节点注册到 repmgr 上</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">database</span></span>
<span class="line"><span style="color:#B392F0;">WARNING:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--upstream-node-id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">supplied,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">assuming</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> (node </span><span style="color:#9ECBFF;">ID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">registration</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">complete</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) successfully registered</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">database</span></span>
<span class="line"><span style="color:#6F42C1;">WARNING:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--upstream-node-id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">supplied,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">assuming</span><span style="color:#24292E;"> </span><span style="color:#032F62;">upstream</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> (node </span><span style="color:#032F62;">ID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">registration</span><span style="color:#24292E;"> </span><span style="color:#032F62;">complete</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) successfully registered</span></span></code></pre></div><p>12、检查集群状态</p><p>主节点或者从节点</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">show</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">show</span></span></code></pre></div><p><img src="`+o+`" alt="image-20231017135533652"></p><p>可以看到现在我们的集群中有两个节点了。</p><hr><h3 id="主从切换-手动" tabindex="-1">主从切换（手动） <a class="header-anchor" href="#主从切换-手动" aria-label="Permalink to &quot;主从切换（手动）&quot;">​</a></h3><blockquote><p><strong>repmgr 集群正确的启动方式</strong></p><p>如果使用 <code>syetmctl {start|stop|restart} postgresql</code> 或者 <code>service postgresql {start|stop|restart}</code> 在进行集群操作切换到 postrges 用户之后会无权限控制 PostgreSQL 的状态，需要改成使用 <code>pg_ctlcluster 15 main {start|stop|restart|status}</code> 来控制 PostgreSQL。</p></blockquote><p>14、编辑 <code>/etc/repmgr.conf</code>，添加配置</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">service_start_command=&#39;sudo pg_ctlcluster 15 main start&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">service_stop_command=&#39;sudo pg_ctlcluster 15 main stop&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">service_restart_command=&#39;sudo pg_ctlcluster 15 main restart&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">service_reload_command  = &#39;sudo pg_ctlcluster 15 main reload&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">service_start_command=&#39;sudo pg_ctlcluster 15 main start&#39;</span></span>
<span class="line"><span style="color:#24292e;">service_stop_command=&#39;sudo pg_ctlcluster 15 main stop&#39;</span></span>
<span class="line"><span style="color:#24292e;">service_restart_command=&#39;sudo pg_ctlcluster 15 main restart&#39;</span></span>
<span class="line"><span style="color:#24292e;">service_reload_command  = &#39;sudo pg_ctlcluster 15 main reload&#39;</span></span></code></pre></div><p>为 postgres 用户添加权限，<code>sudo vim /etc/sudoers</code></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Defaults:postgres !requiretty</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main start</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main stop</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main restart</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Defaults:postgres !requiretty</span></span>
<span class="line"><span style="color:#24292e;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main start</span></span>
<span class="line"><span style="color:#24292e;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main stop</span></span>
<span class="line"><span style="color:#24292e;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main restart</span></span>
<span class="line"><span style="color:#24292e;">postgres ALL= NOPASSWD: /usr/bin/pg_ctlcluster 15 main reload</span></span></code></pre></div><p>停止所有的 PG 实例，该用 <code>pg_ctlcluster</code> 来启动。</p><p>15、主从节点无密码 SSH 连接配置</p><blockquote><p>root 和 postgres 用户都需要设置，主从节点需要双向配置（主节点 SSH 无密码连接从节点，从节点 SSH 无密码连接主节点）</p></blockquote><p>15.1、生成 SSH</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#B392F0;">ssh-keygen</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/.ssh</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">id_dsa.pub</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root_authorized_keys</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#B392F0;">ssh-keygen</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa</span></span>
<span class="line"><span style="color:#79B8FF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/.ssh</span></span>
<span class="line"><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">id_dsa.pub</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_authorized_keys</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#6F42C1;">ssh-keygen</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/.ssh</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">id_dsa.pub</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root_authorized_keys</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#6F42C1;">ssh-keygen</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa</span></span>
<span class="line"><span style="color:#005CC5;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/.ssh</span></span>
<span class="line"><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">id_dsa.pub</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_authorized_keys</span></span></code></pre></div><p>15.2、传输到服务器上（传输到需要无密码登录的机器上）</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">scp</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/.ssh/root_authorized_keys</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user@server_addr:/home/user</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 目标服务器</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/home/user/root_authorized_keys</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/root/.ssh/authorized_keys</span></span>
<span class="line"><span style="color:#B392F0;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/home/user/pg_authorized_keys</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/.ssh/authorized_keys</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">scp</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/.ssh/root_authorized_keys</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user@server_addr:/home/user</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 目标服务器</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/home/user/root_authorized_keys</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/root/.ssh/authorized_keys</span></span>
<span class="line"><span style="color:#6F42C1;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/home/user/pg_authorized_keys</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/.ssh/authorized_keys</span></span></code></pre></div><blockquote><p>如果知道登录用户的密码</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">ssh-keygen</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-t</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rsa</span></span>
<span class="line"><span style="color:#B392F0;">ssh-copy-id</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user@server_address</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#6A737D;"># 会传输保存到到对应账户的 \`~/.ssh/authorized_keys\` 中。</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">ssh-keygen</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-t</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rsa</span></span>
<span class="line"><span style="color:#6F42C1;">ssh-copy-id</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user@server_address</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#6A737D;"># 会传输保存到到对应账户的 \`~/.ssh/authorized_keys\` 中。</span></span></code></pre></div></blockquote><p>15.3、配置服务器 SSH 允许无密码登录</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/ssh/sshd_config</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/ssh/sshd_config</span></span></code></pre></div><p>修改</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">PasswordAuthentication no</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">PasswordAuthentication no</span></span></code></pre></div><p>15.4、重启 SSH 服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sshd</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sshd</span></span></code></pre></div><p>15.5、登录测试</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">ssh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user@server_address</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">ssh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user@server_address</span></span></code></pre></div><p>如果有两台服务器192.168.111.11 和 192.168.111.12，两台服务器都需要能成功执行以下命令</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 192.168.111.11</span></span>
<span class="line"><span style="color:#B392F0;">root:~</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root@192.168.111.12</span></span>
<span class="line"><span style="color:#B392F0;">postgres:~</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres@192.168.111.12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 192.168.111.12</span></span>
<span class="line"><span style="color:#B392F0;">root:~</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root@192.168.111.11</span></span>
<span class="line"><span style="color:#B392F0;">postgres:~</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ssh</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres@192.168.111.11</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 192.168.111.11</span></span>
<span class="line"><span style="color:#6F42C1;">root:~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root@192.168.111.12</span></span>
<span class="line"><span style="color:#6F42C1;">postgres:~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres@192.168.111.12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 192.168.111.12</span></span>
<span class="line"><span style="color:#6F42C1;">root:~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root@192.168.111.11</span></span>
<span class="line"><span style="color:#6F42C1;">postgres:~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ssh</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres@192.168.111.11</span></span></code></pre></div><p>无需密码证明配置成功。</p><p>16、停止 PG node1，模拟宕机</p><p>17、使用 <code>–dry-run</code> 尝试将 node2 迁移为 primary</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--dry-run</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> --dry-run mode</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SSH</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;192.168.111.11&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">succeeded</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">able</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">execute</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;repmgr&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">remote</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">host</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;192.168.111.11&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">walsenders</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">required,</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">available</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demotion</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">candidate</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">able</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">make</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">promotion</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">candidate</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pending</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">archive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">files</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">replication</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">this</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">seconds</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attempting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pause</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) would be promoted to primary; </span><span style="color:#B392F0;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) would be demoted to standby</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">shutdown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">would</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&quot;sudo pg_ctlcluster 15 main stop&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">parameter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;shutdown_check_timeout&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">set</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">seconds</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">prerequisites</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">executing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">STANDBY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SWITCHOVER</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">met</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--dry-run</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> --dry-run mode</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SSH</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;192.168.111.11&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">succeeded</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">able</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">execute</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;repmgr&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">remote</span><span style="color:#24292E;"> </span><span style="color:#032F62;">host</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;192.168.111.11&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">walsenders</span><span style="color:#24292E;"> </span><span style="color:#032F62;">required,</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">available</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demotion</span><span style="color:#24292E;"> </span><span style="color:#032F62;">candidate</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">able</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">make</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">promotion</span><span style="color:#24292E;"> </span><span style="color:#032F62;">candidate</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pending</span><span style="color:#24292E;"> </span><span style="color:#032F62;">archive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">files</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">replication</span><span style="color:#24292E;"> </span><span style="color:#032F62;">lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">this</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">seconds</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attempting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pause</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgrd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) would be promoted to primary; </span><span style="color:#6F42C1;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) would be demoted to standby</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">shutdown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">would</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;sudo pg_ctlcluster 15 main stop&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">parameter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;shutdown_check_timeout&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">set</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span><span style="color:#24292E;"> </span><span style="color:#032F62;">seconds</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">prerequisites</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">executing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">STANDBY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SWITCHOVER</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">met</span></span></code></pre></div><p>18、standby 切换为 primary（需要在 standby 机器上操作）</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span></span></code></pre></div><p>报提示 <code>NOTICE: waiting up to 30 seconds (parameter &quot;wal_receive_check_timeout&quot;) for received WAL to flush to disk</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">NOTICE: waiting up to 30 seconds (parameter &quot;wal_receive_check_timeout&quot;) for received WAL to flush to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">INFO: sleeping 1 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">INFO: sleeping 2 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">INFO: sleeping 3 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">INFO: sleeping 4 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">INFO: sleeping 5 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">...</span></span>
<span class="line"><span style="color:#e1e4e8;">INFO: sleeping 30 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#e1e4e8;">WARNING: local node &quot;node2&quot; is behind shutdown primary &quot;node1&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">DETAIL: local node last receive LSN is 0/5BA0000, primary shutdown checkpoint LSN is 0/6000028</span></span>
<span class="line"><span style="color:#e1e4e8;">NOTICE: aborting switchover</span></span>
<span class="line"><span style="color:#e1e4e8;">HINT: use --always-promote to force promotion of standby</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">NOTICE: waiting up to 30 seconds (parameter &quot;wal_receive_check_timeout&quot;) for received WAL to flush to disk</span></span>
<span class="line"><span style="color:#24292e;">INFO: sleeping 1 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#24292e;">INFO: sleeping 2 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#24292e;">INFO: sleeping 3 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#24292e;">INFO: sleeping 4 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#24292e;">INFO: sleeping 5 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#24292e;">...</span></span>
<span class="line"><span style="color:#24292e;">INFO: sleeping 30 of maximum 30 seconds waiting for standby to flush received WAL to disk</span></span>
<span class="line"><span style="color:#24292e;">WARNING: local node &quot;node2&quot; is behind shutdown primary &quot;node1&quot;</span></span>
<span class="line"><span style="color:#24292e;">DETAIL: local node last receive LSN is 0/5BA0000, primary shutdown checkpoint LSN is 0/6000028</span></span>
<span class="line"><span style="color:#24292e;">NOTICE: aborting switchover</span></span>
<span class="line"><span style="color:#24292e;">HINT: use --always-promote to force promotion of standby</span></span></code></pre></div><p>主从节点修改 <code>postgresql.conf</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">archive_command = &#39;{ sleep 5; true; }&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">archive_command = &#39;{ sleep 5; true; }&#39;</span></span></code></pre></div><p><code>pg_ctlcluster</code> 重启主从节点，再次尝试</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">executing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attempting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pause</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">local</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) will be promoted to primary; </span><span style="color:#B392F0;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) will be demoted to standby</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stopping</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">issuing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CHECKPOINT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">executing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;sudo pg_ctlcluster 15 main stop&quot;</span></span>
<span class="line"><span style="color:#B392F0;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">checking</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">shutdown</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">60</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attempts</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&quot;shutdown_check_timeout&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">been</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cleanly</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">shut</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">down</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">/13000028</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">promoting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">promoting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) using </span><span style="color:#B392F0;">pg_promote</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">NOTICE: waiting up to 60 seconds (</span><span style="color:#B392F0;">parameter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;promote_check_timeout&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> promotion to complete</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">STANDBY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PROMOTE</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successful</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">server</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) was successfully promoted to primary</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (ID: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) promoted to primary, node </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) demoted to standby</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">was</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successful</span></span>
<span class="line"><span style="color:#B392F0;">DETAIL:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">and</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">attached</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span></span>
<span class="line"><span style="color:#B392F0;">NOTICE:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">STANDBY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">SWITCHOVER</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">completed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">executing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attempting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pause</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgrd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">local</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) will be promoted to primary; </span><span style="color:#6F42C1;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) will be demoted to standby</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stopping</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">issuing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CHECKPOINT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">executing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;sudo pg_ctlcluster 15 main stop&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">checking</span><span style="color:#24292E;"> </span><span style="color:#032F62;">for</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">shutdown</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">60</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attempts</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&quot;shutdown_check_timeout&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">been</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cleanly</span><span style="color:#24292E;"> </span><span style="color:#032F62;">shut</span><span style="color:#24292E;"> </span><span style="color:#032F62;">down</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at</span><span style="color:#24292E;"> </span><span style="color:#032F62;">location</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#032F62;">/13000028</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">promoting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">promoting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) using </span><span style="color:#6F42C1;">pg_promote</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">NOTICE: waiting up to 60 seconds (</span><span style="color:#6F42C1;">parameter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;promote_check_timeout&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> promotion to complete</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">STANDBY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PROMOTE</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successful</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">server</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) was successfully promoted to primary</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (ID: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) promoted to primary, node </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) demoted to standby</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#032F62;">was</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successful</span></span>
<span class="line"><span style="color:#6F42C1;">DETAIL:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">and</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">is</span><span style="color:#24292E;"> </span><span style="color:#032F62;">attached</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span></span>
<span class="line"><span style="color:#6F42C1;">NOTICE:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">STANDBY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">SWITCHOVER</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">completed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully</span></span></code></pre></div><p>19、切换成功，查看集群状态</p><p><img src="`+e+`" alt="image-20231017091905095"></p><p>20、如果显示 <code>primary | ! running as standby</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">show</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Name</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Status</span><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Location</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Priority</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Timeline</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">string</span></span>
<span class="line"><span style="color:#B392F0;">----+-------+---------+----------------------+----------+----------+----------+----------+-----------------------------------------------------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">default</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">100</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> host</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.12</span><span style="color:#E1E4E8;"> user</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> dbname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> connect_timeout</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">node2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">default</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">100</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> host</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.11</span><span style="color:#E1E4E8;"> user</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> dbname</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> connect_timeout</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">show</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Name</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Status</span><span style="color:#24292E;">               </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Upstream</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Location</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Priority</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Timeline</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">string</span></span>
<span class="line"><span style="color:#6F42C1;">----+-------+---------+----------------------+----------+----------+----------+----------+-----------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">node1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">primary</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">default</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">100</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> host</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.12</span><span style="color:#24292E;"> user</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> dbname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> connect_timeout</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">node2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">primary</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">default</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">100</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> host</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.11</span><span style="color:#24292E;"> user</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> dbname</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> connect_timeout</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span></span></code></pre></div><p>则需要将 node1 以 standby 的身份重新加入集群</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--force</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">standby</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--force</span></span></code></pre></div><p>如果加入失败，则说明可能 node1 和 node 2 的数据不同步</p><ol><li>停止 node2，将 node2 的数据备份，重新从 node1 克隆。</li><li>启动 node2，以 standby 的身份重新加入集群。</li></ol><p>…</p><hr><h3 id="自动切换-repmgrd" tabindex="-1">自动切换 repmgrd <a class="header-anchor" href="#自动切换-repmgrd" aria-label="Permalink to &quot;自动切换 repmgrd&quot;">​</a></h3><blockquote><p>上面展示的主从切换需要人为干预，通常情况下我们不一定能在主节点宕机的第一时间就感知到，并完成迅速切换，此时就需要配置自动切换。</p></blockquote><blockquote><p>repmgrd（<em>replication manager daemon</em>） 是一个管理和监控守护进程，运行在 PostgreSQL 集群的每个节点上,可以自动执行故障转移和更新备用节点等操作以跟上新的主节点，并提供关于每个备用服务器状态的监视信息。</p></blockquote><p>21、在每个节点上创建 repmgrd 的 systemd 配置文件 <code>/etc/systemd/system/repmgrd.service</code></p><blockquote><p>有两个位置需要注意 ExecStart 中定义的 repmgrd 命令的位置，repmgr 配置文件的位置，pid 文件的位置</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[Unit]</span></span>
<span class="line"><span style="color:#E1E4E8;">Description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">repmgrd.service</span></span>
<span class="line"><span style="color:#6A737D;">#After=syslog.target</span></span>
<span class="line"><span style="color:#E1E4E8;">After</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">network.target</span></span>
<span class="line"><span style="color:#6A737D;">#After=pgserver.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="color:#E1E4E8;">Type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">forking</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">User</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">Group</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Where to send early-startup messages from the server</span></span>
<span class="line"><span style="color:#6A737D;"># This is normally controlled by the global default set by systemd</span></span>
<span class="line"><span style="color:#6A737D;"># StandardOutput=syslog</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/bin/repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/tmp/repmgrd.pid</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--verbose</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStop</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/bin/kill</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">\`</span><span style="color:#B392F0;">cat</span><span style="color:#9ECBFF;"> /tmp/repmgrd.pid\`</span></span>
<span class="line"><span style="color:#E1E4E8;">PrivateTmp</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#6A737D;"># Give a reasonable amount of time for the server to start up/shut down</span></span>
<span class="line"><span style="color:#E1E4E8;">TimeoutSec</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">300</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">[Install]</span></span>
<span class="line"><span style="color:#E1E4E8;">WantedBy</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">multi-user.target</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[Unit]</span></span>
<span class="line"><span style="color:#24292E;">Description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">repmgrd.service</span></span>
<span class="line"><span style="color:#6A737D;">#After=syslog.target</span></span>
<span class="line"><span style="color:#24292E;">After</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">network.target</span></span>
<span class="line"><span style="color:#6A737D;">#After=pgserver.service</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[Service]</span></span>
<span class="line"><span style="color:#24292E;">Type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">forking</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">User</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#24292E;">Group</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">postgres</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Where to send early-startup messages from the server</span></span>
<span class="line"><span style="color:#6A737D;"># This is normally controlled by the global default set by systemd</span></span>
<span class="line"><span style="color:#6A737D;"># StandardOutput=syslog</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/bin/repmgrd</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/tmp/repmgrd.pid</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--verbose</span></span>
<span class="line"><span style="color:#24292E;">ExecStop</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/bin/kill</span><span style="color:#24292E;"> </span><span style="color:#032F62;">\`</span><span style="color:#6F42C1;">cat</span><span style="color:#032F62;"> /tmp/repmgrd.pid\`</span></span>
<span class="line"><span style="color:#24292E;">PrivateTmp</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#6A737D;"># Give a reasonable amount of time for the server to start up/shut down</span></span>
<span class="line"><span style="color:#24292E;">TimeoutSec</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">300</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">[Install]</span></span>
<span class="line"><span style="color:#24292E;">WantedBy</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">multi-user.target</span></span></code></pre></div><p>22、修改 <code>postgresql.conf</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">shared_preload_libraries = &#39;repmgr&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">shared_preload_libraries = &#39;repmgr&#39;</span></span></code></pre></div><p>修改 <code>repmgr.conf</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">failover=&#39;automatic&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">promote_command=&#39;/usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">follow_command=&#39;/usr/bin/repmgr standby follow -f /etc/repmgr.conf --log-to-file --upstream-node-id=%n&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">repmgrd_service_start_command = &#39;repmgrd --daemonize=true&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">repmgrd_service_stop_command = &#39;kill \`cat /tmp/repmgrd.pid\`&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">repmgrd_pid_file=&#39;/tmp/repmgrd.pid&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">failover=&#39;automatic&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">promote_command=&#39;/usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file&#39;</span></span>
<span class="line"><span style="color:#24292e;">follow_command=&#39;/usr/bin/repmgr standby follow -f /etc/repmgr.conf --log-to-file --upstream-node-id=%n&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">repmgrd_service_start_command = &#39;repmgrd --daemonize=true&#39;</span></span>
<span class="line"><span style="color:#24292e;">repmgrd_service_stop_command = &#39;kill \`cat /tmp/repmgrd.pid\`&#39;</span></span>
<span class="line"><span style="color:#24292e;">repmgrd_pid_file=&#39;/tmp/repmgrd.pid&#39;</span></span></code></pre></div><p>23、启动 repmgrd 服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># root 用户</span></span>
<span class="line"><span style="color:#6A737D;"># enable 表示开启开机自启</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span></span>
<span class="line"><span style="color:#6A737D;"># 启动 repmgrd</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgrd</span></span>
<span class="line"><span style="color:#6A737D;"># 检查启动状态</span></span>
<span class="line"><span style="color:#B392F0;">repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-v</span></span>
<span class="line"><span style="color:#6A737D;"># 或者</span></span>
<span class="line"><span style="color:#B392F0;">ps</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># root 用户</span></span>
<span class="line"><span style="color:#6A737D;"># enable 表示开启开机自启</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgrd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span></span>
<span class="line"><span style="color:#6A737D;"># 启动 repmgrd</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgrd</span></span>
<span class="line"><span style="color:#6A737D;"># 检查启动状态</span></span>
<span class="line"><span style="color:#6F42C1;">repmgrd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-v</span></span>
<span class="line"><span style="color:#6A737D;"># 或者</span></span>
<span class="line"><span style="color:#6F42C1;">ps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span></span></code></pre></div><p>24、查看当前集群状态</p><blockquote><p>每个节点的 repmgrd 都要处于 running 状态。</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ID</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Name</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Status</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PID</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Paused?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">last</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">seen</span></span>
<span class="line"><span style="color:#B392F0;">----+-------+---------+-----------+----------+---------+-------+---------+--------------------</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">node1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">15374</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">no</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">second</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">s</span><span style="color:#E1E4E8;">) </span><span style="color:#9ECBFF;">ago</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">node2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">standby</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">node1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">12854</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">no</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">n/a</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ID</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Name</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Status</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Upstream</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">repmgrd</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PID</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Paused?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Upstream</span><span style="color:#24292E;"> </span><span style="color:#032F62;">last</span><span style="color:#24292E;"> </span><span style="color:#032F62;">seen</span></span>
<span class="line"><span style="color:#6F42C1;">----+-------+---------+-----------+----------+---------+-------+---------+--------------------</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">node1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">primary</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">15374</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">no</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#032F62;">second</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">s</span><span style="color:#24292E;">) </span><span style="color:#032F62;">ago</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">node2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">standby</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">*</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">node1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">12854</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">no</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">n/a</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 或者查看 postgres 用户启动的进程状态</span></span>
<span class="line"><span style="color:#B392F0;">ps</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 或者查看 postgres 用户启动的进程状态</span></span>
<span class="line"><span style="color:#6F42C1;">ps</span><span style="color:#24292E;"> </span><span style="color:#032F62;">f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span></span></code></pre></div><p>25、停止主节点模拟宕机</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@vm01:~/15$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg_ctlcluster</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stop</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@vm01:~/15$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg_ctlcluster</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stop</span></span></code></pre></div><p>一分钟后 node2 变成主节点</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [INFO] 0 active sibling nodes registered</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [INFO] 2 total nodes registered</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [INFO] primary node  </span><span style="color:#9ECBFF;">&quot;node1&quot;</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) and this node have the same location (</span><span style="color:#B392F0;">&quot;default&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [INFO] no other sibling nodes - we win by default</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [NOTICE] this node is the only available candidate and will now promote itself</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [INFO] promote_command is:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">&quot;/usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [NOTICE] promoting standby to primary</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:37] [DETAIL] promoting server </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) using </span><span style="color:#B392F0;">pg_promote</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">[2023-10-17 16:30:37] [NOTICE] waiting up to 60 seconds (</span><span style="color:#B392F0;">parameter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;promote_check_timeout&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> promotion to complete</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [NOTICE] STANDBY PROMOTE successful</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [DETAIL] server </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">) was successfully promoted to primary</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [INFO] checking state of node 2, 1 of 6 attempts</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [NOTICE] node 2 has recovered, reconnecting</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [INFO] connection to node 2 succeeded</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [INFO] original connection is still available</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [INFO] 0 followers to notify</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [INFO] switching to primary monitoring mode</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2023</span><span style="color:#E1E4E8;">-10-17 </span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">:30:39] [NOTICE] monitoring cluster primary </span><span style="color:#9ECBFF;">&quot;node2&quot;</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [INFO] 0 active sibling nodes registered</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [INFO] 2 total nodes registered</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [INFO] primary node  </span><span style="color:#032F62;">&quot;node1&quot;</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) and this node have the same location (</span><span style="color:#6F42C1;">&quot;default&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [INFO] no other sibling nodes - we win by default</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [NOTICE] this node is the only available candidate and will now promote itself</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [INFO] promote_command is:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">&quot;/usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file&quot;</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [NOTICE] promoting standby to primary</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:37] [DETAIL] promoting server </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) using </span><span style="color:#6F42C1;">pg_promote</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">[2023-10-17 16:30:37] [NOTICE] waiting up to 60 seconds (</span><span style="color:#6F42C1;">parameter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;promote_check_timeout&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> promotion to complete</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [NOTICE] STANDBY PROMOTE successful</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [DETAIL] server </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">) was successfully promoted to primary</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [INFO] checking state of node 2, 1 of 6 attempts</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [NOTICE] node 2 has recovered, reconnecting</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [INFO] connection to node 2 succeeded</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [INFO] original connection is still available</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [INFO] 0 followers to notify</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [INFO] switching to primary monitoring mode</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2023</span><span style="color:#24292E;">-10-17 </span><span style="color:#005CC5;">16</span><span style="color:#24292E;">:30:39] [NOTICE] monitoring cluster primary </span><span style="color:#032F62;">&quot;node2&quot;</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">)</span></span></code></pre></div><p>node1 的状态变成 failed</p><p><img src="`+t+'" alt="image-20231017163424709"></p><p>26、node1 重新加入集群（服务未启动的情况下）</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/repmgr.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rejoin</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span><span style="color:#9ECBFF;">&#39;host=172.24.246.161 port=5432 user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/repmgr.conf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rejoin</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span><span style="color:#032F62;">&#39;host=172.24.246.161 port=5432 user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span></code></pre></div><p>27、重新启动 node1</p><p><img src="'+c+`" alt="image-20231017163516599"></p><blockquote><p>如果在执行 rejoin 之前启动了 node1，那么可能会出现 node1 和 node2 时间线不一致的情况，导致无法 rejoin。因此注意要在故障的节点未启动的情况下先进行 rejoin，再启动节点。</p><p>如果不小心先于 rejoin 之前启动了 node1，就需要将 node1 的数据清空，重新从 node2 克隆，再重新以 standby 的身份加入集群。</p></blockquote><p>…</p><hr><h3 id="repmgrd-witness" tabindex="-1">repmgrd + witness <a class="header-anchor" href="#repmgrd-witness" aria-label="Permalink to &quot;repmgrd + witness&quot;">​</a></h3><p><strong>什么是 witness</strong></p><p>witness 服务是独立于集群的一个 PostgreSQL 实例，在出现故障转移的情况下，它可以当作目击者来证明是由于网络问题导致 primary 节点不可用还是 primary 本身出现故障导致的不可用。</p><blockquote><p>作为 primary 出故障的目击证人</p></blockquote><p><strong>使用场景</strong></p><p>一主一从部署，且主从节点位于不同的位置（数据中心）。在主节点相邻的位置创建 witness 节点，如果主节点变得不可用，是否应该让从节点提升未主节点？</p><ul><li>如果从节点同时无法连接主节点和 witness，说明是网络原因导致的的故障，从节点不会被提升；</li><li>如果从节点无法连接主节点，但是可以连接 witness，说明是主节点自身原因导致的不可用，从节点会被提升为新的主节点。</li></ul><p>在更为复杂的情况下，比如说有多个数据中心，应该确保只允许和主节点处于同一位置的节点被提升为新的主节点，<a href="https://www.repmgr.org/docs/current/repmgrd-network-split.html" target="_blank" rel="noreferrer">参考连接</a>。</p><blockquote><p>只有在启动了 repmgrd 的情况下，witness 服务才有效。</p></blockquote><p><strong>创建 witness 节点</strong></p><blockquote><p>witness 实例不能与主节点部署在同一台物理机上。</p></blockquote><blockquote><p>一个 PostgreSQL 实例只能作为一个集群的 witness 节点来使用，不能作为多个 witness 节点。</p></blockquote><p>0、创建 repmgr 用户，创建 repmgr 数据库</p><p>1、配置 <code>repmgr.conf</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">node_id=100</span></span>
<span class="line"><span style="color:#e1e4e8;">node_name=&#39;witness100&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">conninfo=&#39;host=&lt;witness-host&gt; user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">node_id=100</span></span>
<span class="line"><span style="color:#24292e;">node_name=&#39;witness100&#39;</span></span>
<span class="line"><span style="color:#24292e;">conninfo=&#39;host=&lt;witness-host&gt; user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#24292e;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span></code></pre></div><p>3、修改 <code>pg_hba.conf</code></p><p>修改 <code>postgresql.conf</code>，允许远程访问</p><p>6、启动 PostgreSQL 实例，以 primary 的身份加入<strong>自己的集群</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">primary</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">primary</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span></span></code></pre></div><p><img src="`+r+'" alt="image-20231018103016642"></p><p>7、启动 repmgrd</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">repmgrd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">repmgrd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-d</span></span></code></pre></div><p>8、以 witness 身份注册到<strong>主从复制集群</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">repmgr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">witness</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">register</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--force</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">primary-hos</span><span style="color:#E1E4E8;">t</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">repmgr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">witness</span><span style="color:#24292E;"> </span><span style="color:#032F62;">register</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--force</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">primary-hos</span><span style="color:#24292E;">t</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p><img src="'+y+`" alt="image-20231018103045843"></p><p>部署完成。</p><p>…</p><hr><h3 id="完整-postgresql-conf" tabindex="-1">完整 postgresql.conf <a class="header-anchor" href="#完整-postgresql-conf" aria-label="Permalink to &quot;完整 postgresql.conf&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">listen_addresses = &#39;*&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">wal_level = replica</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_mode = on</span></span>
<span class="line"><span style="color:#e1e4e8;">#archive_command = &#39;/bin/true&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">archive_command = &#39;{ sleep 5; true; }&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">max_wal_senders = 10</span></span>
<span class="line"><span style="color:#e1e4e8;">max_replication_slots = 10 # (修改) 设置支持的复制槽数量</span></span>
<span class="line"><span style="color:#e1e4e8;">max_slot_wal_keep_size = 1GB # (修改) 设置复制槽保留的 wal 最大值,默认单位是 M</span></span>
<span class="line"><span style="color:#e1e4e8;">hot_standby = on</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">shared_preload_libraries = &#39;repmgr&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">listen_addresses = &#39;*&#39;</span></span>
<span class="line"><span style="color:#24292e;">wal_level = replica</span></span>
<span class="line"><span style="color:#24292e;">archive_mode = on</span></span>
<span class="line"><span style="color:#24292e;">#archive_command = &#39;/bin/true&#39;</span></span>
<span class="line"><span style="color:#24292e;">archive_command = &#39;{ sleep 5; true; }&#39;</span></span>
<span class="line"><span style="color:#24292e;">max_wal_senders = 10</span></span>
<span class="line"><span style="color:#24292e;">max_replication_slots = 10 # (修改) 设置支持的复制槽数量</span></span>
<span class="line"><span style="color:#24292e;">max_slot_wal_keep_size = 1GB # (修改) 设置复制槽保留的 wal 最大值,默认单位是 M</span></span>
<span class="line"><span style="color:#24292e;">hot_standby = on</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">shared_preload_libraries = &#39;repmgr&#39;</span></span></code></pre></div><p>…</p><h3 id="完整-pg-hba-conf" tabindex="-1">完整 pg_hba.conf <a class="header-anchor" href="#完整-pg-hba-conf" aria-label="Permalink to &quot;完整 pg_hba.conf&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">host replication all 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#e1e4e8;">local repmgr repmgr trust</span></span>
<span class="line"><span style="color:#e1e4e8;">host repmgr repmgr 127.0.0.1/32 trust</span></span>
<span class="line"><span style="color:#e1e4e8;">host repmgr repmgr 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#e1e4e8;">host all all 0.0.0.0/0 trust</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">host replication all 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#24292e;">local repmgr repmgr trust</span></span>
<span class="line"><span style="color:#24292e;">host repmgr repmgr 127.0.0.1/32 trust</span></span>
<span class="line"><span style="color:#24292e;">host repmgr repmgr 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#24292e;">host all all 0.0.0.0/0 trust</span></span></code></pre></div><p>…</p><h3 id="完整-repmgr-conf" tabindex="-1">完整 repmgr.conf <a class="header-anchor" href="#完整-repmgr-conf" aria-label="Permalink to &quot;完整 repmgr.conf&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">node_id=1</span></span>
<span class="line"><span style="color:#e1e4e8;">node_name=&#39;node1&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">conninfo=&#39;host=&lt;node-host&gt; user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">failover=&#39;automatic&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">promote_command=&#39;/usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">follow_command=&#39;/usr/bin/repmgr standby follow -f /etc/repmgr.conf --log-to-file --upstream-node-id=%n&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">service_start_command=&#39;pg_ctlcluster 15 main start&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">service_stop_command=&#39;pg_ctlcluster 15 main stop&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">service_restart_command=&#39;pg_ctlcluster 15 main restart&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">service_reload_command  = &#39;pg_ctlcluster 15 main reload&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">repmgrd_service_start_command = &#39;repmgrd --daemonize=true&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">repmgrd_service_stop_command = &#39;kill \`cat /tmp/repmgrd.pid\`&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">repmgrd_pid_file=&#39;/tmp/repmgrd.pid&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">node_id=1</span></span>
<span class="line"><span style="color:#24292e;">node_name=&#39;node1&#39;</span></span>
<span class="line"><span style="color:#24292e;">conninfo=&#39;host=&lt;node-host&gt; user=repmgr dbname=repmgr connect_timeout=2&#39;</span></span>
<span class="line"><span style="color:#24292e;">data_directory=&#39;/var/lib/postgresql/15/main&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">failover=&#39;automatic&#39;</span></span>
<span class="line"><span style="color:#24292e;">promote_command=&#39;/usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file&#39;</span></span>
<span class="line"><span style="color:#24292e;">follow_command=&#39;/usr/bin/repmgr standby follow -f /etc/repmgr.conf --log-to-file --upstream-node-id=%n&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">service_start_command=&#39;pg_ctlcluster 15 main start&#39;</span></span>
<span class="line"><span style="color:#24292e;">service_stop_command=&#39;pg_ctlcluster 15 main stop&#39;</span></span>
<span class="line"><span style="color:#24292e;">service_restart_command=&#39;pg_ctlcluster 15 main restart&#39;</span></span>
<span class="line"><span style="color:#24292e;">service_reload_command  = &#39;pg_ctlcluster 15 main reload&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">repmgrd_service_start_command = &#39;repmgrd --daemonize=true&#39;</span></span>
<span class="line"><span style="color:#24292e;">repmgrd_service_stop_command = &#39;kill \`cat /tmp/repmgrd.pid\`&#39;</span></span>
<span class="line"><span style="color:#24292e;">repmgrd_pid_file=&#39;/tmp/repmgrd.pid&#39;</span></span></code></pre></div><p>…</p><hr><h3 id="总结-1" tabindex="-1">总结 <a class="header-anchor" href="#总结-1" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>主从流复制 + repmgr 的方式带来了两点优化：0、借助 repmgr 命令能很直观的看到集群的状态；1、从节点配置更加方便，直接 clone 主节点的数据即可；2、借助 repmgrd 能实现自动故障转移。</p><p>需要注意：1、出故障的节点在恢复之后仍然需要人为的 rejoin 和 restart；2、检查好 repmgrd 的状态，否则无法实现自动故障转移。</p><p>此外自动故障转移可能会出现“脑裂”的情况，此时就需要人为干预，越早调整越好。</p><hr><br><h2 id="主从流复制-repmgr-keepalive" tabindex="-1">主从流复制 + repmgr + keepalive <a class="header-anchor" href="#主从流复制-repmgr-keepalive" aria-label="Permalink to &quot;主从流复制 + repmgr + keepalive&quot;">​</a></h2><blockquote><p><a href="https://vlambda.com/wz_7iAykuog2O0.html" target="_blank" rel="noreferrer">可参考</a></p></blockquote><p>…</p><hr><br><h2 id="patroni" tabindex="-1">Patroni <a class="header-anchor" href="#patroni" aria-label="Permalink to &quot;Patroni&quot;">​</a></h2><p>Patroni 是一个不同于 repmgr 的 PostgreSQL 高可用方案。关于 Patroni 和 repmgr 的对比，优缺点网络上已经存在很多资源了，此处不列举。</p><h3 id="集群部署" tabindex="-1">集群部署 <a class="header-anchor" href="#集群部署" aria-label="Permalink to &quot;集群部署&quot;">​</a></h3><blockquote><p>测试机为 Ubuntu</p><ul><li>PostgreSQL/Patroni: 192.168.111.21/192.168.111.22/192.168.111.23</li><li>etcd: 192.168.111.20</li></ul></blockquote><p>1、部署 etcd 用于存储集群元数据</p><blockquote><p>目前仅部署一个服务用作测试，一般来说生产环境下需要部署三个 etcd 服务。</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span></span></code></pre></div><p>2、修改配置 <code>/etc/default/etcd</code></p><blockquote><p>本机 IP 为 192.168.111.20</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ETCD_NAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;etcd0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_DATA_DIR</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;/var/lib/etcd/default&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_LISTEN_PEER_URLS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;http://192.168.111.20:2380&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_LISTEN_CLIENT_URLS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;http://localhost:2379,http://192.168.111.20:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;http://192.168.111.20:2380&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_CLUSTER</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;etcd0=http://192.168.111.20:2380&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;new&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_INITIAL_CLUSTER_TOKEN</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;etcd-cluster&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ETCD_ADVERTISE_CLIENT_URLS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;http://192.168.111.20:2379&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ETCD_NAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;etcd0&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_DATA_DIR</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;/var/lib/etcd/default&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_LISTEN_PEER_URLS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;http://192.168.111.20:2380&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_LISTEN_CLIENT_URLS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;http://localhost:2379,http://192.168.111.20:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;http://192.168.111.20:2380&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_CLUSTER</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;etcd0=http://192.168.111.20:2380&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;new&quot;</span></span>
<span class="line"><span style="color:#24292E;">ETCD_INITIAL_CLUSTER_TOKEN</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;etcd-cluster&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ETCD_ADVERTISE_CLIENT_URLS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;http://192.168.111.20:2379&quot;</span></span></code></pre></div><p>启动 etcd</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span></span>
<span class="line"><span style="color:#6A737D;"># 允许开机自启</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">etcd</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--now</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 允许开机自启并立即启动</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span></span>
<span class="line"><span style="color:#6A737D;"># 允许开机自启</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">etcd</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--now</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 允许开机自启并立即启动</span></span></code></pre></div><p>3、安装 Patroni</p><blockquote><p>Ubuntu 自带 python3，如果没有需要先安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">python3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">python3</span></span></code></pre></div></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apt-get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">python3-pip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">python3-psycopg2</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># install python3 psycopg2 module on Debian/Ubuntu</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 最好开启代理，否则 pip 可能比较慢</span></span>
<span class="line"><span style="color:#B392F0;">pip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--upgrade</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pip</span></span>
<span class="line"><span style="color:#B392F0;">pip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--upgrade</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">setuptools</span></span>
<span class="line"><span style="color:#B392F0;">pip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[etcd]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 注意：需要取消 postgresql 开机自启</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">disable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apt-get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">python3-pip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">python3-psycopg2</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># install python3 psycopg2 module on Debian/Ubuntu</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 最好开启代理，否则 pip 可能比较慢</span></span>
<span class="line"><span style="color:#6F42C1;">pip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--upgrade</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pip</span></span>
<span class="line"><span style="color:#6F42C1;">pip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--upgrade</span><span style="color:#24292E;"> </span><span style="color:#032F62;">setuptools</span></span>
<span class="line"><span style="color:#6F42C1;">pip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[etcd]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 注意：需要取消 postgresql 开机自启</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">disable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span></span></code></pre></div><p>4、创建 <code>/etc/patroni.yml</code></p><blockquote><p>有几个需要修改的地方：</p><ul><li>restapi.connect_address</li><li>etcd.host</li><li>postgresql.connect_address</li><li>postgresql.data_dir</li><li>postgresql.bin_dir</li></ul></blockquote><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">scope</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pgsql</span></span>
<span class="line"><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/service/</span></span>
<span class="line"><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">restapi</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">listen</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0.0.0.0:8008</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">connect_address</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">192.168.111.21:8008</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">etcd</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">192.168.111.20:2379</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">bootstrap</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dcs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">ttl</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">loop_wait</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">retry_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># timeout for DCS and PostgreSQL operation retries (in seconds). </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">maximum_lag_on_failover</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">1048576</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">primary_start_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">300</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">synchronous_mode</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># turns on synchronous replication mode</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">postgresql</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">use_pg_rewind</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">use_slots</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">parameters</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">listen_addresses</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;0.0.0.0&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5432</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">wal_level</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">logical</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">hot_standby</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;on&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">wal_keep_segments</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">max_wal_senders</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">max_replication_slots</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">wal_log_hints</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;on&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># shared_preload_libraries: [&#39;pg_stat_statements&#39;]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">pg_hba</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">local all all 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">host replication repl 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">host all all 0.0.0.0/0 trust</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">initdb</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">encoding</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">UTF-8</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">data-checksums</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">postgresql</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">listen</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">0.0.0.0:5432</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">connect_address</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">192.168.111.21:5432</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">data_dir</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/lib/postgresql/15/main</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># main 目录需要为空，且用户和用户组为 postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#config_dir: /etc/postgresql/15/main/ # defaults to the data directory</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">bin_dir</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/usr/lib/postgresql/15/bin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">authentication</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">superuser</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">username</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">password</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">replication</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">username</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">repl</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">password</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;123456&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">basebackup</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">max-rate</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100M</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">checkpoint</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">fast</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D;">tags</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nofailover</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">noloadbalance</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">clonefrom</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nosync</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">scope</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pgsql</span></span>
<span class="line"><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/service/</span></span>
<span class="line"><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">restapi</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">listen</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0.0.0.0:8008</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">connect_address</span><span style="color:#24292E;">: </span><span style="color:#032F62;">192.168.111.21:8008</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">etcd</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">192.168.111.20:2379</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">bootstrap</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dcs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">ttl</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">loop_wait</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">retry_timeout</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># timeout for DCS and PostgreSQL operation retries (in seconds). </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">maximum_lag_on_failover</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">1048576</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">primary_start_timeout</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">300</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">synchronous_mode</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># turns on synchronous replication mode</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">postgresql</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">use_pg_rewind</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">use_slots</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">parameters</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">listen_addresses</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;0.0.0.0&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5432</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">wal_level</span><span style="color:#24292E;">: </span><span style="color:#032F62;">logical</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">hot_standby</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;on&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">wal_keep_segments</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">max_wal_senders</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">max_replication_slots</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">wal_log_hints</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;on&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># shared_preload_libraries: [&#39;pg_stat_statements&#39;]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">pg_hba</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">local all all 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">host replication repl 0.0.0.0/0 trust</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">host all all 0.0.0.0/0 trust</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">initdb</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">encoding</span><span style="color:#24292E;">: </span><span style="color:#032F62;">UTF-8</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">data-checksums</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">postgresql</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">listen</span><span style="color:#24292E;">: </span><span style="color:#032F62;">0.0.0.0:5432</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">connect_address</span><span style="color:#24292E;">: </span><span style="color:#032F62;">192.168.111.21:5432</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">data_dir</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/lib/postgresql/15/main</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># main 目录需要为空，且用户和用户组为 postgres</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">#config_dir: /etc/postgresql/15/main/ # defaults to the data directory</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">bin_dir</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/usr/lib/postgresql/15/bin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">authentication</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">superuser</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">username</span><span style="color:#24292E;">: </span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;postgres&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">replication</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">username</span><span style="color:#24292E;">: </span><span style="color:#032F62;">repl</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;123456&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">basebackup</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">max-rate</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100M</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">checkpoint</span><span style="color:#24292E;">: </span><span style="color:#032F62;">fast</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A;">tags</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nofailover</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">noloadbalance</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">clonefrom</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nosync</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span></code></pre></div><blockquote><p>其他几个节点的 patroni 配置也是差不多的，需要修改几个地方：</p><ul><li>name</li><li>restapi.connect_address</li><li>postgresql.connect_address</li></ul></blockquote><p>5、创建 <code>/etc/systemd/system/patroni.service</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[Unit]</span></span>
<span class="line"><span style="color:#E1E4E8;">Description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">patroni.service</span></span>
<span class="line"><span style="color:#E1E4E8;">After</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">syslog.target</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">network.target</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="color:#E1E4E8;">Type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">simple</span></span>
<span class="line"><span style="color:#E1E4E8;">User</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">Group</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#6A737D;">#StandardOutput=syslog</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/local/bin/patroni</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecReload</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/bin/kill</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">HUP</span><span style="color:#E1E4E8;"> $MAINPID</span></span>
<span class="line"><span style="color:#E1E4E8;">KillMode</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">process</span></span>
<span class="line"><span style="color:#E1E4E8;">TimeoutSec</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">Restart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[Install]</span></span>
<span class="line"><span style="color:#E1E4E8;">WantedBy</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">multi-user.target</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[Unit]</span></span>
<span class="line"><span style="color:#24292E;">Description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">patroni.service</span></span>
<span class="line"><span style="color:#24292E;">After</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">syslog.target</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">network.target</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[Service]</span></span>
<span class="line"><span style="color:#24292E;">Type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">simple</span></span>
<span class="line"><span style="color:#24292E;">User</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#24292E;">Group</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#6A737D;">#StandardOutput=syslog</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/local/bin/patroni</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#24292E;">ExecReload</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/bin/kill</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">HUP</span><span style="color:#24292E;"> $MAINPID</span></span>
<span class="line"><span style="color:#24292E;">KillMode</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">process</span></span>
<span class="line"><span style="color:#24292E;">TimeoutSec</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">Restart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[Install]</span></span>
<span class="line"><span style="color:#24292E;">WantedBy</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">multi-user.target</span></span></code></pre></div><p>6、设置 patroni 自启动</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span></span></code></pre></div><p>配置 postgres 免密 sudo 权限</p><blockquote><p>免密的前提是执行命令前要加上 <code>sudo</code> 前缀</p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/sudoers</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">visudo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/sudoers</span></span>
<span class="line"><span style="color:#6A737D;"># or</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">visudo</span></span></code></pre></div><p>添加</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres ALL=(ALL) NOPASSWD: ALL</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres ALL=(ALL) NOPASSWD: ALL</span></span></code></pre></div><p>7、启动 patroni</p><p>7.1、启动前的准备</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">root:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgresql</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 确保 pg 处于停止状态下</span></span>
<span class="line"><span style="color:#6A737D;"># 备份原来的数据目录</span></span>
<span class="line"><span style="color:#B392F0;">root:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cd</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/15</span></span>
<span class="line"><span style="color:#B392F0;">root:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mv</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">backup/</span></span>
<span class="line"><span style="color:#B392F0;">root:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">su</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#B392F0;">postgres:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span></span>
<span class="line"><span style="color:#6A737D;"># 注意 postgres 用户对 main 文件夹的权限应该是 0700 或者 0750</span></span>
<span class="line"><span style="color:#B392F0;">postgres:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chmod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0750</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">main</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">root:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgresql</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 确保 pg 处于停止状态下</span></span>
<span class="line"><span style="color:#6A737D;"># 备份原来的数据目录</span></span>
<span class="line"><span style="color:#6F42C1;">root:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cd</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/15</span></span>
<span class="line"><span style="color:#6F42C1;">root:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mv</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">backup/</span></span>
<span class="line"><span style="color:#6F42C1;">root:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">su</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#6F42C1;">postgres:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span></span>
<span class="line"><span style="color:#6A737D;"># 注意 postgres 用户对 main 文件夹的权限应该是 0700 或者 0750</span></span>
<span class="line"><span style="color:#6F42C1;">postgres:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chmod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0750</span><span style="color:#24292E;"> </span><span style="color:#032F62;">main</span></span></code></pre></div><p>7.2、启动 patroni</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># postgres 用户</span></span>
<span class="line"><span style="color:#6A737D;"># 注意：需要加上 sudo</span></span>
<span class="line"><span style="color:#B392F0;">postgres@ubt1:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span></span>
<span class="line"><span style="color:#B392F0;">postgres@ubt1:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span></span>
<span class="line"><span style="color:#B392F0;">●</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni.service</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Loaded:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loaded</span><span style="color:#E1E4E8;"> (/etc/systemd/system/patroni.service; </span><span style="color:#B392F0;">enabled</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">vendor</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">preset:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enabled</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Active:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">active</span><span style="color:#E1E4E8;"> (running) since Wed 2023-10-18 16:14:53 CST; </span><span style="color:#B392F0;">3s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ago</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">PID:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6939</span><span style="color:#E1E4E8;"> (patroni)</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">Tasks:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;"> (limit: </span><span style="color:#79B8FF;">2231</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">Memory:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">89.3</span><span style="color:#9ECBFF;">M</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">CPU:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">911</span><span style="color:#9ECBFF;">ms</span></span>
<span class="line"><span style="color:#E1E4E8;">     </span><span style="color:#B392F0;">CGroup:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/system.slice/patroni.service</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">├─6939</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/bin/python3</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/local/bin/patroni</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">├─6974</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/usr/lib/postgresql/15/bin/postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/lib/postgresql/15/main</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--config-file=/var/lib/postgresql/15/main/postgresql.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--listen_addresses=0.0.0.0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--port=5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--c</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">├─6976</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres: pgsql: checkpointer &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">             ├─6977 &quot;postgres:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">background</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">writer</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot;&gt;</span></span>
<span class="line"><span style="color:#9ECBFF;">             ├─6982 &quot;postgres:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">walwriter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">├─6983</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres: pgsql: autovacuum launcher &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">├─6984</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres: pgsql: logical replication launcher &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">             </span><span style="color:#B392F0;">└─6987</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;postgres: pgsql: postgres postgres 127.0.0.1(51908) idle&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6978</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54.872</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [6978] LOG:  database system was shut down at 2023-10-18 16:14:54 CST</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6975</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:5432</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rejecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6981</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54.875</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [6981] FATAL:  the database system is starting up</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6980</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:5432</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rejecting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6974</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:54.878</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [6974] LOG:  database system is ready to accept connections</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6985</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">localhost:5432</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">accepting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connections</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6939</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55,887</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">establishing</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">connection</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6939</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55,891</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">post_bootstrap</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6939</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55,905</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">WARNING:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Could</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">activate</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Linux</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">watchdog</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">device:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Can&#39;t open watchdog device: [Errno 2] No such file or directory: &#39;/dev/watc</span><span style="color:#E1E4E8;">h</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">6939</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-18</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">16</span><span style="color:#9ECBFF;">:14:55,910</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">INFO:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">initialized</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># postgres 用户</span></span>
<span class="line"><span style="color:#6A737D;"># 注意：需要加上 sudo</span></span>
<span class="line"><span style="color:#6F42C1;">postgres@ubt1:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span></span>
<span class="line"><span style="color:#6F42C1;">postgres@ubt1:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span></span>
<span class="line"><span style="color:#6F42C1;">●</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni.service</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Loaded:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loaded</span><span style="color:#24292E;"> (/etc/systemd/system/patroni.service; </span><span style="color:#6F42C1;">enabled</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">vendor</span><span style="color:#24292E;"> </span><span style="color:#032F62;">preset:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enabled</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Active:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">active</span><span style="color:#24292E;"> (running) since Wed 2023-10-18 16:14:53 CST; </span><span style="color:#6F42C1;">3s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ago</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;"> </span><span style="color:#032F62;">PID:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6939</span><span style="color:#24292E;"> (patroni)</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">Tasks:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">12</span><span style="color:#24292E;"> (limit: </span><span style="color:#005CC5;">2231</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">Memory:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">89.3</span><span style="color:#032F62;">M</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">CPU:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">911</span><span style="color:#032F62;">ms</span></span>
<span class="line"><span style="color:#24292E;">     </span><span style="color:#6F42C1;">CGroup:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/system.slice/patroni.service</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">├─6939</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/bin/python3</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/local/bin/patroni</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">├─6974</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/usr/lib/postgresql/15/bin/postgres</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/lib/postgresql/15/main</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--config-file=/var/lib/postgresql/15/main/postgresql.conf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--listen_addresses=0.0.0.0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--port=5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--c</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">├─6976</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres: pgsql: checkpointer &quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&gt;</span></span>
<span class="line"><span style="color:#032F62;">             ├─6977 &quot;postgres:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">background</span><span style="color:#24292E;"> </span><span style="color:#032F62;">writer</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot;&gt;</span></span>
<span class="line"><span style="color:#032F62;">             ├─6982 &quot;postgres:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">walwriter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; &quot;</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">├─6983</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres: pgsql: autovacuum launcher &quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">├─6984</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres: pgsql: logical replication launcher &quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">             </span><span style="color:#6F42C1;">└─6987</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;postgres: pgsql: postgres postgres 127.0.0.1(51908) idle&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6978</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54.872</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [6978] LOG:  database system was shut down at 2023-10-18 16:14:54 CST</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6975</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:5432</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rejecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6981</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54.875</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [6981] FATAL:  the database system is starting up</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6980</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:5432</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rejecting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6974</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:54.878</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [6974] LOG:  database system is ready to accept connections</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6985</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">localhost:5432</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">accepting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connections</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6939</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55,887</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">establishing</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span><span style="color:#24292E;"> </span><span style="color:#032F62;">connection</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6939</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55,891</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">post_bootstrap</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6939</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55,905</span><span style="color:#24292E;"> </span><span style="color:#032F62;">WARNING:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Could</span><span style="color:#24292E;"> </span><span style="color:#032F62;">not</span><span style="color:#24292E;"> </span><span style="color:#032F62;">activate</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Linux</span><span style="color:#24292E;"> </span><span style="color:#032F62;">watchdog</span><span style="color:#24292E;"> </span><span style="color:#032F62;">device:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Can&#39;t open watchdog device: [Errno 2] No such file or directory: &#39;/dev/watc</span><span style="color:#24292E;">h</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">6939</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-18</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">16</span><span style="color:#032F62;">:14:55,910</span><span style="color:#24292E;"> </span><span style="color:#032F62;">INFO:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">initialized</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">new</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span></span></code></pre></div><p>8、查看集群状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@ubt1:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/patroni.yml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) ------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+--------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+--------+---------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@ubt1:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/patroni.yml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) ------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+--------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+--------+---------+----+-----------+</span></span></code></pre></div><p>9、将 patroni 配置设置到全局环境变量</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#B392F0;">vim</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/.bash_profile</span></span>
<span class="line"><span style="color:#6A737D;"># 添加</span></span>
<span class="line"><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> PATRONICTL_CONFIG_FILE</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#79B8FF;">source</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">~/.bash_profile</span></span>
<span class="line"><span style="color:#6A737D;"># 测试</span></span>
<span class="line"><span style="color:#B392F0;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#6F42C1;">vim</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/.bash_profile</span></span>
<span class="line"><span style="color:#6A737D;"># 添加</span></span>
<span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> PATRONICTL_CONFIG_FILE</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#005CC5;">source</span><span style="color:#24292E;"> </span><span style="color:#032F62;">~/.bash_profile</span></span>
<span class="line"><span style="color:#6A737D;"># 测试</span></span>
<span class="line"><span style="color:#6F42C1;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span></span></code></pre></div><p>10、重复前面的步骤，添加其他节点</p><blockquote><p>其他几个节点的 <code>patroni.yml</code> 配置也是差不多的，需要修改几个地方：</p><ul><li>name</li><li>restapi.connect_address</li><li>postgresql.connect_address</li></ul></blockquote><p>部署完成，查看集群状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@ubt1:~$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@ubt1:~$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">15</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre></div><p>…</p><hr><h3 id="故障转移" tabindex="-1">故障转移 <a class="header-anchor" href="#故障转移" aria-label="Permalink to &quot;故障转移&quot;">​</a></h3><p>1、关掉 Leader 前集群状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@ubt2:~/15$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">15</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@ubt2:~/15$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">15</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre></div><p>2、手动停止 Leader 观察其他节点状态</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@ubt2:~/15$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">stopped</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">unknown</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">31</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@ubt2:~/15$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">stopped</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">unknown</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">31</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre></div><p>Patroni 自带故障转移，可以看到 Leader 节点从 pg1 变成了 pg3。</p><p>3、重新启动 pg1</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@ubt2:~/15$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">list</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">16</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">31</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@ubt2:~/15$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">list</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">16</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">31</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre></div><p>pg1 作为 Replica 重新加入节点。</p><p>…</p><hr><h3 id="防止脑裂" tabindex="-1">防止脑裂 <a class="header-anchor" href="#防止脑裂" aria-label="Permalink to &quot;防止脑裂&quot;">​</a></h3><p><strong>两种办法</strong></p><ul><li>watchdog：利用 Linux 下的 watchdog 来监控 patroni 进程的运行，当 watchdog 接收不到 patroni 进程的心跳时触发 Linux 重启</li><li>同步复制：如果启用了 PostgreSQL 集群同步复制模式，主库在没有收到同步备库的响应时会阻塞写入。同步复制的办法即保证了不会出现双主，也不会发生<em>双写</em>，采用这种方法最为安全可靠。代价是同步复制相对于异步复制会降低一点性能。</li></ul><p>…</p><hr><h4 id="watchdog-配置" tabindex="-1">watchdog 配置 <a class="header-anchor" href="#watchdog-配置" aria-label="Permalink to &quot;watchdog 配置&quot;">​</a></h4><p>1、编辑 <code>/etc/systemd/system/patroni.service</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[Unit]</span></span>
<span class="line"><span style="color:#E1E4E8;">Description</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">patroni.service</span></span>
<span class="line"><span style="color:#E1E4E8;">After</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">syslog.target</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">network.target</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="color:#E1E4E8;">Type</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">simple</span></span>
<span class="line"><span style="color:#E1E4E8;">User</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#E1E4E8;">Group</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">postgres</span></span>
<span class="line"><span style="color:#6A737D;">#StandardOutput=syslog</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStartPre</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">-/usr/bin/sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/sbin/modprobe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">softdog</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 添加 1</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStartPre</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">-/usr/bin/sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/bin/chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/watchdog</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 添加 2</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecStart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/usr/local/bin/patroni</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#E1E4E8;">ExecReload</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/bin/kill</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">HUP</span><span style="color:#E1E4E8;"> $MAINPID</span></span>
<span class="line"><span style="color:#E1E4E8;">KillMode</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">process</span></span>
<span class="line"><span style="color:#E1E4E8;">TimeoutSec</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">Restart</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">no</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">[Install]</span></span>
<span class="line"><span style="color:#E1E4E8;">WantedBy</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">multi-user.target</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[Unit]</span></span>
<span class="line"><span style="color:#24292E;">Description</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">patroni.service</span></span>
<span class="line"><span style="color:#24292E;">After</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">syslog.target</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">network.target</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[Service]</span></span>
<span class="line"><span style="color:#24292E;">Type</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">simple</span></span>
<span class="line"><span style="color:#24292E;">User</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#24292E;">Group</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">postgres</span></span>
<span class="line"><span style="color:#6A737D;">#StandardOutput=syslog</span></span>
<span class="line"><span style="color:#24292E;">ExecStartPre</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">-/usr/bin/sudo</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/sbin/modprobe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">softdog</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 添加 1</span></span>
<span class="line"><span style="color:#24292E;">ExecStartPre</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">-/usr/bin/sudo</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/bin/chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/watchdog</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 添加 2</span></span>
<span class="line"><span style="color:#24292E;">ExecStart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/usr/local/bin/patroni</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/etc/patroni.yml</span></span>
<span class="line"><span style="color:#24292E;">ExecReload</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/bin/kill</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">HUP</span><span style="color:#24292E;"> $MAINPID</span></span>
<span class="line"><span style="color:#24292E;">KillMode</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">process</span></span>
<span class="line"><span style="color:#24292E;">TimeoutSec</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">Restart</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">no</span></span>
<span class="line"><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">[Install]</span></span>
<span class="line"><span style="color:#24292E;">WantedBy</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">multi-user.target</span></span></code></pre></div><blockquote><p>也可以不编辑该文件，<a href="https://patroni.readthedocs.io/en/latest/watchdog.html" target="_blank" rel="noreferrer">参考官方文档</a>：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#B392F0;">modprobe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">softdog</span></span>
<span class="line"><span style="color:#6A737D;"># Replace postgres with the user you will be running patroni under</span></span>
<span class="line"><span style="color:#B392F0;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/watchdog</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#6F42C1;">modprobe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">softdog</span></span>
<span class="line"><span style="color:#6A737D;"># Replace postgres with the user you will be running patroni under</span></span>
<span class="line"><span style="color:#6F42C1;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/watchdog</span></span></code></pre></div></blockquote><p>2、编辑 <code>patroni.yml</code>，添加内容</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">watchdog</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">mode</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">automatic</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># Allowed values: off, automatic, required</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">device</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/dev/watchdog</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">safety_margin</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">watchdog</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">mode</span><span style="color:#24292E;">: </span><span style="color:#032F62;">automatic</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># Allowed values: off, automatic, required</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">device</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/dev/watchdog</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">safety_margin</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5</span></span></code></pre></div><blockquote><p><code>safety_margin</code>：watchdog 持有一个 leader lock 且带有过期时间。如果 leader 节点异常，watchdog 超过 5s 未收到 leader patroni 的心跳，watchdog 会在 leader lock 过期前 5s 重启 leader 节点。重启如果在 5s 内完成，leader 节点有机会再次获得 leader 身份，否则备库会通过选举成为新的 leader。</p></blockquote><p>3、重启 patroni</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span></span>
<span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span></span>
<span class="line"><span style="color:#6A737D;"># postgres</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span></span></code></pre></div><p>…</p><blockquote><p>这种方法比较依赖于 watchdog 本身的可靠性。从生产实践上来说应对绝大部分场景都是足够的，但重启机器的做法可能有点太过暴力了，很多时候它可能并不是我们所期望的行为。</p></blockquote><p>…</p><hr><h4 id="同步复制配置" tabindex="-1">同步复制配置 <a class="header-anchor" href="#同步复制配置" aria-label="Permalink to &quot;同步复制配置&quot;">​</a></h4><p>1、编辑 <code>/etc/patroni.yml</code></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">synchronous_mode</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">synchronous_mode</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span></code></pre></div><p>对于正在运行中的 patroni 进程，可以通过命令修改</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/patroni.yml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">edit-config</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;synchronous_mode=true&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/patroni.yml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edit-config</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;synchronous_mode=true&#39;</span></span></code></pre></div><blockquote><p>在同步复制模式下，只有同步备库具有被提升为主库的资格。如果同步备库临时不可用，Patroni 会把主库的复制模式降级成了异步复制，确保服务不中断。效果类似于 MySQL 的半同步复制，但是相比 MySQL 使用固定的超时时间控制复制降级，这种方式更加智能，同时还能防止脑裂。</p><p>如果主库被降级为异步复制，由于没有同步备库作为候选主库 failover 不会被触发，也就不会出现“双主”。如果主库没有被降级为异步复制，那么即使同步备库被提升为主库出现“双主”，由于旧主处于同步复制模式，收不到同步备库的响应数据无法被写入，也不会出现“双写”。</p></blockquote><p>Patroni 通过动态调整 PostgreSQL 参数 <code>synchronous_standby_names</code> 控制同步异步复制的切换。并且 Patroni 会把同步的状态记录到 etcd 中，确保同步状态在 Patroni 集群中的一致性。</p><p>可以在 etcd 中查看到同步模式下集群的元数据：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">etcdctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/service/pgsql/sync</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;leader&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;pg1&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;sync_standby&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;pg2&quot;</span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 正常的同步模式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#B392F0;">&quot;leader&quot;</span><span style="color:#79B8FF;">:</span><span style="color:#B392F0;">&quot;pg1&quot;</span><span style="color:#B392F0;">,</span><span style="color:#B392F0;">&quot;sync_standby&quot;</span><span style="color:#B392F0;">:null}</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 备库故障导致主库临时降级为异步复制</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">etcdctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/service/pgsql/sync</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;leader&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;pg1&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;sync_standby&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;pg2&quot;</span><span style="color:#6F42C1;">}</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 正常的同步模式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#6F42C1;">&quot;leader&quot;</span><span style="color:#005CC5;">:</span><span style="color:#6F42C1;">&quot;pg1&quot;</span><span style="color:#6F42C1;">,</span><span style="color:#6F42C1;">&quot;sync_standby&quot;</span><span style="color:#6F42C1;">:null}</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 备库故障导致主库临时降级为异步复制</span></span></code></pre></div><blockquote><p>注意：key 不一定是 <code>/service/pgsql/sync</code> ，psql 就是 <code>/etc/patroni.yml</code> 中的 scope 值。也可以通过 <code>patronictl -c /etc/patroni.yml list</code> 查看</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">16</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">31</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) -------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">16</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">        </span><span style="color:#6F42C1;">31</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+---------+----+-----------+</span></span></code></pre></div><p>即为集群的名字。</p></blockquote><blockquote><p>如果集群中包含 3 个以上的节点，可以考虑采取更严格的同步策略，禁止 Patroni 把同步模式降级为异步。这样可以确保任何写入的数据至少存在于 2 个以上的节点。对数据安全要求极高的业务可以采用这种方式。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">synchronous_mode_strict</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">synchronous_mode_strict</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span></code></pre></div><p>如果集群包含异地的灾备节点，可以根据需要配置该节点为不参与选主，不参与负载均衡，也不作为同步备库。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">tags</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nofailover</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">noloadbalance</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">clonefrom</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nosync</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">tags</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nofailover</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">noloadbalance</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">clonefrom</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nosync</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span></code></pre></div></blockquote><p>…</p><hr><h3 id="etcd-高可用" tabindex="-1">etcd 高可用 <a class="header-anchor" href="#etcd-高可用" aria-label="Permalink to &quot;etcd 高可用&quot;">​</a></h3><blockquote><p>由于 PostgreSQL 集群的元数据是保存在 etcd 中的，Patroni 需要通过访问 etcd 来确认自己的身份。当无法访问 etcd 的时候，如果本机的是主库，Patroni 会将本机降级为备库。如果集群中所有 Patroni 节点都无法访问 etcd，集群中将全部都是备库，业务无法写入数据。这需要保证 etcd 集群的高可用。</p></blockquote><p>为了预防 etcd 集群故障带来的严重影响，可以考虑为 Patroni 连接 etcd 异常时设置一个比较大的 <code>retry_timeout</code> 参数，比如 10000 天</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">retry_timeout</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">864000000</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">retry_timeout</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">864000000</span></span></code></pre></div><p>…</p><hr><h3 id="patronictl-命令" tabindex="-1">patronictl 命令 <a class="header-anchor" href="#patronictl-命令" aria-label="Permalink to &quot;patronictl 命令&quot;">​</a></h3><p><strong>Patroni 常用命令</strong></p><ul><li><p><code>patronictl -c /etc/patroni.yml list</code></p></li><li><p><code>patronictl -c /etc/patroni.yml show-config</code></p></li><li><p>…</p></li></ul><p><strong>修改 PostgreSQL 参数</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/patroni.yml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">edit-config</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;max_connections=300&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/patroni.yml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">edit-config</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;max_connections=300&#39;</span></span></code></pre></div><blockquote><p>修改最大连接数后需要重启才能生效</p></blockquote><p>…</p><hr><h3 id="客户端连接" tabindex="-1">客户端连接 <a class="header-anchor" href="#客户端连接" aria-label="Permalink to &quot;客户端连接&quot;">​</a></h3><p>PostgreSQL 集群的高可用是动态的，主节点会根据故障转移变化，因此客户端在连接时也需要能动态的访问到新的主节点上。常用的方法有：</p><ul><li>多主机 URL</li><li>VIP（<em>Virtual IP</em>）</li><li>haproxy</li></ul><p>…</p><hr><h4 id="多主机-url" tabindex="-1">多主机 URL <a class="header-anchor" href="#多主机-url" aria-label="Permalink to &quot;多主机 URL&quot;">​</a></h4><p>JDBC 原生支持多主机 URL，并且功能较为全面，支持自动 failover，读写分离和负载均衡。可以通过连接参数配置不同的连接策略。</p><p>1、连接主节点（可写节点），当出现“双主”甚至“多主”的时候连接第一个发现的可用主节点</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">jdbc:postgresql://192.168.111.21:5432,192.168.111.22:5432,192.168.111.23:5432/postgres?targetServerType=primary</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">jdbc:postgresql://192.168.111.21:5432,192.168.111.22:5432,192.168.111.23:5432/postgres?targetServerType=primary</span></span></code></pre></div><p>2、优先连接备节点，无可用备节点时连接主节点，有多个可用备节点时随机连接其中一个</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">jdbc:postgresql://192.168.111.21:5432,192.168.111.22:5432,192.168.111.23:5432/postgres?targetServerType=preferSecondary&amp;loadBalanceHosts=true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">jdbc:postgresql://192.168.111.21:5432,192.168.111.22:5432,192.168.111.23:5432/postgres?targetServerType=preferSecondary&amp;loadBalanceHosts=true</span></span></code></pre></div><p>3、随机连接任意一个可用的节点</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">jdbc:postgresql://192.168.111.21:5432,192.168.111.22:5432,192.168.111.23:5432/postgres?targetServerType=any&amp;loadBalanceHosts=true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">jdbc:postgresql://192.168.111.21:5432,192.168.111.22:5432,192.168.111.23:5432/postgres?targetServerType=any&amp;loadBalanceHosts=true</span></span></code></pre></div><p>…</p><hr><h4 id="回调脚本实现-vip-漂移" tabindex="-1">回调脚本实现 VIP 漂移 <a class="header-anchor" href="#回调脚本实现-vip-漂移" aria-label="Permalink to &quot;回调脚本实现 VIP 漂移&quot;">​</a></h4><blockquote><p>可以通过 Patroni 的回调脚本实现 VIP 的漂移</p></blockquote><p>多主机URL的方式部署简单，但是不是每种语言的驱动都支持。而且如果数据库出现意外的“双主”，配置多主机 URL 的客户端在多个主上同时写入的概率比较高。如果客户端通过 VIP 的方式访问则在 VIP 上又多了一层防护（这种风险一般在数据库的 HA 架构有缺陷时发生。如果我们配置的是 Patroni 的同步模式，基本上没有这个担忧）。</p><p>Patroni 支持用户配置在特定事件发生时触发回调脚本。因此我们可以配置一个回调脚本，在主备切换后动态加载 VIP。</p><p>1、准备 Patroni 回调脚本 <code>/var/lib/postgresql/loadvip.sh</code></p><blockquote><p>需要提前安装 arping，<code>apt install arping</code></p></blockquote><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">VIP</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.30</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 固定 VIP</span></span>
<span class="line"><span style="color:#E1E4E8;">GATEWAY</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.2</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># VIP 网关</span></span>
<span class="line"><span style="color:#E1E4E8;">DEV</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">ens1</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 不一定叫 eth1，绑定当前机器已存在的网卡，多添加一个 IP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">action</span><span style="color:#F97583;">=</span><span style="color:#FFAB70;">$1</span></span>
<span class="line"><span style="color:#E1E4E8;">role</span><span style="color:#F97583;">=</span><span style="color:#FFAB70;">$2</span></span>
<span class="line"><span style="color:#E1E4E8;">cluster</span><span style="color:#F97583;">=</span><span style="color:#FFAB70;">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;loadvip: </span><span style="color:#79B8FF;">$*</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">logger</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">load_vip</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#B392F0;">ip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> \${DEV}</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> \${VIP} </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ </span><span style="color:#79B8FF;">$?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-eq</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ] ;</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;vip exists, skip load vip&quot;</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">addr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">add</span><span style="color:#E1E4E8;"> \${VIP}</span><span style="color:#9ECBFF;">/32</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dev</span><span style="color:#E1E4E8;"> \${DEV} </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="color:#E1E4E8;">  rc</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$?</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ $rc </span><span style="color:#F97583;">-ne</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ] ;</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;fail to add vip \${</span><span style="color:#E1E4E8;">VIP</span><span style="color:#9ECBFF;">} at dev \${</span><span style="color:#E1E4E8;">DEV</span><span style="color:#9ECBFF;">} rc=</span><span style="color:#E1E4E8;">$rc</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">exit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;added vip \${</span><span style="color:#E1E4E8;">VIP</span><span style="color:#9ECBFF;">} at dev \${</span><span style="color:#E1E4E8;">DEV</span><span style="color:#9ECBFF;">}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">arping</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-I</span><span style="color:#E1E4E8;"> \${DEV} </span><span style="color:#79B8FF;">-s</span><span style="color:#E1E4E8;"> \${VIP} \${GATEWAY} </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="color:#E1E4E8;">  rc</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$?</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ $rc </span><span style="color:#F97583;">-ne</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ] ;</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;fail to call arping to gateway \${</span><span style="color:#E1E4E8;">GATEWAY</span><span style="color:#9ECBFF;">} rc=</span><span style="color:#E1E4E8;">$rc</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">exit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;called arping to gateway \${</span><span style="color:#E1E4E8;">GATEWAY</span><span style="color:#9ECBFF;">}&quot;</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">unload_vip</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#B392F0;">ip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> \${DEV}</span><span style="color:#F97583;">|</span><span style="color:#B392F0;">grep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-w</span><span style="color:#E1E4E8;"> \${VIP} </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ </span><span style="color:#79B8FF;">$?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-eq</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ] ;</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">addr</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">del</span><span style="color:#E1E4E8;"> \${VIP}</span><span style="color:#9ECBFF;">/32</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dev</span><span style="color:#E1E4E8;"> \${DEV} </span><span style="color:#F97583;">&gt;</span><span style="color:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="color:#E1E4E8;">  rc</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">$?</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [ $rc </span><span style="color:#F97583;">-ne</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ] ;</span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;fail to delete vip \${</span><span style="color:#E1E4E8;">VIP</span><span style="color:#9ECBFF;">} at dev \${</span><span style="color:#E1E4E8;">DEV</span><span style="color:#9ECBFF;">} rc=</span><span style="color:#E1E4E8;">$rc</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">exit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;deleted vip \${</span><span style="color:#E1E4E8;">VIP</span><span style="color:#9ECBFF;">} at dev \${</span><span style="color:#E1E4E8;">DEV</span><span style="color:#9ECBFF;">}&quot;</span></span>
<span class="line"><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;vip not exists, skip delete vip&quot;</span></span>
<span class="line"><span style="color:#F97583;">fi</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;loadvip start args:&#39;</span><span style="color:#79B8FF;">$*</span><span style="color:#9ECBFF;">&#39;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> $action </span><span style="color:#F97583;">in</span></span>
<span class="line"><span style="color:#E1E4E8;">  on_start|on_restart|on_role_change)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> $role </span><span style="color:#F97583;">in</span></span>
<span class="line"><span style="color:#E1E4E8;">      master)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">load_vip</span></span>
<span class="line"><span style="color:#E1E4E8;">        ;;</span></span>
<span class="line"><span style="color:#E1E4E8;">      replica)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">unload_vip</span></span>
<span class="line"><span style="color:#E1E4E8;">        ;;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wrong role &#39;</span><span style="color:#E1E4E8;">$role</span><span style="color:#9ECBFF;">&#39;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">exit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">        ;;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">esac</span></span>
<span class="line"><span style="color:#E1E4E8;">    ;;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">log</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;wrong action &#39;</span><span style="color:#E1E4E8;">$action</span><span style="color:#9ECBFF;">&#39;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">exit</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    ;;</span></span>
<span class="line"><span style="color:#F97583;">esac</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">VIP</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.30</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 固定 VIP</span></span>
<span class="line"><span style="color:#24292E;">GATEWAY</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.2</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># VIP 网关</span></span>
<span class="line"><span style="color:#24292E;">DEV</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">ens1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 不一定叫 eth1，绑定当前机器已存在的网卡，多添加一个 IP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">action</span><span style="color:#D73A49;">=</span><span style="color:#E36209;">$1</span></span>
<span class="line"><span style="color:#24292E;">role</span><span style="color:#D73A49;">=</span><span style="color:#E36209;">$2</span></span>
<span class="line"><span style="color:#24292E;">cluster</span><span style="color:#D73A49;">=</span><span style="color:#E36209;">$3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">log</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;loadvip: </span><span style="color:#005CC5;">$*</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">logger</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">load_vip</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#6F42C1;">ip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> \${DEV}</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> \${VIP} </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/dev/null</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ </span><span style="color:#005CC5;">$?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-eq</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ] ;</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;vip exists, skip load vip&quot;</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">addr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add</span><span style="color:#24292E;"> \${VIP}</span><span style="color:#032F62;">/32</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> \${DEV} </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/dev/null</span></span>
<span class="line"><span style="color:#24292E;">  rc</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$?</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ $rc </span><span style="color:#D73A49;">-ne</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ] ;</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;fail to add vip \${</span><span style="color:#24292E;">VIP</span><span style="color:#032F62;">} at dev \${</span><span style="color:#24292E;">DEV</span><span style="color:#032F62;">} rc=</span><span style="color:#24292E;">$rc</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">exit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;added vip \${</span><span style="color:#24292E;">VIP</span><span style="color:#032F62;">} at dev \${</span><span style="color:#24292E;">DEV</span><span style="color:#032F62;">}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">arping</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-I</span><span style="color:#24292E;"> \${DEV} </span><span style="color:#005CC5;">-s</span><span style="color:#24292E;"> \${VIP} \${GATEWAY} </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/dev/null</span></span>
<span class="line"><span style="color:#24292E;">  rc</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$?</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ $rc </span><span style="color:#D73A49;">-ne</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ] ;</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;fail to call arping to gateway \${</span><span style="color:#24292E;">GATEWAY</span><span style="color:#032F62;">} rc=</span><span style="color:#24292E;">$rc</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">exit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;called arping to gateway \${</span><span style="color:#24292E;">GATEWAY</span><span style="color:#032F62;">}&quot;</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">unload_vip</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#6F42C1;">ip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> \${DEV}</span><span style="color:#D73A49;">|</span><span style="color:#6F42C1;">grep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-w</span><span style="color:#24292E;"> \${VIP} </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/dev/null</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ </span><span style="color:#005CC5;">$?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-eq</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ] ;</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">addr</span><span style="color:#24292E;"> </span><span style="color:#032F62;">del</span><span style="color:#24292E;"> \${VIP}</span><span style="color:#032F62;">/32</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> \${DEV} </span><span style="color:#D73A49;">&gt;</span><span style="color:#032F62;">/dev/null</span></span>
<span class="line"><span style="color:#24292E;">  rc</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">$?</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [ $rc </span><span style="color:#D73A49;">-ne</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ] ;</span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;fail to delete vip \${</span><span style="color:#24292E;">VIP</span><span style="color:#032F62;">} at dev \${</span><span style="color:#24292E;">DEV</span><span style="color:#032F62;">} rc=</span><span style="color:#24292E;">$rc</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">exit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;deleted vip \${</span><span style="color:#24292E;">VIP</span><span style="color:#032F62;">} at dev \${</span><span style="color:#24292E;">DEV</span><span style="color:#032F62;">}&quot;</span></span>
<span class="line"><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;vip not exists, skip delete vip&quot;</span></span>
<span class="line"><span style="color:#D73A49;">fi</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;loadvip start args:&#39;</span><span style="color:#005CC5;">$*</span><span style="color:#032F62;">&#39;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">case</span><span style="color:#24292E;"> $action </span><span style="color:#D73A49;">in</span></span>
<span class="line"><span style="color:#24292E;">  on_start|on_restart|on_role_change)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> $role </span><span style="color:#D73A49;">in</span></span>
<span class="line"><span style="color:#24292E;">      master)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">load_vip</span></span>
<span class="line"><span style="color:#24292E;">        ;;</span></span>
<span class="line"><span style="color:#24292E;">      replica)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">unload_vip</span></span>
<span class="line"><span style="color:#24292E;">        ;;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wrong role &#39;</span><span style="color:#24292E;">$role</span><span style="color:#032F62;">&#39;&quot;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">exit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">        ;;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">esac</span></span>
<span class="line"><span style="color:#24292E;">    ;;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">log</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;wrong action &#39;</span><span style="color:#24292E;">$action</span><span style="color:#032F62;">&#39;&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">exit</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    ;;</span></span>
<span class="line"><span style="color:#D73A49;">esac</span></span></code></pre></div><blockquote><p>所有节点都添加</p></blockquote><p>2、修改 <code>/etc/patroni.yml</code></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">postgresql</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#B392F0;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">callbacks</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">on_start</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/bin/bash /var/lib/postgresql/loadvip.sh</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">on_restart</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/bin/bash /var/lib/postgresql/loadvip.sh</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">on_role_change</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/bin/bash /var/lib/postgresql/loadvip.sh</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">postgresql</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#6F42C1;">...</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">callbacks</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">on_start</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/bin/bash /var/lib/postgresql/loadvip.sh</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">on_restart</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/bin/bash /var/lib/postgresql/loadvip.sh</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">on_role_change</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/bin/bash /var/lib/postgresql/loadvip.sh</span></span></code></pre></div><blockquote><p>所有节点都修改</p></blockquote><p>3、重载 Patroni 配置</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/patroni.yml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reload</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/patroni.yml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reload</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span></span></code></pre></div><blockquote><p>pgsql 表示集群名</p></blockquote><p>4、执行 switchover</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">postgres@ubt3:~/15$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patronictl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/patroni.yml</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span></span>
<span class="line"><span style="color:#B392F0;">Current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">topology</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) --+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+--------------+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Standby</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">streaming</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">streaming</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+--------------+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#B392F0;">Primary</span><span style="color:#E1E4E8;"> [pg2]:</span></span>
<span class="line"><span style="color:#B392F0;">Candidate</span><span style="color:#E1E4E8;"> [</span><span style="color:#9ECBFF;">&#39;pg1&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;pg3&#39;]</span><span style="color:#E1E4E8;"> []: pg1 </span><span style="color:#6A737D;"># Candidate 必须是 Standby</span></span>
<span class="line"><span style="color:#B392F0;">When</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">should</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">take</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">place</span><span style="color:#E1E4E8;"> (e.g. </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-19T15:16</span><span style="color:#E1E4E8;"> )  [now]: now</span></span>
<span class="line"><span style="color:#B392F0;">Are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sure</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">want</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switchover</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demoting</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">current</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">leader</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pg2?</span><span style="color:#E1E4E8;"> [y/N]: y</span></span>
<span class="line"><span style="color:#B392F0;">2023-10-19</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">14</span><span style="color:#9ECBFF;">:16:33.43225</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Successfully</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">switched</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">over</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;pg1&quot;</span></span>
<span class="line"><span style="color:#B392F0;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pgsql</span><span style="color:#E1E4E8;"> (7291209041344875305) ---------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Member</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Host</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Role</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">State</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">TL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Lag</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">MB</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg1</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.21</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Leader</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">running</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg2</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.22</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">stopped</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">   </span><span style="color:#B392F0;">unknown</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pg3</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">192.168.111.23</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Replica</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">streaming</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">8</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">         </span><span style="color:#B392F0;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#B392F0;">+--------+----------------+---------+-----------+----+-----------+</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">postgres@ubt3:~/15$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patronictl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/patroni.yml</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span></span>
<span class="line"><span style="color:#6F42C1;">Current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">topology</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) --+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+--------------+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Standby</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">streaming</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">streaming</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+--------------+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#6F42C1;">Primary</span><span style="color:#24292E;"> [pg2]:</span></span>
<span class="line"><span style="color:#6F42C1;">Candidate</span><span style="color:#24292E;"> [</span><span style="color:#032F62;">&#39;pg1&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;pg3&#39;]</span><span style="color:#24292E;"> []: pg1 </span><span style="color:#6A737D;"># Candidate 必须是 Standby</span></span>
<span class="line"><span style="color:#6F42C1;">When</span><span style="color:#24292E;"> </span><span style="color:#032F62;">should</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#032F62;">take</span><span style="color:#24292E;"> </span><span style="color:#032F62;">place</span><span style="color:#24292E;"> (e.g. </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-19T15:16</span><span style="color:#24292E;"> )  [now]: now</span></span>
<span class="line"><span style="color:#6F42C1;">Are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sure</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">want</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switchover</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demoting</span><span style="color:#24292E;"> </span><span style="color:#032F62;">current</span><span style="color:#24292E;"> </span><span style="color:#032F62;">leader</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pg2?</span><span style="color:#24292E;"> [y/N]: y</span></span>
<span class="line"><span style="color:#6F42C1;">2023-10-19</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">:16:33.43225</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Successfully</span><span style="color:#24292E;"> </span><span style="color:#032F62;">switched</span><span style="color:#24292E;"> </span><span style="color:#032F62;">over</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;pg1&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pgsql</span><span style="color:#24292E;"> (7291209041344875305) ---------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Member</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Host</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Role</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">State</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">TL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Lag</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">MB</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+-----------+----+-----------+</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg1</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.21</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Leader</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">running</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg2</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.22</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">stopped</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">   </span><span style="color:#6F42C1;">unknown</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pg3</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">192.168.111.23</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Replica</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">streaming</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">  </span><span style="color:#6F42C1;">8</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;">         </span><span style="color:#6F42C1;">0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#6F42C1;">+--------+----------------+---------+-----------+----+-----------+</span></span></code></pre></div><p>5、查看 VIP 漂移情况</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#B392F0;">tail</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/var/log/syslog</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 当前系统为 Ubuntu，其他系统日志文件名可能不太一样</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 指定只观察 patroni 的日志</span></span>
<span class="line"><span style="color:#B392F0;">journalctl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># root</span></span>
<span class="line"><span style="color:#6F42C1;">tail</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/var/log/syslog</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 当前系统为 Ubuntu，其他系统日志文件名可能不太一样</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 指定只观察 patroni 的日志</span></span>
<span class="line"><span style="color:#6F42C1;">journalctl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-u</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:24:42</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loadvip:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loadvip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">args:&#39;on_role_change master pgsql&#39;</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:24:42</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">patroni[</span><span style="color:#79B8FF;">10287</span><span style="color:#9ECBFF;">]:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2023</span><span style="color:#9ECBFF;">-10-19</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">14</span><span style="color:#9ECBFF;">:24:42.311</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">CST</span><span style="color:#E1E4E8;"> [10287] LOG:  selected new timeline ID: 10</span></span>
<span class="line"><span style="color:#B392F0;">Oct</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">19</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">06</span><span style="color:#9ECBFF;">:24:42</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">ubt1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">postgres:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">loadvip:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">added</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">vip</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">192.168</span><span style="color:#9ECBFF;">.111.30</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">dev</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">eth1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">19</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:24:42</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loadvip:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loadvip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">args:&#39;on_role_change master pgsql&#39;</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">19</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:24:42</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">patroni[</span><span style="color:#005CC5;">10287</span><span style="color:#032F62;">]:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2023</span><span style="color:#032F62;">-10-19</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">14</span><span style="color:#032F62;">:24:42.311</span><span style="color:#24292E;"> </span><span style="color:#032F62;">CST</span><span style="color:#24292E;"> [10287] LOG:  selected new timeline ID: 10</span></span>
<span class="line"><span style="color:#6F42C1;">Oct</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">19</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">06</span><span style="color:#032F62;">:24:42</span><span style="color:#24292E;"> </span><span style="color:#032F62;">ubt1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">postgres:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">loadvip:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">added</span><span style="color:#24292E;"> </span><span style="color:#032F62;">vip</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">192.168</span><span style="color:#032F62;">.111.30</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at</span><span style="color:#24292E;"> </span><span style="color:#032F62;">dev</span><span style="color:#24292E;"> </span><span style="color:#032F62;">eth1</span></span></code></pre></div><p>通过 Leader 节点的日志我们可以看到，在执行 switchover 之后，VIP 漂移到了Leader 节点。</p><p>…</p><hr><h4 id="keepalived-实现-vip-漂移" tabindex="-1"><a href="https://github.com/ChenHuajun/blog_xqhx/blob/main/2020/2020-09-07-%E5%9F%BA%E4%BA%8EPatroni%E7%9A%84PostgreSQL%E9%AB%98%E5%8F%AF%E7%94%A8%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2.md#73-vip%E9%80%9A%E8%BF%87keepalived%E5%AE%9E%E7%8E%B0vip%E6%BC%82%E7%A7%BB" target="_blank" rel="noreferrer">keepalived 实现 VIP 漂移</a> <a class="header-anchor" href="#keepalived-实现-vip-漂移" aria-label="Permalink to &quot;[keepalived 实现 VIP 漂移](https://github.com/ChenHuajun/blog_xqhx/blob/main/2020/2020-09-07-%E5%9F%BA%E4%BA%8EPatroni%E7%9A%84PostgreSQL%E9%AB%98%E5%8F%AF%E7%94%A8%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2.md#73-vip%E9%80%9A%E8%BF%87keepalived%E5%AE%9E%E7%8E%B0vip%E6%BC%82%E7%A7%BB)&quot;">​</a></h4><p>Patroni 提供了一系列 <a href="https://patroni.readthedocs.io/en/latest/rest_api.html" target="_blank" rel="noreferrer">REST API</a>，其中有可用于检查节点角色健康状态的 API。可使用 REST API 搭配 keepalived 动态的在主备库上绑定 VIP。</p><p>1、安装 keepalived</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-y</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keepalived</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-y</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keepalived</span></span></code></pre></div><p>2、编辑 keepalived 配置文件 <code>/etc/keepalived/keepalived.conf</code></p><blockquote><p>下面的例子表示备节点故障时则将只读 VIP 绑在主节点上。</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">global_defs {</span></span>
<span class="line"><span style="color:#e1e4e8;">    router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;">vrrp_script check_leader {</span></span>
<span class="line"><span style="color:#e1e4e8;">    script &quot;/usr/bin/curl -s http://127.0.0.1:8008/leader -v 2&gt;&amp;1|grep &#39;200 OK&#39; &gt;/dev/null&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    interval 2</span></span>
<span class="line"><span style="color:#e1e4e8;">    weight 10</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;">vrrp_script check_replica {</span></span>
<span class="line"><span style="color:#e1e4e8;">    script &quot;/usr/bin/curl -s http://127.0.0.1:8008/replica -v 2&gt;&amp;1|grep &#39;200 OK&#39; &gt;/dev/null&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    interval 2</span></span>
<span class="line"><span style="color:#e1e4e8;">    weight 5</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;">vrrp_script check_can_read {</span></span>
<span class="line"><span style="color:#e1e4e8;">    script &quot;/usr/bin/curl -s http://127.0.0.1:8008/read-only -v 2&gt;&amp;1|grep &#39;200 OK&#39; &gt;/dev/null&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    interval 2</span></span>
<span class="line"><span style="color:#e1e4e8;">    weight 10</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#e1e4e8;">    state BACKUP</span></span>
<span class="line"><span style="color:#e1e4e8;">    interface eth1</span></span>
<span class="line"><span style="color:#e1e4e8;">    virtual_router_id 21</span></span>
<span class="line"><span style="color:#e1e4e8;">    priority 100</span></span>
<span class="line"><span style="color:#e1e4e8;">    advert_int 1</span></span>
<span class="line"><span style="color:#e1e4e8;">    track_script {</span></span>
<span class="line"><span style="color:#e1e4e8;">        check_can_read</span></span>
<span class="line"><span style="color:#e1e4e8;">        check_replica</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#e1e4e8;">       192.168.111.31</span></span>
<span class="line"><span style="color:#e1e4e8;">    }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">global_defs {</span></span>
<span class="line"><span style="color:#24292e;">    router_id LVS_DEVEL</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;">vrrp_script check_leader {</span></span>
<span class="line"><span style="color:#24292e;">    script &quot;/usr/bin/curl -s http://127.0.0.1:8008/leader -v 2&gt;&amp;1|grep &#39;200 OK&#39; &gt;/dev/null&quot;</span></span>
<span class="line"><span style="color:#24292e;">    interval 2</span></span>
<span class="line"><span style="color:#24292e;">    weight 10</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;">vrrp_script check_replica {</span></span>
<span class="line"><span style="color:#24292e;">    script &quot;/usr/bin/curl -s http://127.0.0.1:8008/replica -v 2&gt;&amp;1|grep &#39;200 OK&#39; &gt;/dev/null&quot;</span></span>
<span class="line"><span style="color:#24292e;">    interval 2</span></span>
<span class="line"><span style="color:#24292e;">    weight 5</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;">vrrp_script check_can_read {</span></span>
<span class="line"><span style="color:#24292e;">    script &quot;/usr/bin/curl -s http://127.0.0.1:8008/read-only -v 2&gt;&amp;1|grep &#39;200 OK&#39; &gt;/dev/null&quot;</span></span>
<span class="line"><span style="color:#24292e;">    interval 2</span></span>
<span class="line"><span style="color:#24292e;">    weight 10</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#24292e;">    state BACKUP</span></span>
<span class="line"><span style="color:#24292e;">    interface eth1</span></span>
<span class="line"><span style="color:#24292e;">    virtual_router_id 21</span></span>
<span class="line"><span style="color:#24292e;">    priority 100</span></span>
<span class="line"><span style="color:#24292e;">    advert_int 1</span></span>
<span class="line"><span style="color:#24292e;">    track_script {</span></span>
<span class="line"><span style="color:#24292e;">        check_can_read</span></span>
<span class="line"><span style="color:#24292e;">        check_replica</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">    virtual_ipaddress {</span></span>
<span class="line"><span style="color:#24292e;">       192.168.111.31</span></span>
<span class="line"><span style="color:#24292e;">    }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><blockquote><p>有两个地方需要注意：</p><ul><li><code>interface</code> 绑定自己机器上的网卡接口</li><li><code>virtual_router_id</code> 虚拟路由 ID，最好在同一个子网下唯一</li><li><code>virtual_ipaddress</code> 绑定的 VIP</li></ul></blockquote><p>3、启动 keepalived</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果有必要，开机自启</span></span>
<span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keepalived</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 如果有必要，开机自启</span></span>
<span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keepalived</span></span></code></pre></div><p>…</p><blockquote><p>在网络抖动或其它临时故障时 keepalived 管理的 VIP 容易飘，更推荐使用 Patroni 回调脚本动态绑定读写 VIP。</p></blockquote><p>…</p><blockquote><p><strong>注意</strong></p><p><em>在实践过程中发现，一次 Leader 异常断网的期间 VIP 没能顺利漂移到 replica，但后续手动断网发现漂移正常。</em></p></blockquote><p>…</p><hr><h4 id="haproxy" tabindex="-1"><a href="https://github.com/ChenHuajun/blog_xqhx/blob/main/2020/2020-09-07-%E5%9F%BA%E4%BA%8EPatroni%E7%9A%84PostgreSQL%E9%AB%98%E5%8F%AF%E7%94%A8%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2.md#74-haproxy" target="_blank" rel="noreferrer">haproxy</a> <a class="header-anchor" href="#haproxy" aria-label="Permalink to &quot;[haproxy](https://github.com/ChenHuajun/blog_xqhx/blob/main/2020/2020-09-07-%E5%9F%BA%E4%BA%8EPatroni%E7%9A%84PostgreSQL%E9%AB%98%E5%8F%AF%E7%94%A8%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2.md#74-haproxy)&quot;">​</a></h4><p>haproxy 本身会占用一定的资源，且需要配合 keepalived 来使用。</p><p>…</p><hr><h3 id="rest-api" tabindex="-1">REST API <a class="header-anchor" href="#rest-api" aria-label="Permalink to &quot;REST API&quot;">​</a></h3><p>在 Patroni 配置中设置的 <a href="https://patroni.readthedocs.io/en/latest/rest_api.html" target="_blank" rel="noreferrer">REST API</a> 可以通过 <code>curl -s http://&lt;ip&gt;:&lt;port&gt;/patroni</code> 等接口来访问。</p><p>…</p><hr><h3 id="级联复制" tabindex="-1">级联复制 <a class="header-anchor" href="#级联复制" aria-label="Permalink to &quot;级联复制&quot;">​</a></h3><p>通常集群中所有的备库都从主库复制数据，但是特定的场景下我们可能需要部署级联复制。基于 Patroni 搭建的集群支持 2 种形式的级联复制。</p><ul><li>节点之间级联复制</li><li>集群之间级联复制</li></ul><p>…</p><h4 id="节点间级联复制" tabindex="-1">节点间级联复制 <a class="header-anchor" href="#节点间级联复制" aria-label="Permalink to &quot;节点间级联复制&quot;">​</a></h4><p>指定某个备库优先从指定成员而不是 Leader 节点复制数据</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">tags</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">replicatefrom</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">tags</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">replicatefrom</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg2</span></span></code></pre></div><blockquote><p><code>replicatefrom</code> 只对节点处于 Replica 角色时有效，并不影响该节点参与 Leader 选举。当 <code>replicatefrom</code> 指定的复制源节点故障时，Patroni 会自动切换到 Leader 节点进行复制。</p></blockquote><p>…</p><h4 id="集群间级联复制" tabindex="-1">集群间级联复制 <a class="header-anchor" href="#集群间级联复制" aria-label="Permalink to &quot;集群间级联复制&quot;">​</a></h4><p>还可以创建一个只读的备集群，从另一个指定的 PostgreSQL 实例复制数据。这可以用于创建跨数据中心的灾备集群。</p><p>1、初始创建一个备集群，可以在 Patroni 配置文件 <code>/etc/patroni.yml</code> 中加入以下配置</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">bootstrap</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">dcs</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">standby_cluster</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">192.168.111.30</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 上游复制源的主机号，可以使用 VIP 避免主集群主备切换时影响备集群</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 上游复制源的端口号</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">primary_slot_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">slot1</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 可选的</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">create_replica_methods</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#9ECBFF;">basebackup</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">bootstrap</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">dcs</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">standby_cluster</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.111.30</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 上游复制源的主机号，可以使用 VIP 避免主集群主备切换时影响备集群</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 上游复制源的端口号</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">primary_slot_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">slot1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 可选的</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">create_replica_methods</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#032F62;">basebackup</span></span></code></pre></div><p>如果配置了复制槽，需要同时在主集群上配置持久 slot。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">slots</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">slot1</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">physical</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">slots</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">slot1</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">physical</span></span></code></pre></div><p>对于已配置好的级联集群，可以使用 <code>patronictl edit-config</code> 命令动态修改 <code>standby_cluster</code></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">standby_cluster</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">192.168.111.21</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5432</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">primary_slot_name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">slot1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">create_replica_methods</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">basebackup</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">standby_cluster</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">192.168.111.21</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5432</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">primary_slot_name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">slot1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">create_replica_methods</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">basebackup</span></span></code></pre></div><p>添加 standby_cluster 将主机群变成备集群；删除 standby_cluster 将备集群变成主机群。</p><p>…</p><hr><h3 id="patroni-配置管理" tabindex="-1">Patroni 配置管理 <a class="header-anchor" href="#patroni-配置管理" aria-label="Permalink to &quot;Patroni 配置管理&quot;">​</a></h3><p>默认情况下 Patroni 管理的 PostgreSQL 配置是和数据目录在一起的</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">postgresql</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#B392F0;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">data_dir</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/lib/postgresql/15/main</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#config_dir: /etc/postgresql/15/main/ # defaults to the data directory</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">#custom_conf: /etc/postgresql/15/main/postgresql.custom.conf # 自定义配置文件</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">postgresql</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#6F42C1;">...</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">data_dir</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/lib/postgresql/15/main</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">#config_dir: /etc/postgresql/15/main/ # defaults to the data directory</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">#custom_conf: /etc/postgresql/15/main/postgresql.custom.conf # 自定义配置文件</span></span></code></pre></div><p>数据目录下的 <code>postgresql.conf</code> 配置文件会被 Patroni 重写，因此如果需要手动修改 PostgreSQL 配置可以编辑 <code>/var/lib/postgresql/15/main/postgrsql.base.conf</code>，<code>postgresql.conf</code> 引用了该文件。</p><p>当本地或者动态的修改 PostgreSQL 配置时，生效的情况如下：</p><ol><li><p>首先检查 <code>postgrsql.base.conf</code> 或者 custom_conf 有无配置；</p></li><li><p>如果配置了 custom_conf 且有值，Patroni 会忽略 <code>postgrsql.base.conf</code> 和 <code>postgrsql.conf</code>；</p></li><li><p>如果没有配置 custom_conf，但是 <code>postgrsql.base.conf</code> 存在且有值，则会使用 <code>postgrsql.base.conf</code> 中定义的配置；</p></li><li><p>如果 custom_conf 和 <code>postgrsql.base.conf</code> 都不存在则会使用 <code>postgrsql.conf</code>，并将 <code>postgrsql.conf</code> 重命名为 <code>postgrsql.base.conf</code>，原来的 base 会被作为备份。</p></li><li><p>动态设置的值会被直接添加到 <code>postgrsql.conf</code>，而且 <code>postgrsql.conf</code> 会包含 <code>postgrsql.base.conf</code> 和 custom_conf 指定的配置来作为基础值。</p></li></ol><p>…</p><hr><h3 id="总结-2" tabindex="-1">总结 <a class="header-anchor" href="#总结-2" aria-label="Permalink to &quot;总结&quot;">​</a></h3><table><thead><tr><th></th><th>Patroni</th><th>repmgr</th></tr></thead><tbody><tr><td>安装</td><td>较复杂，需要 pip 辅助安装，还需要安装额外的 etcd 工具管理集群数据</td><td>简单，直接 apt 从源安装</td></tr><tr><td>部署</td><td>简单，配置文件只需要小修改即可用于其他节点，启动 Patroni 自动加入集群</td><td>相对 Patroni 来说复杂点，配置小修改即可复用，但还是需要手动加入集群</td></tr><tr><td>故障转移</td><td>自动切换，无需干预，方便</td><td>需要配置 repmgrd，主节点恢复之后还需要人为 rejoin，相对 Patroni 复杂。</td></tr><tr><td>脑裂</td><td>两种办法来避免 watchdog 或者同步复制， 同步复制基本上可以达到目的</td><td>可以配置 witness 节点来预防双主产生，如果脑裂需要手动 pg_rewind，越早干预越好</td></tr><tr><td>…</td><td>…</td><td>…</td></tr></tbody></table><p>…</p><hr><h2 id="全量备份" tabindex="-1">全量备份 <a class="header-anchor" href="#全量备份" aria-label="Permalink to &quot;全量备份&quot;">​</a></h2><p>如果部署了一主一从一备库还不放心，可以再定期对数据库进行全量冷备份。</p><blockquote><p>在这里使用 K3s/K8s 中的定时任务来进行备份。</p></blockquote><p>1、使用 pg_basebackup 命令</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">pg_basebackup</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-U</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">repl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">source-db-i</span><span style="color:#E1E4E8;">p</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5432</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-F</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-X</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">stream</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-P</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-R</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-v</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/pgdata/dump/2023-11-02</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">pg_basebackup</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-U</span><span style="color:#24292E;"> </span><span style="color:#032F62;">repl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">source-db-i</span><span style="color:#24292E;">p</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5432</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-F</span><span style="color:#24292E;"> </span><span style="color:#032F62;">p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-X</span><span style="color:#24292E;"> </span><span style="color:#032F62;">stream</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-P</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-R</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-v</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/pgdata/dump/2023-11-02</span></span></code></pre></div><p>命令执行无误，下一步。</p><p>2、编写 CronJob</p><p>pg-secret</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Secret</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg-secret</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">test</span></span>
<span class="line"><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Opaque</span></span>
<span class="line"><span style="color:#85E89D;">data</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">pg-password</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cG9zdGdyZXM=</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 经过 base64 加密后的密码 postgres</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Secret</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg-secret</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">test</span></span>
<span class="line"><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Opaque</span></span>
<span class="line"><span style="color:#22863A;">data</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">pg-password</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cG9zdGdyZXM=</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 经过 base64 加密后的密码 postgres</span></span></code></pre></div><p>pg-backup</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">batch/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">CronJob</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg-backup</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">test</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">schedule</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;13 2 */5 * *&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># m h date-of-month month date-of-week</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">timeZone</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Asia/Shanghai&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">jobTemplate</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">restartPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">OnFailure</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg-backup</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">postgres:15.4</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">POSTGRES_PASSWORD</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">valueFrom</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#85E89D;">secretKeyRef</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg-secret</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">pg-password</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">/bin/sh</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#9ECBFF;">-c</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#F97583;">|</span></span>
<span class="line"><span style="color:#9ECBFF;">              current_date=$(date +&quot;%Y%m%d&quot;);</span></span>
<span class="line"><span style="color:#9ECBFF;">              echo &quot;$current_date backup started&quot;; </span></span>
<span class="line"><span style="color:#9ECBFF;">              mkdir -p /opt/pgdata;</span></span>
<span class="line"><span style="color:#9ECBFF;">              su postgres;</span></span>
<span class="line"><span style="color:#9ECBFF;">              pg_basebackup -U repl -h 192.168.2.200 -p 5432 -F p -X stream -P -R -v -D /opt/pgdata/$(date +&quot;%Y%m%d&quot;);</span></span>
<span class="line"><span style="color:#9ECBFF;">              if [ $? -eq 0 ]; then</span></span>
<span class="line"><span style="color:#9ECBFF;">                echo &quot;$current_date pg_basebackup backup succeed.&quot;;</span></span>
<span class="line"><span style="color:#9ECBFF;">                find /opt/pgdata -maxdepth 1 -mtime +10 -type d -exec rm -rf {} +;</span></span>
<span class="line"><span style="color:#9ECBFF;">              else</span></span>
<span class="line"><span style="color:#9ECBFF;">                echo &quot;$current_date pg_basebackup backup failed.&quot;</span></span>
<span class="line"><span style="color:#9ECBFF;">              fi</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dump-dir</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/opt/pgdata</span></span>
<span class="line"><span style="color:#E1E4E8;">            - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">localtime</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">readOnly</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/localtime</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dump-dir</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/opt/pgdata</span></span>
<span class="line"><span style="color:#E1E4E8;">          - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">localtime</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">File</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/etc/localtime</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">batch/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">CronJob</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg-backup</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">test</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">schedule</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;13 2 */5 * *&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># m h date-of-month month date-of-week</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">timeZone</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Asia/Shanghai&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">jobTemplate</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">restartPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">OnFailure</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg-backup</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">postgres:15.4</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">env</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">POSTGRES_PASSWORD</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">valueFrom</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#22863A;">secretKeyRef</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg-secret</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">pg-password</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">command</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">/bin/sh</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#032F62;">-c</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#D73A49;">|</span></span>
<span class="line"><span style="color:#032F62;">              current_date=$(date +&quot;%Y%m%d&quot;);</span></span>
<span class="line"><span style="color:#032F62;">              echo &quot;$current_date backup started&quot;; </span></span>
<span class="line"><span style="color:#032F62;">              mkdir -p /opt/pgdata;</span></span>
<span class="line"><span style="color:#032F62;">              su postgres;</span></span>
<span class="line"><span style="color:#032F62;">              pg_basebackup -U repl -h 192.168.2.200 -p 5432 -F p -X stream -P -R -v -D /opt/pgdata/$(date +&quot;%Y%m%d&quot;);</span></span>
<span class="line"><span style="color:#032F62;">              if [ $? -eq 0 ]; then</span></span>
<span class="line"><span style="color:#032F62;">                echo &quot;$current_date pg_basebackup backup succeed.&quot;;</span></span>
<span class="line"><span style="color:#032F62;">                find /opt/pgdata -maxdepth 1 -mtime +10 -type d -exec rm -rf {} +;</span></span>
<span class="line"><span style="color:#032F62;">              else</span></span>
<span class="line"><span style="color:#032F62;">                echo &quot;$current_date pg_basebackup backup failed.&quot;</span></span>
<span class="line"><span style="color:#032F62;">              fi</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dump-dir</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/opt/pgdata</span></span>
<span class="line"><span style="color:#24292E;">            - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">localtime</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">readOnly</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/localtime</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dump-dir</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/opt/pgdata</span></span>
<span class="line"><span style="color:#24292E;">          - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">localtime</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">File</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/etc/localtime</span></span></code></pre></div><blockquote><p>其中</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">find</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/opt/pgdata</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-maxdepth</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-mtime</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+10</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-type</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">d</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-exec</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rm</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-rf</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">{}</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">+</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">find</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/opt/pgdata</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-maxdepth</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-mtime</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+10</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-type</span><span style="color:#24292E;"> </span><span style="color:#032F62;">d</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-exec</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rm</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-rf</span><span style="color:#24292E;"> </span><span style="color:#032F62;">{}</span><span style="color:#24292E;"> </span><span style="color:#032F62;">+</span><span style="color:#24292E;">;</span></span></code></pre></div><p>表示删除 10 天前的备份</p></blockquote><p>…</p><p>99、备份完成后可以测试全量备份的数据是否正常</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 在备份的机器上操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 使用备份目录启动</span></span>
<span class="line"><span style="color:#B392F0;">pg_ctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/pgdata/full-dump/2023-11-02</span></span>
<span class="line"><span style="color:#6A737D;"># 检查启动状态</span></span>
<span class="line"><span style="color:#B392F0;">pg_ctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-D</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/pgdata/full-dump/2023-11-02</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 进入 postgresql 再使用 \\l 或者 \\dt 等命令查询数据，查看是否完整</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 在备份的机器上操作</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 使用备份目录启动</span></span>
<span class="line"><span style="color:#6F42C1;">pg_ctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/pgdata/full-dump/2023-11-02</span></span>
<span class="line"><span style="color:#6A737D;"># 检查启动状态</span></span>
<span class="line"><span style="color:#6F42C1;">pg_ctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-D</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/pgdata/full-dump/2023-11-02</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 进入 postgresql 再使用 \\l 或者 \\dt 等命令查询数据，查看是否完整</span></span></code></pre></div><p>…</p><blockquote><p>启动报错 <code>invalid value for parameter &quot;lc_monetary&quot;</code>：</p><p>编辑 postgresql.conf，注释 lc_messages、lc_monetary、lc_numeric、lc_time 字段。</p></blockquote><p>…</p><hr><h1 id="timescaledb" tabindex="-1">TimescaleDB <a class="header-anchor" href="#timescaledb" aria-label="Permalink to &quot;TimescaleDB&quot;">​</a></h1><blockquote><p>以 Ubuntu 为例，在已经安装了 PostgreSQL 的基础下安装 TimescaleDB。</p></blockquote><p>1、安装</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(</span><span style="color:#B392F0;">lsb_release</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-s</span><span style="color:#9ECBFF;">) main&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">tee</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/apt/sources.list.d/timescaledb.list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--quiet</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-O</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://packagecloud.io/timescale/timescaledb/gpgkey</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">add</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">-</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">update</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">timescaledb-2-postgresql-15</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;deb https://packagecloud.io/timescale/timescaledb/ubuntu/ $(</span><span style="color:#6F42C1;">lsb_release</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-c</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-s</span><span style="color:#032F62;">) main&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">tee</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/apt/sources.list.d/timescaledb.list</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--quiet</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-O</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://packagecloud.io/timescale/timescaledb/gpgkey</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">add</span><span style="color:#24292E;"> </span><span style="color:#032F62;">-</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">update</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">timescaledb-2-postgresql-15</span></span></code></pre></div><blockquote><p>If you want to install a specific version of TimescaleDB, you can specify the version like this</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">timescaledb-2-postgresql-12=&#39;2.6.0*&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">timescaledb-2-loader-postgresql-12=&#39;2.6.0*&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">timescaledb-2-postgresql-12=&#39;2.6.0*&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">timescaledb-2-loader-postgresql-12=&#39;2.6.0*&#39;</span></span></code></pre></div></blockquote><p>2、配置调整</p><p>2.1、手动调整 PostgreSQL 配置，以让 TimescaleDB 达到最佳运行状态</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">max_worker_processes = 21</span></span>
<span class="line"><span style="color:#e1e4e8;">shared_preload_libraries = &#39;pg_stat_statements,timescaledb&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">shared_buffers = 486001kB</span></span>
<span class="line"><span style="color:#e1e4e8;">effective_cache_size = 1423MB</span></span>
<span class="line"><span style="color:#e1e4e8;">maintenance_work_mem = 243000kB</span></span>
<span class="line"><span style="color:#e1e4e8;">work_mem = 9720kB</span></span>
<span class="line"><span style="color:#e1e4e8;">timescaledb.max_background_workers = 16</span></span>
<span class="line"><span style="color:#e1e4e8;">max_parallel_workers_per_gather = 1</span></span>
<span class="line"><span style="color:#e1e4e8;">max_parallel_workers = 2</span></span>
<span class="line"><span style="color:#e1e4e8;">wal_buffers = 14579kB</span></span>
<span class="line"><span style="color:#e1e4e8;">min_wal_size = 512MB</span></span>
<span class="line"><span style="color:#e1e4e8;">max_wal_size = 1GB</span></span>
<span class="line"><span style="color:#e1e4e8;">default_statistics_target = 500</span></span>
<span class="line"><span style="color:#e1e4e8;">random_page_cost = 1.1</span></span>
<span class="line"><span style="color:#e1e4e8;">checkpoint_completion_target = 0.9</span></span>
<span class="line"><span style="color:#e1e4e8;">autovacuum_max_workers = 10</span></span>
<span class="line"><span style="color:#e1e4e8;">autovacuum_naptime = 10</span></span>
<span class="line"><span style="color:#e1e4e8;">effective_io_concurrency = 256</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">max_worker_processes = 21</span></span>
<span class="line"><span style="color:#24292e;">shared_preload_libraries = &#39;pg_stat_statements,timescaledb&#39;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">shared_buffers = 486001kB</span></span>
<span class="line"><span style="color:#24292e;">effective_cache_size = 1423MB</span></span>
<span class="line"><span style="color:#24292e;">maintenance_work_mem = 243000kB</span></span>
<span class="line"><span style="color:#24292e;">work_mem = 9720kB</span></span>
<span class="line"><span style="color:#24292e;">timescaledb.max_background_workers = 16</span></span>
<span class="line"><span style="color:#24292e;">max_parallel_workers_per_gather = 1</span></span>
<span class="line"><span style="color:#24292e;">max_parallel_workers = 2</span></span>
<span class="line"><span style="color:#24292e;">wal_buffers = 14579kB</span></span>
<span class="line"><span style="color:#24292e;">min_wal_size = 512MB</span></span>
<span class="line"><span style="color:#24292e;">max_wal_size = 1GB</span></span>
<span class="line"><span style="color:#24292e;">default_statistics_target = 500</span></span>
<span class="line"><span style="color:#24292e;">random_page_cost = 1.1</span></span>
<span class="line"><span style="color:#24292e;">checkpoint_completion_target = 0.9</span></span>
<span class="line"><span style="color:#24292e;">autovacuum_max_workers = 10</span></span>
<span class="line"><span style="color:#24292e;">autovacuum_naptime = 10</span></span>
<span class="line"><span style="color:#24292e;">effective_io_concurrency = 256</span></span></code></pre></div><blockquote><p><a href="https://docs.timescale.com/self-hosted/latest/configuration/about-configuration/" target="_blank" rel="noreferrer">参考官方配置</a></p></blockquote><p>2.2、自动配置调整</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">timescaledb-tune</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-conf-path</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/your/config/path/postgresql.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">timescaledb-tune</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-conf-path</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/your/config/path/postgresql.conf</span></span></code></pre></div><p>…</p><blockquote><p><strong>注意</strong></p><p>如果使用了 Patroni 来管理 PostgreSQL 集群，配置文件默认在 data_dir 内</p><ul><li><code>/var/lib/postgresql/15/main/postgresql.conf</code></li></ul><p>但是该文件会被 Patroni 重写，可以编辑</p><ul><li><code>/var/lib/postgresql/15/main/postgresql.base.conf</code></li></ul></blockquote><p>3、查看安装情况</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# SELECT * FROM pg_available_extensions;</span></span>
<span class="line"><span style="color:#e1e4e8;">-- or</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# SELECT * FROM pg_available_extensions WHERE name like &#39;%timescaledb%&#39;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# SELECT * FROM pg_available_extensions;</span></span>
<span class="line"><span style="color:#24292e;">-- or</span></span>
<span class="line"><span style="color:#24292e;">postgres=# SELECT * FROM pg_available_extensions WHERE name like &#39;%timescaledb%&#39;;</span></span></code></pre></div><p>4、启用插件</p><div class="language-postgresql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">postgresql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">postgres=# CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# CREATE EXTENSION IF NOT EXISTS timescaledb_toolkit CASCADE;</span></span>
<span class="line"><span style="color:#e1e4e8;">-- 查看插件启用情况</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# \\x</span></span>
<span class="line"><span style="color:#e1e4e8;">Expanded display is on.</span></span>
<span class="line"><span style="color:#e1e4e8;">postgres=# \\dx</span></span>
<span class="line"><span style="color:#e1e4e8;">List of installed extensions</span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 1 ]--------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">Name        | plpgsql</span></span>
<span class="line"><span style="color:#e1e4e8;">Version     | 1.0</span></span>
<span class="line"><span style="color:#e1e4e8;">Schema      | pg_catalog</span></span>
<span class="line"><span style="color:#e1e4e8;">Description | PL/pgSQL procedural language</span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 2 ]--------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">Name        | timescaledb</span></span>
<span class="line"><span style="color:#e1e4e8;">Version     | 2.12.1</span></span>
<span class="line"><span style="color:#e1e4e8;">Schema      | public</span></span>
<span class="line"><span style="color:#e1e4e8;">Description | Enables scalable inserts and complex queries for time-series data (Community Edition)</span></span>
<span class="line"><span style="color:#e1e4e8;">-[ RECORD 3 ]--------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">Name        | timescaledb_toolkit</span></span>
<span class="line"><span style="color:#e1e4e8;">Version     | 1.17.0</span></span>
<span class="line"><span style="color:#e1e4e8;">Schema      | public</span></span>
<span class="line"><span style="color:#e1e4e8;">Description | Library of analytical hyperfunctions, time-series pipelining, and other SQL utilities</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">postgres=# CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;</span></span>
<span class="line"><span style="color:#24292e;">postgres=# CREATE EXTENSION IF NOT EXISTS timescaledb_toolkit CASCADE;</span></span>
<span class="line"><span style="color:#24292e;">-- 查看插件启用情况</span></span>
<span class="line"><span style="color:#24292e;">postgres=# \\x</span></span>
<span class="line"><span style="color:#24292e;">Expanded display is on.</span></span>
<span class="line"><span style="color:#24292e;">postgres=# \\dx</span></span>
<span class="line"><span style="color:#24292e;">List of installed extensions</span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 1 ]--------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">Name        | plpgsql</span></span>
<span class="line"><span style="color:#24292e;">Version     | 1.0</span></span>
<span class="line"><span style="color:#24292e;">Schema      | pg_catalog</span></span>
<span class="line"><span style="color:#24292e;">Description | PL/pgSQL procedural language</span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 2 ]--------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">Name        | timescaledb</span></span>
<span class="line"><span style="color:#24292e;">Version     | 2.12.1</span></span>
<span class="line"><span style="color:#24292e;">Schema      | public</span></span>
<span class="line"><span style="color:#24292e;">Description | Enables scalable inserts and complex queries for time-series data (Community Edition)</span></span>
<span class="line"><span style="color:#24292e;">-[ RECORD 3 ]--------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">Name        | timescaledb_toolkit</span></span>
<span class="line"><span style="color:#24292e;">Version     | 1.17.0</span></span>
<span class="line"><span style="color:#24292e;">Schema      | public</span></span>
<span class="line"><span style="color:#24292e;">Description | Library of analytical hyperfunctions, time-series pipelining, and other SQL utilities</span></span></code></pre></div><p>…</p><hr><br><h1 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h1><ul><li><a href="http://postgres.cn/docs" target="_blank" rel="noreferrer">http://postgres.cn/docs</a></li><li><a href="https://www.sjkjc.com/postgresql" target="_blank" rel="noreferrer">https://www.sjkjc.com/postgresql</a></li><li><a href="https://www.cnblogs.com/flying-tiger/p/6704931.html" target="_blank" rel="noreferrer">https://www.cnblogs.com/flying-tiger/p/6704931.html</a></li></ul><p><strong>数组类型对应</strong></p><ul><li><a href="https://access.crunchydata.com/documentation/pgjdbc/42.3.2/arrays.html" target="_blank" rel="noreferrer">https://access.crunchydata.com/documentation/pgjdbc/42.3.2/arrays.html</a></li></ul><p><strong>repmgr</strong></p><ul><li><a href="https://www.repmgr.org/docs/current/repmgr-administration-manual.html" target="_blank" rel="noreferrer">https://www.repmgr.org/docs/current/repmgr-administration-manual.html</a></li><li><a href="https://blog.frognew.com/2021/11/repmgr-postgresql-ha.html" target="_blank" rel="noreferrer">https://blog.frognew.com/2021/11/repmgr-postgresql-ha.html</a></li><li><a href="https://blog.51cto.com/u_10930585/5805207" target="_blank" rel="noreferrer">https://blog.51cto.com/u_10930585/5805207</a></li><li><a href="https://www.modb.pro/db/15359" target="_blank" rel="noreferrer">https://www.modb.pro/db/15359</a></li></ul><p><strong>etcd</strong></p><ul><li><a href="https://docs.openstack.org/install-guide/environment-etcd-ubuntu.html" target="_blank" rel="noreferrer">https://docs.openstack.org/install-guide/environment-etcd-ubuntu.html</a></li></ul><p><strong>Patroni</strong></p><ul><li><a href="https://github.com/ChenHuajun/blog_xqhx/tree/main/2020" target="_blank" rel="noreferrer">https://github.com/ChenHuajun/blog_xqhx/tree/main/2020</a></li><li><a href="https://patroni.readthedocs.io/en/latest/README.html#running-and-configuring" target="_blank" rel="noreferrer">https://patroni.readthedocs.io/en/latest/README.html#running-and-configuring</a></li><li>patroni 配置：<a href="https://github.com/zalando/patroni/tree/master" target="_blank" rel="noreferrer">https://github.com/zalando/patroni/tree/master</a></li></ul><p><strong>TimescaleDB</strong></p><ul><li><a href="https://docs.timescale.com/self-hosted/latest/install/installation-linux/" target="_blank" rel="noreferrer">https://docs.timescale.com/self-hosted/latest/install/installation-linux/</a></li><li><a href="https://severalnines.com/blog/how-enable-timescaledb-existing-postgresql-database/" target="_blank" rel="noreferrer">https://severalnines.com/blog/how-enable-timescaledb-existing-postgresql-database/</a></li></ul>`,586),u=[i,F,d];function C(g,h,B,m,b,q){return l(),p("div",null,u)}const D=a(E,[["render",C]]);export{A as __pageData,D as default};
